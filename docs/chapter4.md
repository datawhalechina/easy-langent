#  ç¬¬å››ç«  LangChainåº”ç”¨çº§ç³»ç»Ÿè®¾è®¡ä¸RAGå®è·µ

## å‰è¨€

ä»è¿™ä¸€ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°±è¦ä»LangChainçš„åŸºç¡€ç”¨æ³•æ­£å¼â€œå‡çº§æ‰“æ€ªâ€ï¼Œè¿›å…¥åº”ç”¨çº§ç³»ç»Ÿè®¾è®¡çš„é¢†åŸŸå•¦ï¼

å¦‚æœè¯´ä¹‹å‰çš„å­¦ä¹ æ˜¯åœ¨â€œè®¤è¯†é›¶ä»¶â€ï¼Œé‚£è¿™ä¸€ç« å°±æ˜¯æ•™å¤§å®¶å¦‚ä½•æŠŠè¿™äº›é›¶ä»¶ç»„è£…æˆèƒ½è§£å†³å®é™…é—®é¢˜çš„â€œæ™ºèƒ½æœºå™¨â€ã€‚

æ ¸å¿ƒé‡ç‚¹æ˜¯ä¸¤ä¸ªï¼šé“¾å¼å·¥ä½œæµï¼ˆæŠŠå¤æ‚ä»»åŠ¡æ‹†æˆæµæ°´çº¿ï¼‰å’ŒRAGï¼ˆç»™å¤§æ¨¡å‹è£…ä¸€ä¸ªâ€œå®æ—¶çŸ¥è¯†åº“â€ï¼‰ã€‚

å…¨ç¨‹æ­é…å®æ“ä»£ç ï¼Œè·Ÿç€æ•²å°±èƒ½ä¸Šæ‰‹ï¼Œè¿˜ä¼šç©¿æ’å¾ˆå¤šâ€œè¸©å‘æŒ‡å—â€ï¼Œè®©å¤§å®¶å°‘èµ°å¼¯è·¯ï½

## 4.1 é“¾å¼å·¥ä½œæµè®¾è®¡ï¼šå¤æ‚ä»»åŠ¡çš„æ‹†è§£ä¸æµè½¬

å…ˆé—®å¤§å®¶ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœè®©ä½ ç”¨å¤§æ¨¡å‹å®Œæˆâ€œä»ä¸€ç¯‡æ–°é—»ç¨¿ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œå†ç”Ÿæˆæ‘˜è¦ï¼Œæœ€åå†™æˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆâ€çš„ä»»åŠ¡ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿç›´æ¥ä¸¢ç»™å¤§æ¨¡å‹ä¸€å¥è¯è®©å®ƒæå®šï¼Ÿå¤§æ¦‚ç‡ä¼šå¾—åˆ°ä¸€ä¸ªä¸ä¼¦ä¸ç±»çš„ç»“æœâ€”â€”è¦ä¹ˆä¿¡æ¯æå–ä¸å…¨ï¼Œè¦ä¹ˆæ–‡æ¡ˆé£æ ¼ä¸å¯¹ã€‚

è¿™å°±åƒè®©ä¸€ä¸ªå¨å¸ˆåŒæ—¶å®Œæˆâ€œä¹°èœã€æ´—èœã€åšèœã€æ‘†ç›˜â€ï¼Œæ­¥éª¤è¶Šå¤šè¶Šå®¹æ˜“å‡ºé”™ã€‚

è€Œé“¾å¼å·¥ä½œæµï¼Œå°±æ˜¯æŠŠè¿™äº›å¤æ‚ä»»åŠ¡æ‹†æˆä¸€ä¸ªä¸ªå°æ­¥éª¤ï¼Œè®©å®ƒä»¬æŒ‰é¡ºåºï¼ˆæˆ–æŒ‰æ¡ä»¶ï¼‰ä¾æ¬¡æ‰§è¡Œï¼Œæœ€ç»ˆæ‹¿åˆ°æ»¡æ„ç»“æœã€‚

### 4.1.1 é“¾å¼å·¥ä½œæµæ ¸å¿ƒè®¤çŸ¥

#### 4.1.1.1 ä¸ºä»€ä¹ˆéœ€è¦ç»“æ„åŒ–é“¾å¼å·¥ä½œæµï¼Ÿ

å’±ä»¬å…ˆææ‡‚â€œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆæŠ˜è…¾â€ã€‚ç›´æ¥è°ƒç”¨å¤§æ¨¡å‹ä¸å¥½å—ï¼Ÿè¿˜çœŸä¸å¥½ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªç—›ç‚¹ï¼š

- **å¤æ‚ä»»åŠ¡holdä¸ä½**ï¼šå¤§æ¨¡å‹å¯¹å¤šæ­¥éª¤ä»»åŠ¡çš„é€»è¾‘è¿è´¯æ€§å¤„ç†å¾—ä¸å¥½ï¼Œæ¯”å¦‚è®©å®ƒåŒæ—¶åšâ€œæ•°æ®åˆ†æ+ç»“è®ºç”Ÿæˆ+æŠ¥å‘Šæ’°å†™â€ï¼Œå¾ˆå®¹æ˜“é—æ¼å…³é”®æ­¥éª¤ï¼›
- **è°ƒè¯•å’Œä¼˜åŒ–éš¾**ï¼šå¦‚æœç›´æ¥å‡ºé—®é¢˜äº†ï¼Œä½ æ ¹æœ¬ä¸çŸ¥é“æ˜¯å“ªä¸ªç¯èŠ‚é”™äº†ï¼Œå°±åƒæ‹†ç›²ç›’ä¸€æ ·ï¼›
- **çµæ´»æ€§å·®**ï¼šä¸åŒæ­¥éª¤å¯èƒ½éœ€è¦ä¸åŒçš„æ¨¡å‹æˆ–å·¥å…·ï¼ˆæ¯”å¦‚æå–ä¿¡æ¯ç”¨è½»é‡æ¨¡å‹ï¼Œå†™æ–‡æ¡ˆç”¨åˆ›æ„æ¨¡å‹ï¼‰ï¼Œç›´æ¥è°ƒç”¨æ— æ³•å®ç°â€œæ··æ­â€ã€‚

è€Œç»“æ„åŒ–é“¾å¼å·¥ä½œæµå°±è§£å†³äº†è¿™äº›é—®é¢˜ï¼šæŠŠå¤§ä»»åŠ¡æ‹†æˆå°æ­¥éª¤ï¼ˆæ¯ä¸ªæ­¥éª¤ä¸€ä¸ªâ€œç»„ä»¶â€ï¼‰ï¼Œæ¯ä¸ªç»„ä»¶ä¸“æ³¨åšä¸€ä»¶äº‹ï¼Œæ­¥éª¤ä¹‹é—´å¯ä»¥ä¼ é€’æ•°æ®ï¼Œå‡ºé—®é¢˜äº†èƒ½ç²¾å‡†å®šä½ï¼Œè¿˜èƒ½æ ¹æ®éœ€æ±‚çµæ´»æ›¿æ¢æŸä¸ªç¯èŠ‚çš„æ¨¡å‹æˆ–å·¥å…·ã€‚å°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œæ¯ä¸ªå·¥ä½åªè´Ÿè´£ä¸€é“å·¥åºï¼Œæœ€ç»ˆç»„è£…å‡ºåˆæ ¼äº§å“ã€‚

#### 4.1.1.2 å¸¸è§é“¾å¼å·¥ä½œæµç±»å‹ä¸é€‚ç”¨åœºæ™¯

LangChain 0.1.x ç‰ˆæœ¬åï¼Œå®˜æ–¹é‡æ„äº†æ ¸å¿ƒæ¶æ„ï¼Œ**æ—§ç‰ˆ SequentialChain/RouterChain/ParallelChain å·²æ ‡è®°ä¸ºé—ç•™ç»„ä»¶**ï¼Œæ¨èä½¿ç”¨åŸºäº `Runnables` çš„å…¨æ–°ç»„ä»¶å®ç°é“¾å¼å·¥ä½œæµã€‚

| ç»„ä»¶                           | æ ¸å¿ƒé€»è¾‘                                                 | é€‚ç”¨åœºæ™¯                                                     |
| ------------------------------ | -------------------------------------------------------- | ------------------------------------------------------------ |
| RunnableSequence / `|`         | `|` è¿ç®—ç¬¦ï¼ˆæ¨èï¼‰                                       | å¤šä¸ªç»„ä»¶æŒ‰å›ºå®šé¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªç»„ä»¶çš„è¾“å‡ºä½œä¸ºåä¸€ä¸ªç»„ä»¶çš„è¾“å…¥ |
| RunnableBranch                 | æ ¹æ®è¾“å…¥å†…å®¹æˆ–æ¡ä»¶è¿›è¡Œåˆ¤æ–­ï¼Œå°†è¯·æ±‚åŠ¨æ€åˆ†å‘åˆ°ä¸åŒå¤„ç†åˆ†æ”¯ | å¤šåœºæ™¯è·¯ç”±ä»»åŠ¡ï¼Œå¦‚æ™ºèƒ½å®¢æœï¼ˆè®¢å•é—®é¢˜ / å”®åé—®é¢˜ï¼‰ã€å¤šä¸»é¢˜é—®ç­”ï¼ˆå†å² / ç§‘æŠ€ / åŒ»ç–—ï¼‰ |
| RunnableParallel / RunnableMap | å¯¹åŒä¸€è¾“å…¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå­ç»„ä»¶ï¼Œæœ€ç»ˆè¿”å›ç»“æ„åŒ–ç»“æœï¼ˆdictï¼‰ | å¤šç»´åº¦åˆ†æä»»åŠ¡ï¼Œå¦‚ä»â€œæƒ…æ„Ÿã€é€»è¾‘ã€æ–‡é‡‡â€ç­‰å¤šä¸ªè§’åº¦è¯„ä»·åŒä¸€æ–‡æœ¬ |

>  å°æç¤ºï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRunnableSequenceï¼ˆçº¿æ€§æµè½¬ï¼‰ ä¸ RunnableBranchï¼ˆåŠ¨æ€è·¯ç”±ï¼‰ æ˜¯æœ€å¸¸ç”¨çš„ä¸¤ç§æ¨¡å¼ã€‚
>  æ–°ç‰ˆ Runnables ä½“ç³»çš„ä¼˜åŠ¿åœ¨äºï¼šç»„ä»¶æ›´è½»é‡ã€æ”¯æŒæµå¼ä¸å¼‚æ­¥æ‰§è¡Œã€å¯è‡ªç”±ç»„åˆåµŒå¥—ï¼Œæ›´é€‚åˆæ„å»ºå¤æ‚çš„åº”ç”¨çº§ AI ç³»ç»Ÿã€‚

### 4.1.2 åŸºäº RunnableSequence / `|` è¿ç®—ç¬¦

çº¿æ€§é“¾å°±åƒâ€œå¤šç±³è¯ºéª¨ç‰Œâ€ï¼Œä¸€ä¸ªå€’ä¸‹å¸¦åŠ¨ä¸‹ä¸€ä¸ªï¼Œæ ¸å¿ƒæ˜¯â€œé¡ºåºæ‰§è¡Œã€æ•°æ®æµè½¬â€ã€‚

å’±ä»¬ä»ç®€å•çš„å¼€å§‹ç»ƒæ‰‹ã€‚

#### 4.1.2.1 æ ¸å¿ƒåŸç†ï¼šRunnables çš„çº¿æ€§æµè½¬é€»è¾‘

æ ¸å¿ƒé€»è¾‘è¶…ç®€å•ï¼šæŠŠâ€œæç¤ºè¯æ¨¡æ¿ï¼ˆPromptTemplateï¼‰+ å¤§æ¨¡å‹ï¼ˆLLMï¼‰â€çœ‹ä½œä¸€ä¸ªä¸ªç‹¬ç«‹çš„ Runnable ç»„ä»¶ï¼Œç”¨ `|` è¿ç®—ç¬¦æŒ‰é¡ºåºä¸²è”ï¼Œç¬¬ä¸€ä¸ªç»„ä»¶çš„è¾“å‡ºè‡ªåŠ¨ä½œä¸ºç¬¬äºŒä¸ªç»„ä»¶çš„è¾“å…¥ï¼Œä»¥æ­¤ç±»æ¨ã€‚å°±åƒæ¥åŠ›èµ›ï¼Œæ¯ä¸ªè¿åŠ¨å‘˜è·‘å®Œè‡ªå·±çš„æ£’ï¼ŒæŠŠæ¥åŠ›æ£’äº¤ç»™ä¸‹ä¸€ä¸ªã€‚

ä¸¾ä¸ªä¾‹å­ï¼šâ€œæå–æ–°é—»å…³é”®ä¿¡æ¯â†’ç”Ÿæˆæ–°é—»æ‘˜è¦â€ã€‚ç¬¬ä¸€æ­¥ï¼ˆç»„ä»¶1ï¼‰ï¼šPromptTemplateï¼ˆæå–ä¿¡æ¯ï¼‰+ LLMï¼Œè¾“å…¥æ–°é—»åŸæ–‡ï¼Œè¾“å‡ºå…³é”®ä¿¡æ¯ï¼›ç¬¬äºŒæ­¥ï¼ˆç»„ä»¶2ï¼‰ï¼šPromptTemplateï¼ˆç”Ÿæˆæ‘˜è¦ï¼‰+ LLMï¼Œè¾“å…¥å…³é”®ä¿¡æ¯ï¼Œè¾“å‡ºæ–°é—»æ‘˜è¦ã€‚ç”¨ `|` ä¸²è”ä¸¤ä¸ªç»„ä»¶ï¼Œé¡ºåºæ‰§è¡Œå°±èƒ½æ‹¿åˆ°æœ€ç»ˆç»“æœã€‚

#### 4.1.2.2 åŸºç¡€å®è·µï¼šå•è¾“å…¥è¾“å‡ºçº¿æ€§æµè½¬

å…ˆåšä¸€ä¸ªç®€å•ä»»åŠ¡ï¼šç»™ä¸€æ®µäº§å“ä»‹ç»ï¼Œå…ˆæå–æ ¸å¿ƒå–ç‚¹ï¼Œå†æ ¹æ®å–ç‚¹å†™ä¸€æ®µè¥é”€è¯æœ¯ã€‚å’±ä»¬ä¸€æ­¥æ­¥æ¥ï¼Œå…ˆå‡†å¤‡ç¯å¢ƒï¼Œå†å†™ä»£ç ã€‚

ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡

ã€å‰ç½®å‡†å¤‡ã€‘æ‰€æœ‰æ¡ˆä¾‹éœ€å…ˆå®Œæˆç¯å¢ƒé…ç½®ï¼š

```bash
# å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆæ–°æ‰‹å¿…æ‰§è¡Œï¼‰
pip install langchain langchain-core langchain-openai python-dotenv
```

 **.env æ–‡ä»¶**ç¤ºä¾‹

```
 API_KEY=ä½ çš„deepseek-api-key
```

**ç¬¬äºŒæ­¥ï¼šç¼–å†™ä»£ç **

```python
# =========================
# 1. åŸºç¡€ä¾èµ–
# =========================
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.runnables import RunnableLambda
from dotenv import load_dotenv
import os

# =========================
# 2. ç¯å¢ƒå˜é‡ & æ¨¡å‹
# =========================
load_dotenv()

llm = ChatOpenAI(
    api_key=os.getenv("API_KEY"),
    base_url="https://api.deepseek.com",
    model="deepseek-chat",
    temperature=0.3
)

# =========================
# 3. ç»„ä»¶1ï¼šæå–æ ¸å¿ƒå–ç‚¹
# =========================
sell_point_prompt = PromptTemplate(
    input_variables=["product_intro"],
    template="è¯·ä»ä»¥ä¸‹äº§å“ä»‹ç»ä¸­æå–3ä¸ªæ ¸å¿ƒå–ç‚¹ï¼Œç”¨ç®€æ´çš„è¯­è¨€åˆ—å‡ºï¼š{product_intro}"
)

sell_point_chain = sell_point_prompt | llm

# =========================
# 4. ä¸­é—´ç»“æœç»“æ„åŒ–ï¼ˆLangChain é£æ ¼ï¼‰
# =========================
extract_sell_points = RunnableLambda(
    lambda msg: {"sell_points": msg.content}
)

# =========================
# 5. ç»„ä»¶2ï¼šç”Ÿæˆè¥é”€è¯æœ¯
# =========================
marketing_prompt = PromptTemplate(
    input_variables=["sell_points"],
    template="è¯·æ ¹æ®ä»¥ä¸‹äº§å“æ ¸å¿ƒå–ç‚¹ï¼Œå†™ä¸€æ®µå¸å¼•æ¶ˆè´¹è€…çš„è¥é”€è¯æœ¯ï¼ˆé€‚åˆæœ‹å‹åœˆå‘å¸ƒï¼‰ï¼š{sell_points}"
)

marketing_chain = marketing_prompt | llm

# =========================
# 6. çº¿æ€§ä¸²è”ï¼ˆSequential Runnableï¼‰
# =========================
overall_chain = (
    sell_point_chain
    | extract_sell_points
    | marketing_chain
)

# =========================
# 7. æ‰§è¡Œ
# =========================
product_intro = """è¿™æ¬¾æ— çº¿è€³æœºé‡‡ç”¨è“ç‰™5.3èŠ¯ç‰‡ï¼Œè¿æ¥ç¨³å®šæ— å»¶è¿Ÿï¼Œæ”¯æŒé«˜æ¸…é€šè¯ï¼›ç»­èˆªé•¿è¾¾30å°æ—¶ï¼Œå……ç”µ10åˆ†é’Ÿå¯ä½¿ç”¨2å°æ—¶ï¼›æœºèº«é‡‡ç”¨äº²è‚¤ç¡…èƒ¶æè´¨ï¼Œä½©æˆ´èˆ’é€‚ï¼Œé˜²æ°´é˜²æ±—ï¼Œé€‚åˆè¿åŠ¨ä½¿ç”¨ã€‚"""

result = overall_chain.invoke({"product_intro": product_intro})

print("\næœ€ç»ˆè¥é”€è¯æœ¯ï¼š")
print(result.content)

```

**ç¬¬ä¸‰æ­¥ï¼šä»£ç è§£é‡Šä¸è¿è¡Œç»“æœ**

- **ç»„ä»¶å°è£…**ï¼šç›´æ¥ç”¨ `PromptTemplate | llm` å°è£…æˆå¯æ‰§è¡Œç»„ä»¶ï¼Œç®€æ´é«˜æ•ˆï¼›
- **ä¸²è”æ–¹å¼**ï¼šä½¿ç”¨ `|` è¿ç®—ç¬¦ä¸²è”ç»„ä»¶ï¼Œç›´è§‚ä½“ç°â€œæµæ°´çº¿â€å¼çš„æ‰§è¡Œé€»è¾‘ï¼›
- **æ‰§è¡Œä¸è¾“å‡º**ï¼šç»Ÿä¸€ç”¨ `invoke()` æ–¹æ³•æ‰§è¡Œç»„ä»¶ï¼Œæ¨¡å‹è¾“å‡ºä¸º AIMessage å¯¹è±¡ï¼Œéœ€é€šè¿‡`.content` å±æ€§è·å–æ–‡æœ¬å†…å®¹ï¼›
- **æ•°æ®é€‚é…**ï¼šå¯é€šè¿‡ lambda å‡½æ•°è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆå¦‚å°† AIMessage è½¬ä¸ºå­—å…¸ï¼‰ï¼Œä¿éšœç»„ä»¶é—´æ•°æ®æµè½¬é¡ºç•…ã€‚

è¿è¡Œç»“æœç¤ºä¾‹ï¼š

```text
æœ€ç»ˆè¥é”€è¯æœ¯ï¼š ã€è¿åŠ¨æ–°å® ï½œå‘Šåˆ«å¡é¡¿ä¸ç”µé‡ç„¦è™‘ã€‘âœ¨

æˆ´ä¸Šå®ƒï¼Œä¸–ç•Œç¬é—´æ¸…æ™°ï¼
âœ… è“ç‰™5.3èŠ¯ç‰‡åŠ æŒï¼Œé€šè¯å¦‚é¢å¯¹é¢èˆ¬ç¨³å®šæµç•…ï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒè¿åŠ¨æ—¶é€šè¯æ–­æ–­ç»­ç»­ï½
âœ… ç‹‚é£™30å°æ—¶è¶…é•¿ç»­èˆªï¼Œå……ç”µ10åˆ†é’Ÿç•…å¬2å°æ—¶ï¼Œç”µé‡ç„¦è™‘ï¼Ÿä¸å­˜åœ¨çš„ï¼
âœ… äº²è‚¤ç¡…èƒ¶è½»ç›ˆè´´è€³ï¼Œç‹‚æ±—æš´é›¨ä¹Ÿä¸æ€•ï¼Œè¿åŠ¨æš´èµ°ä¸€æ•´å¤©ï¼Œèˆ’é€‚æ„Ÿä¾ç„¶åœ¨çº¿ï¼

ğŸƒâ€â™‚ï¸ğŸ’¦ æ— è®ºæ˜¯æ™¨è·‘ã€å¥èº«è¿˜æ˜¯é€šå‹¤ï¼Œè®©å®ƒæˆä¸ºä½ éšæ—¶åœ¨çº¿çš„â€œèˆ’é€‚èƒ½é‡è€³ä¼´â€ï¼
ğŸ‘‡ç‚¹å‡»ä½“éªŒï¼ŒæŠŠé«˜æ¸…ç•…å¬ä¸è‡ªç”±è¿åŠ¨è£…è¿›å£è¢‹ï½
```

> è¸©å‘æŒ‡å—ï¼š
>
> 1. è‹¥æç¤º API å¯†é’¥é”™è¯¯ï¼Œå…ˆæ£€æŸ¥ .env æ–‡ä»¶å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼Œå†ç”¨ `print(api_key)` éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦åŠ è½½æˆåŠŸï¼›
>
> 2. è‹¥æç¤ºâ€œè¾“å…¥å˜é‡ç¼ºå¤±â€ï¼Œæ£€æŸ¥ç»„ä»¶é—´æ•°æ®æ ¼å¼æ˜¯å¦åŒ¹é…ï¼ˆæ¯”å¦‚ç”¨ lambda å‡½æ•°è½¬æ¢ AIMessage ä¸ºå­—å…¸ï¼‰ï¼›
> 3. æ›¿æ¢å…¶ä»–å‚å•†æ¨¡å‹ï¼ˆå¦‚é€šä¹‰åƒé—®ã€æ–‡å¿ƒä¸€è¨€ï¼‰æ—¶ï¼Œåªéœ€ä¿®æ”¹`base_url` å’Œ `model` å‚æ•°ï¼Œæ ¸å¿ƒé€»è¾‘ä¸å˜ã€‚

#### 4.1.2.3 è¿›é˜¶å®è·µï¼šå¤šè¾“å…¥å¤šè¾“å‡ºå¤æ‚çº¿æ€§ä»»åŠ¡

åŸºç¡€å®è·µçš„ `|` ä¸²è”é€‚åˆå•è¾“å…¥å•è¾“å‡ºåœºæ™¯ï¼Œè‹¥ä»»åŠ¡æ›´å¤æ‚ï¼ˆæ¯”å¦‚â€œè¾“å…¥äº§å“ä»‹ç»å’Œç›®æ ‡äººç¾¤ï¼Œå…ˆæå–å–ç‚¹ï¼Œå†æ ¹æ®å–ç‚¹å’Œäººç¾¤å†™è¥é”€è¯æœ¯â€ï¼‰ï¼Œå°±éœ€è¦ç”¨åˆ° `RunnableSequence` ç»“åˆ `RunnablePassthrough` å®ç°å¤šè¾“å…¥å¤šè¾“å‡º

**ç¼–å†™ä»£ç **

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.runnables import RunnableMap, RunnablePassthrough
from dotenv import load_dotenv
import os

# 1. åˆå§‹åŒ–æ¨¡å‹
load_dotenv()
llm = ChatOpenAI(
    api_key=os.getenv("API_KEY"),
    base_url="https://api.deepseek.com/v1",
    model="deepseek-chat",
    temperature=0.3
)

# 2. Prompt å®šä¹‰
sell_point_prompt = PromptTemplate(
    input_variables=["product_intro"],
    template="ä»ä»¥ä¸‹äº§å“ä»‹ç»ä¸­æå–3ä¸ªæ ¸å¿ƒå–ç‚¹ï¼Œç®€æ´åˆ—å‡ºï¼š{product_intro}"
)

marketing_prompt = PromptTemplate(
    input_variables=["sell_points", "target_audience"],
    template="é’ˆå¯¹{target_audience}ï¼Œç»“åˆä»¥ä¸‹æ ¸å¿ƒå–ç‚¹ï¼Œå†™ä¸€æ®µæœ‹å‹åœˆè¥é”€è¯æœ¯ï¼š{sell_points}"
)

# 3. å¤šè¾“å…¥å¤šè¾“å‡ºçº¿æ€§é“¾ï¼ˆæ•™å­¦æ ‡å‡†ç‰ˆï¼‰
overall_chain = (
    # Step 1ï¼šç”Ÿæˆå–ç‚¹ + é€ä¼ åŸå§‹è¾“å…¥
    RunnableMap({
        "sell_points": sell_point_prompt | llm | (lambda x: x.content),
        "target_audience": RunnablePassthrough(),
    })
    # Step 2ï¼šè¥é”€è¯æœ¯ç”Ÿæˆ
    | marketing_prompt
    | llm
)

# 4. æ‰§è¡Œ
input_data = {
    "product_intro": "è¿™æ¬¾æ— çº¿è€³æœºé‡‡ç”¨è“ç‰™5.3èŠ¯ç‰‡ï¼Œè¿æ¥ç¨³å®šæ— å»¶è¿Ÿ...",
    "target_audience": "å¤§å­¦ç”Ÿç¾¤ä½“ï¼ˆå–œæ¬¢è¿åŠ¨ã€é¢„ç®—æœ‰é™ã€æ³¨é‡æ€§ä»·æ¯”ï¼‰"
}

result = overall_chain.invoke(input_data)

print("è¥é”€è¯æœ¯ï¼š")
print(result.content)
```

**ä»£ç è§£é‡Šä¸è¿è¡Œç»“æœ**

- `RunnableLambda` æ˜¯ LangChain ä¸­ç”¨äºå°†**ä»»æ„è‡ªå®šä¹‰å‡½æ•° / é€»è¾‘**åŒ…è£…æˆ `Runnable` æ¥å£çš„ç»„ä»¶ï¼Œè®©æ™®é€šå‡½æ•°å¯ä»¥æ— ç¼æ¥å…¥ LangChain çš„é“¾å¼è°ƒç”¨ä½“ç³»ä¸­ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå°±æ˜¯ã€Œæ™®é€šå‡½æ•°ã€å’Œã€ŒLangChain å¯è¿è¡Œç»„ä»¶ã€ä¹‹é—´çš„ã€Œé€‚é…å™¨ã€ã€‚
- `RunnableMap` æ˜¯ç”¨äº**å¹¶è¡Œæ‰§è¡Œå¤šä¸ª Runnable ç»„ä»¶**çš„å®¹å™¨ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå­—å…¸ï¼ˆkey ä¸ºè‡ªå®šä¹‰åç§°ï¼Œvalue ä¸º Runnable ç»„ä»¶ï¼‰ï¼Œæ‰§è¡Œæ—¶ä¼šå¹¶è¡Œè°ƒç”¨æ‰€æœ‰å­ç»„ä»¶ï¼Œå¹¶å°†æ¯ä¸ªç»„ä»¶çš„è¾“å‡ºä»¥ã€Œkey: è¾“å‡ºç»“æœã€çš„å½¢å¼æ±‡æ€»è¿”å›ã€‚
- `RunnablePassthrough` æ˜¯ä¸€ä¸ªã€Œé€ä¼ ç»„ä»¶ã€ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯**åŸæ ·ä¼ é€’è¾“å…¥æ•°æ®**ï¼ˆæˆ–åŸºäºè¾“å…¥ç”Ÿæˆæ–°æ•°æ®åé€ä¼ ï¼‰ï¼Œå¸¸ç”¨æ¥åœ¨é“¾å¼è°ƒç”¨ä¸­ä¿ç•™åŸå§‹è¾“å…¥ã€è¡¥å……æ•°æ®æˆ–è°ƒæ•´æ•°æ®ç»“æ„ã€‚

è¿è¡Œç»“æœç¤ºä¾‹ï¼š

```text
è¥é”€è¯æœ¯ï¼š
ã€è¿åŠ¨å…šå¿…å¤‡ï¼æ€§ä»·æ¯”é€†å¤©çš„è“ç‰™è€³æœºæ¥å•¦ï¼ã€‘ğŸ§

è·‘æ­¥æ€»è¢«è€³æœºçº¿ç¼ åˆ°å´©æºƒï¼Ÿå¥èº«æ—¶è€³æœºæ»‘è½ç¤¾æ­»ç°åœºï¼Ÿç”µè¯æ‰“åˆ°ä¸€åŠçªç„¶æ–­è¿ï¼Ÿâ€”â€”ä½ çš„è¿åŠ¨è€³æœºè¯¥å‡çº§äº†ï¼

âœ¨ è“ç‰™5.3èŠ¯ç‰‡åŠ æŒï¼Œè¿æ¥ç¨³å¦‚æ³°å±±ï¼æ“åœºç‹‚å¥”ã€çƒåœºæ¿€æˆ˜ï¼ŒéŸ³ä¹ä¸æ–­è¿ï¼Œé€šè¯æ¸…æ™°æ— å»¶è¿Ÿï¼Œå›¢æˆ˜å¼€é»‘å†ä¹Ÿä¸æ€•å‘é˜Ÿå‹ï¼

âš¡ ç»­èˆªç‹‚é­”ç™»åœºï¼30å°æ—¶è¶…é•¿ç»­èˆªï¼Œå›¾ä¹¦é¦†æ³¡ä¸€æ•´å¤©éƒ½ä¸ç”¨å……ç”µã€‚æ”¯æŒå¿«å……ï¼Œæ—©ä¸Šæ´—æ¼±æ—¶é—´å……10åˆ†é’Ÿï¼Œå°±èƒ½æ’‘å®Œä¸¤èŠ‚ä½“è‚²è¯¾+æ™šé—´å¤œè·‘ï¼

ğŸƒâ€â™‚ï¸ äº²è‚¤ç¡…èƒ¶è€³ç¿¼+IPX5é˜²æ°´ï¼Œç‹‚æ±—å¦‚é›¨ä¹Ÿä¸æ»‘è½ï¼è½»è‹¥æ— ç‰©çš„ä½©æˆ´æ„Ÿï¼Œè·³ç»³æ’¸é“æ¯«æ— è´Ÿæ‹…ï¼Œä¸‹é›¨å¤©æ™¨è·‘ç…§æ ·æˆ´ï½

å­¦ç”Ÿä»·ç›´æ¥æ‰“ç©¿åº•çº¿ï¼å°‘å–ä¸¤æ¯å¥¶èŒ¶ï¼Œå°±èƒ½æ‹¥æœ‰ä¸“ä¸šè¿åŠ¨è€³æœºï¼Œå®¿èˆå¼€é»‘/å›¾ä¹¦é¦†è‡ªä¹ /æ“åœºæš´æ±—å…¨é€‚é…ï¼

ğŸ‘‡ç‚¹å‡»ç«‹æŠ¢ä¸“å±å­¦ç”Ÿä¼˜æƒ ï¼Œè·‘èµ¢æ–°å­¦æœŸçš„ç¬¬ä¸€åœˆï¼
```

æ˜¯ä¸æ˜¯å‘ç°ï¼Œé’ˆå¯¹ç‰¹å®šäººç¾¤çš„è¯æœ¯æ›´ç²¾å‡†äº†ï¼Ÿ

è¿™å°±æ˜¯å¤šè¾“å…¥çº¿æ€§é“¾çš„ä»·å€¼â€”â€”èƒ½ç»“åˆå¤šä¸ªç»´åº¦çš„ä¿¡æ¯å®Œæˆä»»åŠ¡ã€‚

## 4.2 è·¯ç”±é“¾è®¾è®¡ä¸å¼‚å¸¸å¤„ç†ï¼šåŠ¨æ€ä»»åŠ¡åˆ†å‘ä¸ç³»ç»Ÿç¨³å¥æ€§

çº¿æ€§é“¾é€‚åˆâ€œæµç¨‹å›ºå®šâ€çš„ä»»åŠ¡ï¼Œä½†å¦‚æœé‡åˆ°â€œä¸€ä¸ªå…¥å£ã€å¤šä¸ªåœºæ™¯â€çš„æƒ…å†µå°±ä¸è¡Œäº†ã€‚æ¯”å¦‚æ™ºèƒ½å®¢æœï¼Œç”¨æˆ·å¯èƒ½é—®â€œæŸ¥è®¢å•â€â€œé€€è´§æ¬¾â€â€œé—®ä¿ä¿®â€ï¼Œä¸åŒé—®é¢˜éœ€è¦ä¸åŒçš„å¤„ç†æµç¨‹ã€‚è¿™æ—¶å€™å°±éœ€è¦è·¯ç”±é“¾â€”â€”å®ƒåƒä¸€ä¸ªâ€œæ™ºèƒ½åˆ†æµå‘˜â€ï¼Œå…ˆåˆ¤æ–­ç”¨æˆ·éœ€æ±‚ï¼Œå†æŠŠä»»åŠ¡åˆ†é…ç»™å¯¹åº”çš„å¤„ç†é“¾ã€‚

å¦å¤–ï¼Œä¸ç®¡æ˜¯çº¿æ€§é“¾è¿˜æ˜¯è·¯ç”±é“¾ï¼Œè¿è¡Œæ—¶éƒ½å¯èƒ½å‡ºé—®é¢˜ï¼ˆæ¯”å¦‚APIè°ƒç”¨å¤±è´¥ã€è¾“å…¥æ ¼å¼é”™è¯¯ï¼‰ï¼Œæ‰€ä»¥å¼‚å¸¸å¤„ç†ä¹Ÿå¾ˆé‡è¦ï¼Œèƒ½è®©ä½ çš„ç³»ç»Ÿâ€œä¸è½»æ˜“å´©æºƒâ€ã€‚

### 4.2.1 RouterChainï¼ˆè·¯ç”±é“¾ï¼‰æ ¸å¿ƒåŸç†

#### 4.2.1.1 åŸºäºæ¡ä»¶åˆ¤æ–­çš„åŠ¨æ€ä»»åŠ¡åˆ†å‘æœºåˆ¶

è·¯ç”±é“¾çš„æ ¸å¿ƒé€»è¾‘æ˜¯â€œåˆ¤æ–­+åˆ†å‘â€ï¼Œå°±åƒå­¦æ ¡çš„æ•™åŠ¡å¤„ï¼šå­¦ç”Ÿæ¥åŠäº‹ï¼Œå…ˆé—®æ¸…æ¥šâ€œä½ è¦åŠä»€ä¹ˆäº‹ï¼Ÿâ€ï¼ˆåˆ¤æ–­ï¼‰ï¼Œå†æŒ‡å¼•åˆ°å¯¹åº”çš„ç§‘å®¤ï¼ˆåˆ†å‘ï¼‰â€”â€”åŠæˆç»©è¯æ˜å»Aç§‘ï¼ŒåŠå­¦ç±å¼‚åŠ¨å»Bç§‘ã€‚

åœ¨æ–°ç‰ˆLangChainä¸­ï¼Œè·¯ç”±é“¾åŸºäºRunnableèŒƒå¼å®ç°ï¼Œæ ¸å¿ƒç»„æˆä»ä¸ºä¸‰éƒ¨åˆ†ï¼š

1. ç›®æ ‡é“¾ï¼šå¤šä¸ªå¤„ç†ä¸åŒåœºæ™¯çš„Runnableï¼ˆå¦‚æŸ¥è®¢å•é“¾ã€é€€è´§æ¬¾é“¾ï¼‰ï¼›
2. è·¯ç”±é€‰æ‹©å™¨ï¼šé€šè¿‡æ¡ä»¶åˆ¤æ–­æˆ–å¤§æ¨¡å‹ç†è§£ï¼ŒåŒ¹é…è¾“å…¥å¯¹åº”çš„ç›®æ ‡é“¾ï¼›
3. é»˜è®¤é“¾ï¼šè¾“å…¥æ— æ³•åŒ¹é…ä»»ä½•ç›®æ ‡é“¾æ—¶ï¼Œç”¨äºå…œåº•å¤„ç†çš„Runnableã€‚

#### 4.2.1.2 å…³é”®ç»„ä»¶ï¼šè·¯ç”±é€‰æ‹©å™¨å·¥ä½œæœºåˆ¶

è·¯ç”±é€‰æ‹©å™¨æ˜¯è·¯ç”±é“¾çš„â€œå¤§è„‘â€ï¼Œæ–°ç‰ˆLangChainæ¨èç”¨`RunnableBranch`å®ç°æ¡ä»¶è·¯ç”±ï¼Œæˆ–ç”¨å¤§æ¨¡å‹é©±åŠ¨çš„è·¯ç”±åˆ¤æ–­ã€‚å…¶æ ¸å¿ƒå·¥ä½œæµç¨‹ï¼š

1. æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼ˆé€šå¸¸æ˜¯åŒ…å«queryçš„å­—å…¸ï¼‰ï¼›
2. æ ¹æ®é¢„è®¾è§„åˆ™ï¼ˆç¡¬ç¼–ç æ¡ä»¶æˆ–å¤§æ¨¡å‹åˆ¤æ–­ï¼‰åŒ¹é…ç›®æ ‡é“¾ï¼›
3. å°†è¾“å…¥è½¬å‘è‡³åŒ¹é…çš„ç›®æ ‡é“¾æ‰§è¡Œï¼Œæ— åŒ¹é…åˆ™è§¦å‘é»˜è®¤é“¾ã€‚

æ–°ç‰ˆä¸­æœ€å¸¸ç”¨çš„æ˜¯â€œå¤§æ¨¡å‹+RunnableBranchâ€ç»„åˆï¼šåˆ©ç”¨å¤§æ¨¡å‹çš„è‡ªç„¶è¯­è¨€ç†è§£èƒ½åŠ›è§£æç”¨æˆ·éœ€æ±‚ï¼Œè¾“å‡ºæ ‡å‡†åŒ–æ ‡è¯†åï¼Œç”±RunnableBranchå®Œæˆåˆ†å‘ï¼Œæ— éœ€ç¼–å†™å¤æ‚çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘ã€‚

### 4.2.2 RouterChain å®è·µæ¡ˆä¾‹

#### 4.2.2.1 å¤šåœºæ™¯éœ€æ±‚çš„åŠ¨æ€è·¯ç”±åŒ¹é…ï¼ˆå¦‚å®¢æœå’¨è¯¢åˆ†ç±»å¤„ç†ï¼‰

æˆ‘ä»¬åšä¸€ä¸ªç®€å•çš„æ™ºèƒ½å®¢æœè·¯ç”±é“¾ï¼šé¢„è®¾ä¸‰ä¸ªåœºæ™¯ï¼ˆæŸ¥è®¢å•ã€é€€è´§æ¬¾ã€ä¿ä¿®æ”¿ç­–ï¼‰ï¼Œç”¨æˆ·è¾“å…¥é—®é¢˜åï¼Œè‡ªåŠ¨åˆ†å‘åˆ°å¯¹åº”çš„é“¾å¤„ç†ï¼Œæ— æ³•åŒ¹é…åˆ™ç”¨é»˜è®¤é“¾å›å¤ã€‚é‡‡ç”¨æ–°ç‰ˆLangChainå†™æ³•ï¼ˆåŸºäºRunnableèŒƒå¼ï¼Œä½¿ç”¨ChatOpenAIæ¨¡å‹ï¼‰ã€‚

**ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡**

å’Œä¹‹å‰ä¸€æ ·ï¼Œç¡®ä¿å®‰è£…äº†ä¾èµ–åŒ…å¹¶é…ç½®äº†APIå¯†é’¥ã€‚

**ç¬¬äºŒæ­¥ï¼šç¼–å†™ä»£ç **

```python
from dotenv import load_dotenv
from langchain_core.prompts import ChatPromptTemplate, PromptTemplate
from langchain_core.runnables import RunnableBranch, RunnableLambda, RunnableSequence
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI
import os

# 1. åŠ è½½ç¯å¢ƒå˜é‡ä¸åˆå§‹åŒ–æ¨¡å‹ï¼ˆæ–°ç‰ˆæ¨èç”¨ChatOpenAIï¼Œæ”¯æŒèŠå¤©æ¨¡å‹ï¼‰
load_dotenv()
llm = ChatOpenAI(
    api_key=os.getenv("API_KEY"),
    base_url="https://api.deepseek.com/v1",
    model="deepseek-chat",
    temperature=0.3
)

# 2. å®šä¹‰å„åœºæ™¯çš„æç¤ºè¯æ¨¡æ¿ä¸ç›®æ ‡é“¾ï¼ˆæ–°ç‰ˆç”¨RunnableSequenceç»„åˆPrompt+LLM+Parserï¼‰
# åœºæ™¯1ï¼šæŸ¥è®¢å•é“¾
order_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯æ™ºèƒ½å®¢æœï¼Œè´Ÿè´£è§£ç­”ç”¨æˆ·çš„è®¢å•æŸ¥è¯¢é—®é¢˜ã€‚"),
    ("human", "ç”¨æˆ·é—®é¢˜ï¼š{query}\nè¯·å¼•å¯¼ç”¨æˆ·æä¾›è®¢å•å·ï¼Œå¹¶å‘ŠçŸ¥æŸ¥è¯¢æµç¨‹ï¼š1. æä¾›è®¢å•å·ï¼›2. ç³»ç»ŸéªŒè¯ï¼›3. åé¦ˆè®¢å•çŠ¶æ€ã€‚")
])
order_chain = order_prompt | llm | StrOutputParser()  # æ–°ç‰ˆRunnableæµæ°´çº¿å†™æ³•

# åœºæ™¯2ï¼šé€€è´§æ¬¾é“¾
refund_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯æ™ºèƒ½å®¢æœï¼Œè´Ÿè´£è§£ç­”ç”¨æˆ·çš„é€€è´§æ¬¾é—®é¢˜ã€‚"),
    ("human", "ç”¨æˆ·é—®é¢˜ï¼š{query}\nè¯·è¯´æ˜é€€æ¬¾æµç¨‹ï¼š1. ç”³è¯·é€€æ¬¾ï¼ˆè®¢å•é¡µé¢ç‚¹å‡»é€€æ¬¾ï¼‰ï¼›2. ç­‰å¾…å®¡æ ¸ï¼ˆ1-3ä¸ªå·¥ä½œæ—¥ï¼‰ï¼›3. é€€æ¬¾åˆ°è´¦ï¼ˆåŸè·¯è¿”å›ï¼Œ3-5ä¸ªå·¥ä½œæ—¥ï¼‰ã€‚å¦‚æœç”¨æˆ·é—®é€€æ¬¾è¿›åº¦ï¼Œå¼•å¯¼æä¾›é€€æ¬¾ç”³è¯·å•å·ã€‚")
])
refund_chain = refund_prompt | llm | StrOutputParser()

# åœºæ™¯3ï¼šä¿ä¿®æ”¿ç­–é“¾
warranty_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯æ™ºèƒ½å®¢æœï¼Œè´Ÿè´£è§£ç­”äº§å“ä¿ä¿®æ”¿ç­–é—®é¢˜ã€‚"),
    ("human", "ç”¨æˆ·é—®é¢˜ï¼š{query}\nè¯·è¯´æ˜ä¿ä¿®æ”¿ç­–ï¼šæœ¬äº§å“ä¿ä¿®æœŸé™ä¸º1å¹´ï¼Œä¿ä¿®èŒƒå›´åŒ…æ‹¬è´¨é‡é—®é¢˜ï¼ˆéäººä¸ºæŸåï¼‰ï¼Œä¿ä¿®æµç¨‹ï¼š1. è”ç³»å®¢æœï¼›2. æä¾›è´­ä¹°å‡­è¯ï¼›3. å¯„å›æ£€æµ‹ç»´ä¿®ã€‚")
])
warranty_chain = warranty_prompt | llm | StrOutputParser()

# 3. å®šä¹‰è·¯ç”±åˆ¤æ–­é€»è¾‘ï¼ˆå¤§æ¨¡å‹è§£æéœ€æ±‚ï¼Œè¾“å‡ºåœºæ™¯æ ‡è¯†ï¼‰
# è·¯ç”±æç¤ºè¯ï¼šè®©å¤§æ¨¡å‹è¾“å‡ºæ ‡å‡†åŒ–çš„åœºæ™¯åç§°ï¼Œç”¨äºåç»­åˆ†æ”¯åŒ¹é…
router_prompt = ChatPromptTemplate.from_messages([
    ("system", """
ä½ æ˜¯è·¯ç”±é€‰æ‹©å™¨ï¼Œéœ€æ ¹æ®ç”¨æˆ·é—®é¢˜åˆ¤æ–­æ‰€å±åœºæ™¯ï¼Œä»…è¾“å‡ºä»¥ä¸‹æ ‡å‡†åŒ–æ ‡è¯†ä¹‹ä¸€ï¼š
- orderï¼šè®¢å•æŸ¥è¯¢ç›¸å…³ï¼ˆå«è®¢å•çŠ¶æ€ã€è®¢å•å·ï¼‰
- refundï¼šé€€è´§æ¬¾ç›¸å…³ï¼ˆå«é€€æ¬¾è¿›åº¦ã€é€€æ¬¾ç”³è¯·ï¼‰
- warrantyï¼šä¿ä¿®ç›¸å…³ï¼ˆå«ç»´ä¿®ã€å”®åä¿éšœï¼‰
- defaultï¼šä»¥ä¸Šå‡ä¸åŒ¹é…
æ— éœ€è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼Œä»…è¿”å›æ ‡è¯†å­—ç¬¦ä¸²ã€‚
"""),
    ("human", "ç”¨æˆ·é—®é¢˜ï¼š{query}")
])

# è·¯ç”±è§£æé“¾ï¼šè¾“å…¥queryï¼Œè¾“å‡ºåœºæ™¯æ ‡è¯†
router_chain = router_prompt | llm | StrOutputParser()

# 4. å®šä¹‰é»˜è®¤é“¾ï¼ˆå…œåº•å¤„ç†ï¼‰
default_prompt = PromptTemplate(
    input_variables=["query"],
    template="æŠ±æ­‰ï¼Œæˆ‘æ— æ³•è§£ç­”ä½ çš„é—®é¢˜'{query}'ã€‚è¯·ä½ é‡æ–°æè¿°é—®é¢˜ï¼Œæˆ–è€…è”ç³»äººå·¥å®¢æœï¼ˆå·¥ä½œæ—¶é—´ï¼š9:00-18:00ï¼‰ã€‚"
)
default_chain = default_prompt | llm | StrOutputParser()

# 5. æ„å»ºå®Œæ•´è·¯ç”±é“¾ï¼ˆæ ¸å¿ƒï¼šRunnableBranchå®ç°æ¡ä»¶åˆ†å‘ï¼‰
# é€»è¾‘ï¼šå…ˆé€šè¿‡router_chainè·å–åœºæ™¯æ ‡è¯†ï¼Œå†ç”±RunnableBranchåˆ†å‘åˆ°å¯¹åº”ç›®æ ‡é“¾
full_router_chain = RunnableLambda(lambda x: x) | (
    # åˆ†æ”¯1ï¼šåŒ¹é…orderåœºæ™¯
    RunnableBranch(
        (lambda x: x["scene"] == "order", order_chain),
        (lambda x: x["scene"] == "refund", refund_chain),
        (lambda x: x["scene"] == "warranty", warranty_chain),
        default_chain  # é»˜è®¤åˆ†æ”¯
    )
).with_config(run_name="full_router_chain")

# 6. å°è£…è°ƒç”¨å‡½æ•°ï¼ˆæ•´åˆåœºæ™¯è§£æä¸è·¯ç”±åˆ†å‘ï¼‰
def process_query(query: str):
    # ç¬¬ä¸€æ­¥ï¼šè·å–åœºæ™¯æ ‡è¯†
    scene = router_chain.invoke({"query": query})
    # ç¬¬äºŒæ­¥ï¼šå°†queryå’Œsceneä¼ å…¥å®Œæ•´è·¯ç”±é“¾ï¼Œæ‰§è¡Œåˆ†å‘å¤„ç†
    return full_router_chain.invoke({"query": query, "scene": scene})

# 7. æµ‹è¯•ä¸åŒåœºæ™¯è¾“å…¥
test_queries = [
    "æˆ‘çš„è®¢å•ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ",
    "æ€ä¹ˆç”³è¯·é€€æ¬¾å‘€ï¼Ÿ",
    "è¿™ä¸ªäº§å“ä¿ä¿®å¤šä¹…ï¼Ÿ",
    "ä½ ä»¬å®¶æœ‰ä»€ä¹ˆæ–°å“ï¼Ÿ"  # æ— æ³•åŒ¹é…ï¼Œè§¦å‘é»˜è®¤é“¾
]

for query in test_queries:
    print(f"\nç”¨æˆ·é—®é¢˜ï¼š{query}")
    print("å®¢æœå›å¤ï¼š", process_query(query))

```

**ä»£ç è§£é‡Šä¸è¿è¡Œç»“æœ**

æ–°ç‰ˆå†™æ³•æ ¸å¿ƒä¼˜åŠ¿ï¼šåŸºäºRunnableèŒƒå¼ï¼Œé€šè¿‡`|`ï¼ˆæµæ°´çº¿ï¼‰ç»„åˆç»„ä»¶ï¼Œé€»è¾‘æ›´æ¸…æ™°ï¼Œå¯æ‰©å±•æ€§æ›´å¼ºã€‚å…³é”®éƒ¨åˆ†è¯´æ˜ï¼š

1. ç›®æ ‡é“¾å®ç°ï¼šç”¨`ChatPromptTemplate | llm | StrOutputParser()`æµæ°´çº¿æ›¿ä»£æ—§ç‰ˆLLMChainï¼Œç®€æ´ä¸”ç¬¦åˆæ–°ç‰ˆè§„èŒƒï¼›
2. è·¯ç”±åˆ†å‘æ ¸å¿ƒï¼š`RunnableBranch`æ˜¯æ–°ç‰ˆæ¨èçš„æ¡ä»¶è·¯ç”±ç»„ä»¶ï¼Œé€šè¿‡â€œï¼ˆæ¡ä»¶åˆ¤æ–­å‡½æ•°ï¼Œå¯¹åº”é“¾ï¼‰â€çš„å…ƒç»„å®šä¹‰åˆ†æ”¯ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™åˆ†å‘é€»è¾‘ï¼›
3. çµæ´»æ€§æå‡ï¼šè·¯ç”±è§£æé“¾ä¸ä¸šåŠ¡å¤„ç†é“¾å®Œå…¨è§£è€¦ï¼Œåç»­æ–°å¢åœºæ™¯æ—¶ï¼Œåªéœ€æ–°å¢åˆ†æ”¯å’Œç›®æ ‡é“¾ï¼Œæ— éœ€ä¿®æ”¹æ•´ä½“æ¶æ„ã€‚

è¿è¡Œç»“æœç¤ºä¾‹ï¼š

```text
ç”¨æˆ·é—®é¢˜ï¼šæˆ‘çš„è®¢å•ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ
å®¢æœå›å¤ï¼š æ‚¨å¥½ï¼ä¸ºäº†å¸®æ‚¨æŸ¥è¯¢è®¢å•çš„å‘è´§æ—¶é—´ï¼Œè¯·æ‚¨æä¾›ä¸€ä¸‹è®¢å•å·ã€‚æŸ¥è¯¢æµç¨‹å¦‚ä¸‹ï¼š  
1. **æä¾›è®¢å•å·**ï¼šè¯·å‘ŠçŸ¥æ‚¨çš„è®¢å•å·ï¼ˆé€šå¸¸å¯åœ¨è®¢å•ç¡®è®¤é‚®ä»¶æˆ–è´¦æˆ·è®¢å•é¡µé¢æ‰¾åˆ°ï¼‰ã€‚
2. **ç³»ç»ŸéªŒè¯**ï¼šæˆ‘ä¼šæ ¹æ®è®¢å•å·æ ¸å®è®¢å•ä¿¡æ¯ã€‚
3. **åé¦ˆè®¢å•çŠ¶æ€**ï¼šéªŒè¯åï¼Œæˆ‘ä¼šä¸ºæ‚¨æä¾›å…·ä½“çš„å‘è´§è¿›åº¦æˆ–é¢„è®¡å‘è´§æ—¶é—´ã€‚

è¯·æä¾›è®¢å•å·ï¼Œæˆ‘ä¼šå°½å¿«ä¸ºæ‚¨å¤„ç†ï¼ ğŸ“¦

ç”¨æˆ·é—®é¢˜ï¼šæ€ä¹ˆç”³è¯·é€€æ¬¾å‘€ï¼Ÿ
å®¢æœå›å¤ï¼š æ‚¨å¥½ï¼Œç”³è¯·é€€æ¬¾çš„æ“ä½œå¾ˆç®€å•ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

1. **æäº¤ç”³è¯·**ï¼šè¯·æ‚¨è¿›å…¥ã€æˆ‘çš„è®¢å•ã€‘é¡µé¢ï¼Œæ‰¾åˆ°éœ€è¦é€€æ¬¾çš„è®¢å•ï¼Œç‚¹å‡»ã€ç”³è¯·é€€æ¬¾ã€‘æŒ‰é’®ï¼Œæ ¹æ®æç¤ºå¡«å†™é€€æ¬¾åŸå› å¹¶æäº¤ã€‚

2. **ç­‰å¾…å®¡æ ¸**ï¼šæäº¤åï¼Œæˆ‘ä»¬ä¼šåœ¨ **1-3ä¸ªå·¥ä½œæ—¥** å†…å®Œæˆå®¡æ ¸ï¼Œå®¡æ ¸ç»“æœä¼šé€šè¿‡çŸ­ä¿¡æˆ–ç«™å†…æ¶ˆæ¯é€šçŸ¥æ‚¨ã€‚

3. **é€€æ¬¾åˆ°è´¦**ï¼šå®¡æ ¸é€šè¿‡åï¼Œé€€æ¬¾ä¼šæŒ‰åŸæ”¯ä»˜è·¯å¾„è‡ªåŠ¨é€€å›ï¼Œä¸€èˆ¬ **3-5ä¸ªå·¥ä½œæ—¥** å†…åˆ°è´¦ï¼ˆå…·ä½“åˆ°è´¦æ—¶é—´ä»¥é“¶è¡Œæˆ–æ”¯ä»˜å¹³å°ä¸ºå‡†ï¼‰ã€‚

å¦‚æœæ‚¨å·²ç»æäº¤ç”³è¯·ï¼Œæƒ³æŸ¥è¯¢é€€æ¬¾è¿›åº¦ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘æ‚¨çš„ **é€€æ¬¾ç”³è¯·å•å·**ï¼Œæˆ‘ä¼šå¸®æ‚¨è·Ÿè¿›å¤„ç†ã€‚

ç”¨æˆ·é—®é¢˜ï¼šè¿™ä¸ªäº§å“ä¿ä¿®å¤šä¹…ï¼Ÿ
å®¢æœå›å¤ï¼š æœ¬äº§å“æä¾›**1å¹´ä¿ä¿®æœåŠ¡**ï¼Œå…·ä½“æ”¿ç­–å¦‚ä¸‹ï¼š  

**ä¿ä¿®èŒƒå›´**ï¼š
- äº§å“åœ¨æ­£å¸¸ä½¿ç”¨æƒ…å†µä¸‹å‡ºç°çš„**è´¨é‡é—®é¢˜**ï¼ˆéäººä¸ºæŸåï¼‰ã€‚

**ä¿ä¿®æµç¨‹**ï¼š
1. **è”ç³»å®¢æœ**ï¼šé€šè¿‡å®˜æ–¹æ¸ é“è”ç³»å®¢æœäººå‘˜ã€‚
2. **æä¾›å‡­è¯**ï¼šæä¾›æœ‰æ•ˆçš„è´­ä¹°å‡­è¯ï¼ˆå¦‚è®¢å•æˆªå›¾ã€å‘ç¥¨ç­‰ï¼‰ã€‚
3. **å¯„å›æ£€æµ‹**ï¼šæŒ‰å®¢æœæŒ‡å¼•å°†äº§å“å¯„å›æŒ‡å®šåœ°å€è¿›è¡Œæ£€æµ‹ä¸ç»´ä¿®ã€‚

å¦‚æœ‰å…¶ä»–ç–‘é—®ï¼Œå¯éšæ—¶å‘ŠçŸ¥ï¼Œæˆ‘ä¼šä¸ºæ‚¨è¿›ä¸€æ­¥è§£ç­”ï¼ ğŸ˜Š

ç”¨æˆ·é—®é¢˜ï¼šä½ ä»¬å®¶æœ‰ä»€ä¹ˆæ–°å“ï¼Ÿ
å®¢æœå›å¤ï¼š æ‚¨å¥½ï¼æˆ‘ç†è§£æ‚¨æƒ³äº†è§£æ–°å“ä¿¡æ¯ï¼Œä½†ä½œä¸ºAIåŠ©æ‰‹ï¼Œæˆ‘æ— æ³•è·å–å®æ—¶äº§å“ç›®å½•æˆ–åº“å­˜ä¿¡æ¯ã€‚ä¸è¿‡ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å‡ ç§å¿«é€Ÿè·å–ä¿¡æ¯çš„é€”å¾„ï¼š

1. **å®˜æ–¹æ¸ é“**
   ğŸ“± **å®˜ç½‘/å°ç¨‹åº**ï¼šè®¿é—®å“ç‰Œå®˜æ–¹ç½‘ç«™æˆ–å¾®ä¿¡å°ç¨‹åºï¼Œé€šå¸¸ä¼šæœ‰â€œæ–°å“æ¨èâ€æˆ–â€œæœ€æ–°ä¸Šå¸‚â€ä¸“æ ã€‚
   ğŸ“ **å®¢æœçƒ­çº¿**ï¼šç›´æ¥è‡´ç”µå®˜æ–¹å®¢æœï¼ˆå¦‚æ‚¨æåˆ°çš„å·¥ä½œæ—¶é—´9:00-18:00ï¼‰ï¼Œä»–ä»¬èƒ½æä¾›æœ€å‡†ç¡®çš„å®æ—¶ä¿¡æ¯ã€‚

2. **çº¿ä¸Šå¹³å°**
   ğŸ›’ **ç”µå•†æ——èˆ°åº—**ï¼šåœ¨æ·˜å®ã€äº¬ä¸œç­‰å¹³å°çš„å“ç‰Œæ——èˆ°åº—ä¸­ï¼Œæœç´¢â€œæ–°å“â€æˆ–æŒ‰â€œä¸Šæ–°æ—¶é—´â€ç­›é€‰å•†å“ã€‚

3. **å…¶ä»–å»ºè®®**
   âœ¨ **è®¢é˜…é€šçŸ¥**ï¼šè‹¥æ‚¨å·²æ³¨å†Œä¼šå‘˜ï¼Œå¯å…³æ³¨å“ç‰Œé‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥ï¼Œæ–°å“å¸¸ä¼šä¼˜å…ˆæ¨é€ã€‚
   ğŸ“ **çº¿ä¸‹é—¨åº—**ï¼šå¦‚æœ‰å®ä½“åº—ï¼Œå¯å’¨è¯¢åº—å‘˜è·å–æœ€æ–°åˆ°åº—äº§å“ä¿¡æ¯ã€‚

å¦‚æœæ‚¨éœ€è¦æˆ‘å¸®æ‚¨æŸ¥æ‰¾ç‰¹å®šå“ç±»çš„äº§å“ä¿¡æ¯ï¼ˆå¦‚ç”µå­äº§å“ã€ç¾å¦†ç­‰ï¼‰ï¼Œæˆ–æ•´ç†æ–°å“é€‰æ‹©çš„æ³¨æ„äº‹é¡¹ï¼Œæˆ‘å¾ˆä¹æ„æä¾›é€šç”¨å»ºè®®ï¼è¯·éšæ—¶å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚å“¦~ ğŸŒŸ
```

> å°æŠ€å·§ï¼šå°æŠ€å·§ï¼šè‹¥éœ€æå‡è·¯ç”±åˆ¤æ–­ç²¾åº¦ï¼Œå¯åœ¨router_promptä¸­å¢åŠ åœºæ™¯ç¤ºä¾‹ï¼ˆå¦‚â€œä¾‹ï¼šç”¨æˆ·é—®â€˜è®¢å•å·åœ¨å“ªæ‰¾â€™â†’è¾“å‡ºorderâ€ï¼‰ï¼Œæˆ–è°ƒæ•´æç¤ºè¯ï¼Œè¿›ä¸€æ­¥æå‡è‡ªç„¶è¯­è¨€ç†è§£èƒ½åŠ›ã€‚

### 4.2.3 é“¾å¼å·¥ä½œæµçš„é”™è¯¯å¤„ç†æœºåˆ¶

ä¸ç®¡æ˜¯çº¿æ€§é“¾è¿˜æ˜¯è·¯ç”±é“¾ï¼Œè¿è¡Œæ—¶éƒ½å¯èƒ½é‡åˆ°å„ç§â€œæ„å¤–â€ï¼šAPIè°ƒç”¨è¶…æ—¶ã€è¾“å…¥æ ¼å¼é”™è¯¯ã€å¤§æ¨¡å‹è¿”å›ç©ºç»“æœâ€¦â€¦æ–°ç‰ˆLangChainåŸºäºRunnableèŒƒå¼æä¾›äº†æ›´ä¼˜é›…çš„é”™è¯¯å¤„ç†æ–¹æ¡ˆï¼Œæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬`RunnableRetry`ï¼ˆé‡è¯•ï¼‰ã€`RunnableWithFallback`ï¼ˆé™çº§ï¼‰ï¼Œç»“åˆPythonåŸç”Ÿå¼‚å¸¸æ•è·ï¼Œæ„å»ºå®Œæ•´çš„â€œå®‰å…¨é˜²æŠ¤ç½‘â€ã€‚

#### 4.2.3.1 å¸¸è§é”™è¯¯ç±»å‹ä¸è§¦å‘åœºæ™¯

å…ˆææ¸…æ¥šé“¾å¼å·¥ä½œæµä¸­æœ€å®¹æ˜“é‡åˆ°çš„é”™è¯¯ï¼š

| é”™è¯¯ç±»å‹     | è§¦å‘åœºæ™¯                                                     | ç¤ºä¾‹                                                         |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| APIç›¸å…³é”™è¯¯  | APIå¯†é’¥é”™è¯¯ã€ç½‘ç»œä¸­æ–­ã€è°ƒç”¨é¢‘ç‡è¶…é™ã€æ¨¡å‹æœåŠ¡å®•æœº            | openai.AuthenticationErrorï¼ˆå¯†é’¥é”™è¯¯ï¼‰ã€requests.exceptions.ConnectionErrorï¼ˆç½‘ç»œä¸­æ–­ï¼‰ |
| è¾“å…¥æ ¼å¼é”™è¯¯ | è¾“å…¥ç¼ºå°‘å¿…è¦å˜é‡ã€æ ¼å¼ä¸ç¬¦åˆPromptè¦æ±‚ï¼ˆå¦‚éœ€å­—å…¸å´ä¼ å…¥å­—ç¬¦ä¸²ï¼‰ | MissingInputErrorï¼ˆç¼ºå°‘è¾“å…¥å˜é‡ï¼‰ã€ValueErrorï¼ˆè¾“å…¥æ ¼å¼é”™è¯¯ï¼‰ |
| è¾“å‡ºè§£æé”™è¯¯ | å¤§æ¨¡å‹è¿”å›ç»“æœä¸ç¬¦åˆè§£æå™¨è¦æ±‚ï¼ˆå¦‚éœ€å­—ç¬¦ä¸²å´è¿”å›ç©ºå€¼ï¼‰       | OutputParserExceptionï¼ˆè§£æå¤±è´¥ï¼‰                            |
| ä¸šåŠ¡é€»è¾‘é”™è¯¯ | è¾“å…¥å†…å®¹æ— æ³•è¢«ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆå¦‚æŸ¥è®¢å•æ—¶è¾“å…¥éæ•°å­—è®¢å•å·ï¼‰     | è®¢å•å·æ ¼å¼é”™è¯¯ã€æ— æ­¤è®¢å•è®°å½•                                 |

#### 4.2.3.2 å·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆï¼šé‡è¯•æœºåˆ¶ã€å¼‚å¸¸æ•è·ä¸åˆ†æ”¯é™çº§

é’ˆå¯¹ä¸Šè¿°é”™è¯¯ï¼Œç»“åˆæ–°ç‰ˆLangChainç»„ä»¶ï¼Œæä¾›ä¸‰ç§æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼š

**1. é‡è¯•æœºåˆ¶ï¼ˆè§£å†³ä¸´æ—¶APIé”™è¯¯ï¼‰**

å¯¹äºç½‘ç»œæ³¢åŠ¨ã€APIä¸´æ—¶ä¸å¯ç”¨ç­‰ä¸´æ—¶é”™è¯¯ï¼Œä½¿ç”¨`RunnableRetry`ç»„ä»¶è‡ªåŠ¨é‡è¯•ï¼Œæ”¯æŒè‡ªå®šä¹‰é‡è¯•æ¬¡æ•°ã€é—´éš”æ—¶é—´å’Œé‡è¯•æ¡ä»¶ã€‚

```python
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.exceptions import OutputParserException
from langchain_core.runnables import Runnable
import os
from langchain_openai import ChatOpenAI
from dotenv import load_dotenv

load_dotenv()
llm = ChatOpenAI(
    api_key=os.getenv("API_KEY"),
    base_url="https://api.deepseek.com/v1",
    model="deepseek-chat",
    temperature=0.3
)

# 1ï¸âƒ£ Prompt
summary_prompt = ChatPromptTemplate.from_messages([
    ("system", "è¯·ç®€æ´æ€»ç»“ä»¥ä¸‹æ–‡æœ¬æ ¸å¿ƒå†…å®¹ï¼Œä¸è¶…è¿‡50å­—ã€‚"),
    ("human", "{text}")
])

# 2ï¸âƒ£ åŸºç¡€é“¾
base_chain: Runnable = summary_prompt | llm | StrOutputParser()

# 3ï¸âƒ£ é‡è¯•é“¾ï¼ˆå®˜æ–¹æ¨èï¼šç›´æ¥ with_retryï¼‰
retry_chain = base_chain.with_retry(
    stop_after_attempt=3,          # æœ€å¤šé‡è¯• 3 æ¬¡
    wait_exponential_jitter=True,  # æŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼ˆæ¨èï¼‰
    retry_if_exception_type=(
        ConnectionError,
        TimeoutError,
    ),
)

# 4ï¸âƒ£ è°ƒç”¨
try:
    result = retry_chain.invoke({
        "text": "LangChainæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¤§æ¨¡å‹åº”ç”¨çš„æ¡†æ¶ï¼Œæä¾›äº†ä¸°å¯Œçš„Runnableç»„ä»¶ï¼Œæ”¯æŒé‡è¯•ã€é™çº§ç­‰å·¥ç¨‹åŒ–èƒ½åŠ›ã€‚"
    })
    print("æ€»ç»“ç»“æœï¼š", result)

except OutputParserException as e:
    # â— è§£æé”™è¯¯é€šå¸¸æ˜¯é€»è¾‘é—®é¢˜ï¼Œä¸å»ºè®®é‡è¯•
    print("è¾“å‡ºè§£æå¤±è´¥ï¼š", e)

except Exception as e:
    print("æœ€ç»ˆå¤±è´¥ï¼ˆå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰ï¼š", e)

```

> ä»£ç è§£é‡Šï¼š`with_retry`æ˜¯æ–°ç‰ˆRunnableçš„å†…ç½®æ–¹æ³•ï¼Œé€šè¿‡`RunnableRetry`é…ç½®é‡è¯•è§„åˆ™ï¼Œç›¸æ¯”æ—§ç‰ˆ`RetryWithErrorOutputChain`æ›´çµæ´»ï¼Œå¯ç²¾å‡†æ§åˆ¶é‡è¯•èŒƒå›´ï¼ˆå¦‚ä»…å¯¹ä¸´æ—¶APIé”™è¯¯é‡è¯•ï¼Œé¿å…æ— æ•ˆé‡è¯•ï¼‰ã€‚

**2. å¼‚å¸¸æ•è·ï¼ˆè§£å†³å¯é¢„çŸ¥çš„é”™è¯¯ï¼‰**

å¯¹äºè¾“å…¥æ ¼å¼é”™è¯¯ã€è§£æé”™è¯¯ç­‰å¯é¢„çŸ¥é—®é¢˜ï¼Œç»“åˆPythonåŸç”Ÿ`try-except`å’ŒLangChainå¼‚å¸¸ç±»å‹ï¼Œæ•è·é”™è¯¯åè¿”å›å‹å¥½æç¤ºã€‚

```python
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.exceptions import MissingInputError, OutputParserException
from langchain_core.runnables import Runnable

# 1ï¸âƒ£ å®šä¹‰å¤šå˜é‡ Prompt é“¾ï¼ˆè¥é”€è¯æœ¯ç”Ÿæˆç¤ºä¾‹ï¼‰
marketing_prompt = ChatPromptTemplate.from_messages([
    ("system", "æ ¹æ®äº§å“å–ç‚¹å’Œç›®æ ‡äººç¾¤ï¼Œæ’°å†™ä¸€å¥è¥é”€è¯æœ¯ã€‚"),
    ("human", "äº§å“å–ç‚¹ï¼š{sell_points}ï¼Œç›®æ ‡äººç¾¤ï¼š{target_audience}")
])

# 2ï¸âƒ£ æ„å»ºé“¾
marketing_chain: Runnable = marketing_prompt | llm | StrOutputParser()

# 3ï¸âƒ£ è°ƒç”¨å¹¶æ•è·å¼‚å¸¸ï¼ˆå®˜æ–¹æ¨èé£æ ¼ï¼‰
inputs = {
    "sell_points": "æ— çº¿è€³æœºç»­èˆª30å°æ—¶",
    # "target_audience" æ•…æ„ç¼ºå¤±ï¼Œç”¨äºæ¼”ç¤º MissingInputError
}

try:
    result = marketing_chain.invoke(inputs)
    print("è¥é”€è¯æœ¯ï¼š", result)

except MissingInputError as e:
    # âœ… å®˜æ–¹æ¨èï¼šç²¾å‡†æç¤ºç¼ºå¤±å˜é‡
    missing_keys = ", ".join(e.missing_keys)
    print(f"é”™è¯¯æç¤ºï¼šç¼ºå°‘å¿…è¦è¾“å…¥å˜é‡ [{missing_keys}]ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®ã€‚")

except OutputParserException as e:
    # âœ… å®˜æ–¹æ¨èï¼šé€»è¾‘è§£æé”™è¯¯ä¸é‡è¯•
    print(f"è§£æå¤±è´¥ï¼š{e}ï¼Œè¯·ç¡®è®¤ Prompt ä¸è¾“å‡ºæ ¼å¼åŒ¹é…ã€‚")

except Exception as e:
    # â— å…œåº•æ•è·æœªçŸ¥å¼‚å¸¸
    print(f"æœªçŸ¥é”™è¯¯ï¼š{e}ï¼Œè¯·è”ç³»å¼€å‘è€…æ’æŸ¥ã€‚")

```

è¿è¡Œç»“æœï¼š`é”™è¯¯æç¤ºï¼šç¼ºå°‘å¿…è¦è¾“å…¥å˜é‡ 'target_audience'ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®æ˜¯å¦å®Œæ•´ã€‚`

>  ä¼˜åŠ¿ï¼šæ–°ç‰ˆLangChainå®šä¹‰äº†æ˜ç¡®çš„å¼‚å¸¸ç±»å‹ï¼ˆå¦‚`MissingInputError`ã€`OutputParserException`ï¼‰ï¼Œå¯ç²¾å‡†æ•è·ç‰¹å®šé”™è¯¯ï¼Œé¿å…â€œä¸€åˆ€åˆ‡â€çš„å¼‚å¸¸å¤„ç†ï¼Œä¾¿äºè°ƒè¯•å’Œç”¨æˆ·ç†è§£ã€‚

**3. åˆ†æ”¯é™çº§ï¼ˆé”™è¯¯æ—¶åˆ‡æ¢å¤‡ç”¨æ–¹æ¡ˆï¼‰**

æ ¸å¿ƒé“¾å¤±è´¥æ—¶ï¼Œä½¿ç”¨`RunnableWithFallback`è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨é“¾ï¼ˆå¦‚å°æ¨¡å‹ã€é¢„è®¾æ¨¡æ¿ï¼‰ï¼Œä¿è¯ç³»ç»Ÿå¯ç”¨æ€§ã€‚ç›¸æ¯”æ—§ç‰ˆè‡ªå®šä¹‰å‡½æ•°ï¼Œæ–°ç‰ˆå†™æ³•æ›´ç®€æ´ã€å¯å¤ç”¨ã€‚

```python
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnableWithFallback
from langchain_openai import ChatOpenAI
from langchain_core.exceptions import OutputParserException
import time

# 1ï¸âƒ£ æ ¸å¿ƒé“¾ï¼ˆæ€§èƒ½é«˜ä½†å¯èƒ½ä¸ç¨³å®šï¼‰
core_llm = ChatOpenAI(api_key=api_key, model_name="gpt-4", temperature=0.7)
core_prompt = ChatPromptTemplate.from_messages([
    ("system", "ç”¨ä¸“ä¸šè¯­è¨€è¯¦ç»†è§£ç­”ç”¨æˆ·é—®é¢˜ã€‚"),
    ("human", "{query}")
])
core_chain = core_prompt | core_llm | StrOutputParser()

# 2ï¸âƒ£ é™çº§é“¾ï¼ˆç¨³å®šä½†ç²¾åº¦ç•¥ä½ï¼‰
fallback_llm = ChatOpenAI(api_key=api_key, model_name="gpt-3.5-turbo", temperature=0.5)
fallback_prompt = ChatPromptTemplate.from_messages([
    ("system", "ç”¨ç®€æ´è¯­è¨€è§£ç­”ç”¨æˆ·é—®é¢˜ï¼Œä¿è¯ä¿¡æ¯å‡†ç¡®ã€‚"),
    ("human", "{query}")
])
fallback_chain = fallback_prompt | fallback_llm | StrOutputParser()

# 3ï¸âƒ£ æ„å»ºå¸¦é™çº§çš„é“¾
chain_with_fallback: RunnableWithFallback = core_chain.with_fallback(
    fallback=fallback_chain,
    exceptions=(ConnectionError, TimeoutError),  # âœ… å®˜æ–¹æ¨èï¼šåªæ•è·ä¸´æ—¶é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯
)

# 4ï¸âƒ£ è°ƒç”¨é“¾å¹¶æ•è·å¼‚å¸¸
try:
    result = chain_with_fallback.invoke({"query": "ä»€ä¹ˆæ˜¯RAGæŠ€æœ¯ï¼Ÿ"})
    print("è§£ç­”ï¼š", result)

except OutputParserException as e:
    # âŒ è§£æå¤±è´¥ä¸€èˆ¬ä¸è§¦å‘é™çº§
    print(f"è§£æå¤±è´¥ï¼š{e}ï¼Œè¯·ç¡®è®¤ Prompt ä¸è¾“å‡ºæ ¼å¼åŒ¹é…ã€‚")

except Exception as e:
    # â— å…œåº•æœªçŸ¥å¼‚å¸¸
    print(f"æœ€ç»ˆå¤±è´¥ï¼ˆé™çº§åä»å¤±è´¥ï¼‰ï¼š{e}")

```

ä»£ç è§£é‡Šï¼šå¦‚æœæ ¸å¿ƒé“¾ï¼ˆgpt-4ï¼‰å› ä¸ºAPIé”™è¯¯ã€è¶…æ—¶è€Œå¤±è´¥ï¼Œå°±ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é™çº§é“¾ï¼ˆgpt-3.5-turbo-instructï¼‰ï¼Œä¿è¯ç”¨æˆ·èƒ½å¾—åˆ°è§£ç­”ï¼Œåªæ˜¯å¯èƒ½åœ¨å›ç­”è´¨é‡ä¸Šç•¥æœ‰å·®å¼‚ã€‚è¿™åœ¨å·¥ç¨‹å®è·µä¸­éå¸¸é‡è¦ï¼Œèƒ½æå¤§æå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚

> è¸©å‘æŒ‡å—ï¼šå¼‚å¸¸æ•è·è¦ç²¾å‡†ï¼Œä¸è¦ç”¨â€œexcept Exceptionâ€æ•è·æ‰€æœ‰é”™è¯¯ï¼Œå°½é‡å…ˆæ•è·å…·ä½“çš„é”™è¯¯ç±»å‹ï¼ˆæ¯”å¦‚KeyErrorã€AuthenticationErrorï¼‰ï¼Œå†ç”¨é€šç”¨å¼‚å¸¸æ•è·æœªçŸ¥é”™è¯¯ï¼Œè¿™æ ·æ–¹ä¾¿åç»­è°ƒè¯•ã€‚

## 4.3 RAG æ ¸å¿ƒåŸç†ä¸åº”ç”¨ä»·å€¼

è®²å®Œäº†é“¾å¼å·¥ä½œæµï¼Œæˆ‘ä»¬æ¥å­¦ä¹ æœ¬ç« çš„å¦ä¸€ä¸ªæ ¸å¿ƒâ€”â€”RAGã€‚

å¦‚æœè¯´é“¾å¼å·¥ä½œæµæ˜¯â€œè®©å¤§æ¨¡å‹æŒ‰æ­¥éª¤åšäº‹â€ï¼Œé‚£RAGå°±æ˜¯â€œè®©å¤§æ¨¡å‹æœ‰ä¸œè¥¿å¯ä¾â€ã€‚

ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼šé—®å¤§æ¨¡å‹â€œæˆ‘ä»¬å…¬å¸2025å¹´çš„äº§å“è§„åˆ’æ˜¯ä»€ä¹ˆï¼Ÿâ€ï¼Œå¤§æ¨¡å‹è¦ä¹ˆè¯´â€œä¸çŸ¥é“â€ï¼Œè¦ä¹ˆèƒ¡ç¼–ä¹±é€ ä¸€ä¸ªç­”æ¡ˆã€‚

è¿™å°±æ˜¯å¤§æ¨¡å‹çš„åŸç”Ÿç—›ç‚¹â€”â€”çŸ¥è¯†æ»åã€äº‹å®æ€§å·®ã€‚

### 4.3.1 å¤§æ¨¡å‹åŸç”Ÿç—›ç‚¹ï¼šçŸ¥è¯†æ»åä¸äº‹å®æ€§é”™è¯¯çš„æ ¹æº

å¤§æ¨¡å‹çš„ä¸¤ä¸ªè‡´å‘½ç¼ºç‚¹ï¼Œè®©å®ƒåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­â€œå¯¸æ­¥éš¾è¡Œâ€ï¼š

1. **çŸ¥è¯†æ»å**ï¼šå¤§æ¨¡å‹çš„çŸ¥è¯†æˆªæ­¢äºè®­ç»ƒæ•°æ®çš„æ—¶é—´ï¼Œæ¯”å¦‚2023å¹´è®­ç»ƒçš„æ¨¡å‹ï¼Œä¸çŸ¥é“2024å¹´ä¹‹åå‘ç”Ÿçš„äº‹ã€‚å°±åƒä¸€ä¸ªäººå¾ˆä¹…æ²¡ä¸Šç½‘ï¼Œä¸çŸ¥é“æœ€æ–°çš„çƒ­ç‚¹æ–°é—»ï¼›
2. **äº‹å®æ€§é”™è¯¯ï¼ˆå¹»è§‰ï¼‰**ï¼šå¤§æ¨¡å‹ä¼šâ€œä¸€æœ¬æ­£ç»åœ°èƒ¡è¯´å…«é“â€ï¼Œæ¯”å¦‚æŠŠå¼ ä¸‰çš„äº‹å®‰åˆ°æå››èº«ä¸Šï¼Œç”šè‡³ç¼–é€ ä¸å­˜åœ¨çš„æ–‡çŒ®ã€æ•°æ®ã€‚æ–°åç¤¾çš„æŠ¥é“ä¸­å°±æåˆ°ï¼Œæœ‰å¤§æ¨¡å‹æŠŠæ–‡ç‰©â€œé’é“œåˆ©ç°‹â€çš„é“¸é€ è€…è®¤é”™ï¼Œè¿˜ä¼ªé€ äº†å­¦æœ¯è§‚ç‚¹å’Œä½œè€…ä¿¡æ¯ã€‚æ›´ä¸¥é‡çš„æ˜¯ï¼Œâ€œè¯­æ–™æ±¡æŸ“â€è¿˜ä¼šè®©å¤§æ¨¡å‹çš„é”™è¯¯ç‡é£™å‡ï¼Œæ¯”å¦‚ä¸æ³•åˆ†å­é€šè¿‡å¤§é‡å‘å¸ƒè™šå‡ä¿¡æ¯ï¼Œè®©å¤§æ¨¡å‹è¯¯åˆ¤ä¸ºå¯ä¿¡ä¿¡æ¯ï¼Œè¿›è€Œç”¨äºâ€œAIæ€çŒªç›˜â€ç­‰è¯ˆéª—æ´»åŠ¨ã€‚

ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå› ä¸ºå¤§æ¨¡å‹çš„çŸ¥è¯†æ˜¯â€œæ­»â€çš„ï¼Œå­˜åœ¨äºè®­ç»ƒå‚æ•°ä¸­ï¼Œæ— æ³•å®æ—¶æ›´æ–°ï¼Œä¹Ÿæ— æ³•éªŒè¯äº‹å®çš„å‡†ç¡®æ€§ã€‚è€ŒRAGï¼Œå°±æ˜¯ç»™å¤§æ¨¡å‹è£…ä¸Šä¸€ä¸ªâ€œå¯æ›´æ–°çš„çŸ¥è¯†åº“â€å’Œâ€œäº‹å®æ ¡éªŒå™¨â€ã€‚

### 4.3.2 RAG æ ¸å¿ƒé€»è¾‘ï¼šæ£€ç´¢å¢å¼ºçš„æœ¬è´¨æ˜¯â€œçŸ¥è¯†è¡¥å……â€ä¸â€œäº‹å®æ ¡éªŒâ€

RAGçš„å…¨ç§°æ˜¯Retrieval-Augmented Generationï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼Œæ ¸å¿ƒé€»è¾‘è¶…ç®€å•ï¼šåœ¨å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆä¹‹å‰ï¼Œå…ˆä»å¤–éƒ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³çš„çœŸå®ã€æœ€æ–°ä¿¡æ¯ï¼ŒæŠŠè¿™äº›ä¿¡æ¯ä½œä¸ºâ€œå‚è€ƒèµ„æ–™â€ä¼ ç»™å¤§æ¨¡å‹ï¼Œè®©å¤§æ¨¡å‹åŸºäºå‚è€ƒèµ„æ–™ç”Ÿæˆç­”æ¡ˆã€‚

å°±åƒè€ƒè¯•æ—¶ï¼Œä½ é‡åˆ°ä¸€ä¸ªä¸ä¼šçš„é—®é¢˜ï¼Œç›‘è€ƒè€å¸ˆç»™ä½ ä¸€æœ¬å‚è€ƒä¹¦ï¼Œè®©ä½ åŸºäºå‚è€ƒä¹¦çš„å†…å®¹ç­”é¢˜â€”â€”è¿™æ ·æ—¢èƒ½ä¿è¯ç­”æ¡ˆçš„å‡†ç¡®æ€§ï¼Œåˆèƒ½å›ç­”ä½ åŸæœ¬ä¸ä¼šçš„é—®é¢˜ã€‚RAGçš„æµç¨‹å¯ä»¥æ€»ç»“ä¸ºä¸‰æ­¥ï¼š

1. æ£€ç´¢ï¼šç”¨æˆ·æé—®åï¼Œä»å¤–éƒ¨çŸ¥è¯†åº“ï¼ˆæ¯”å¦‚å…¬å¸æ–‡æ¡£ã€æœ€æ–°æ–°é—»ã€è¡Œä¸šæŠ¥å‘Šï¼‰ä¸­æ£€ç´¢å’Œé—®é¢˜ç›¸å…³çš„ä¿¡æ¯ï¼›
2. å¢å¼ºï¼šæŠŠæ£€ç´¢åˆ°çš„ä¿¡æ¯å’Œç”¨æˆ·é—®é¢˜ä¸€èµ·ï¼Œä½œä¸ºæç¤ºè¯çš„ä¸€éƒ¨åˆ†ä¼ ç»™å¤§æ¨¡å‹ï¼›
3. ç”Ÿæˆï¼šå¤§æ¨¡å‹åŸºäºæ£€ç´¢åˆ°çš„å‚è€ƒèµ„æ–™ï¼Œç”Ÿæˆå‡†ç¡®ã€æœ‰ä¾æ®çš„ç­”æ¡ˆã€‚

> å°æç¤ºï¼šRAGçš„æœ¬è´¨ä¸æ˜¯æ›¿ä»£å¤§æ¨¡å‹ï¼Œè€Œæ˜¯â€œèµ‹èƒ½â€å¤§æ¨¡å‹â€”â€”è®©å¤§æ¨¡å‹èƒ½åˆ©ç”¨å¤–éƒ¨çš„ã€å®æ—¶çš„ã€å‡†ç¡®çš„çŸ¥è¯†æ¥ç”Ÿæˆç­”æ¡ˆï¼Œè§£å†³çŸ¥è¯†æ»åå’Œäº‹å®æ€§é”™è¯¯çš„é—®é¢˜ã€‚

### 4.3.3 RAG çš„æ ¸å¿ƒä»·å€¼ï¼šæå‡åº”ç”¨å‡†ç¡®æ€§ã€æ‹“å±•çŸ¥è¯†è¾¹ç•Œã€é™ä½å¾®è°ƒæˆæœ¬

ç›¸æ¯”ç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹ï¼ŒRAGæœ‰ä¸‰ä¸ªæ ¸å¿ƒä»·å€¼ï¼Œä¹Ÿæ˜¯ä¼ä¸šä¸ºä»€ä¹ˆæ„¿æ„ç”¨RAGçš„åŸå› ï¼š

1. **æå‡å‡†ç¡®æ€§**ï¼šç­”æ¡ˆåŸºäºçœŸå®çš„å‚è€ƒèµ„æ–™ï¼Œå¤§å¤§å‡å°‘äº‹å®æ€§é”™è¯¯ã€‚æ¯”å¦‚é—®å…¬å¸å†…éƒ¨æ”¿ç­–ï¼ŒRAGä¼šä»å…¬å¸æ–‡æ¡£ä¸­æ£€ç´¢å‡†ç¡®ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å¤§æ¨¡å‹çç¼–ï¼›
2. **æ‹“å±•çŸ¥è¯†è¾¹ç•Œ**ï¼šå¤§æ¨¡å‹å¯ä»¥è·å–è®­ç»ƒæ•°æ®ä¹‹å¤–çš„çŸ¥è¯†ï¼ŒåŒ…æ‹¬æœ€æ–°ä¿¡æ¯ï¼ˆæ¯”å¦‚2025å¹´çš„è¡Œä¸šæ•°æ®ï¼‰å’Œç§æœ‰ä¿¡æ¯ï¼ˆæ¯”å¦‚å…¬å¸å†…éƒ¨æ–‡æ¡£ã€å®¢æˆ·èµ„æ–™ï¼‰ï¼›
3. **é™ä½æˆæœ¬**ï¼šæ›´æ–°çŸ¥è¯†ä¸éœ€è¦é‡æ–°è®­ç»ƒå¤§æ¨¡å‹ï¼ˆå¾®è°ƒæˆæœ¬å¾ˆé«˜ï¼ŒåŠ¨è¾„å‡ åä¸‡ï¼‰ï¼Œåªéœ€è¦æ›´æ–°å¤–éƒ¨çŸ¥è¯†åº“ï¼ˆæ¯”å¦‚æ·»åŠ æ–°çš„æ–‡æ¡£ï¼‰ï¼Œæˆæœ¬ä½ã€æ•ˆç‡é«˜ã€‚

### 4.3.4 RAG é€‚ç”¨åœºæ™¯ä¸ä¸é€‚ç”¨åœºæ™¯è¾¨æ

RAGä¸æ˜¯ä¸‡èƒ½çš„ï¼Œè¦æ ¹æ®åœºæ™¯é€‰æ‹©æ˜¯å¦ä½¿ç”¨ã€‚ä¸‹é¢åˆ—å‡ºé€‚ç”¨å’Œä¸é€‚ç”¨çš„åœºæ™¯ï¼Œå¸®å¤§å®¶é¿å‘ï¼š

| é€‚ç”¨åœºæ™¯                                                     | ä¸é€‚ç”¨åœºæ™¯                                                   |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| 1. ä¼ä¸šå†…éƒ¨çŸ¥è¯†åº“é—®ç­”ï¼ˆæ¯”å¦‚å‘˜å·¥æ‰‹å†Œã€äº§å“æ–‡æ¡£ã€æŠ€æœ¯æ‰‹å†Œï¼‰ï¼›2. è¡Œä¸šæŠ¥å‘Š/æ”¿ç­–æ–‡ä»¶é—®ç­”ï¼ˆéœ€è¦å‡†ç¡®çš„äº‹å®å’Œæ•°æ®ï¼‰ï¼›3. æœ€æ–°ä¿¡æ¯é—®ç­”ï¼ˆæ¯”å¦‚æ–°é—»èµ„è®¯ã€èµ›äº‹ç»“æœã€è‚¡å¸‚è¡Œæƒ…ï¼‰ï¼›4. ç§æœ‰æ•°æ®é—®ç­”ï¼ˆæ¯”å¦‚å®¢æˆ·èµ„æ–™ã€åˆåŒæ–‡æ¡£ã€å†…éƒ¨ä¼šè®®çºªè¦ï¼‰ã€‚ | 1. åˆ›é€ æ€§ä»»åŠ¡ï¼ˆæ¯”å¦‚å†™è¯—æ­Œã€ç¼–æ•…äº‹ã€è®¾è®¡å¹¿å‘Šè¯­ï¼Œä¸éœ€è¦çœŸå®å‚è€ƒèµ„æ–™ï¼‰ï¼›2. é€»è¾‘æ¨ç†ä»»åŠ¡ï¼ˆæ¯”å¦‚æ•°å­¦é¢˜ã€ç¼–ç¨‹é¢˜ï¼Œæ ¸å¿ƒæ˜¯é€»è¾‘è®¡ç®—ï¼Œä¸æ˜¯å¤–éƒ¨çŸ¥è¯†ï¼‰ï¼›3. ç®€å•é—²èŠï¼ˆæ¯”å¦‚â€œä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·â€ï¼Œä¸éœ€è¦å¤æ‚çš„çŸ¥è¯†åº“æ£€ç´¢ï¼‰ã€‚ |

ä¸¾ä¸ªä¾‹å­ï¼šåšä¸€ä¸ªâ€œå…¬å¸äº§å“æ‰‹å†Œé—®ç­”æœºå™¨äººâ€ï¼Œé€‚åˆç”¨RAGï¼›åšä¸€ä¸ªâ€œå„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨â€ï¼Œä¸é€‚åˆç”¨RAGã€‚

## 4.4 RAG ç³»ç»Ÿæ„å»ºå…¨æµç¨‹å®æ“

è¿™éƒ¨åˆ†æ˜¯å®æ“é‡ç‚¹ï¼Œæˆ‘ä»¬å°†ä¸€æ­¥æ­¥æ„å»ºä¸€ä¸ªå®Œæ•´çš„RAGç³»ç»Ÿã€‚

ä¸€ä¸ªæ ‡å‡†çš„RAGç³»ç»Ÿï¼Œä»æ•°æ®å‡†å¤‡åˆ°æœ€ç»ˆé—®ç­”ï¼Œéœ€è¦ç»è¿‡4ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼šæ–‡æ¡£åŠ è½½â†’æ–‡æœ¬åˆ†å‰²â†’å‘é‡å­˜å‚¨â†’æ£€ç´¢ä¸ç”Ÿæˆã€‚

å’±ä»¬é€ä¸ªç¯èŠ‚æ‹†è§£ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½é…å®æ“ä»£ç ã€‚

**é‡è¦å‰ç½®è¯´æ˜**ï¼šLangChain æ–°ç‰ˆå·²å°†æ‰€æœ‰ç¬¬ä¸‰æ–¹æ–‡æ¡£åŠ è½½å™¨è¿ç§»è‡³ `langchain-community` åº“ï¼ˆæ ¸å¿ƒåº“ä»…ä¿ç•™åŸºç¡€æ¥å£ï¼‰ï¼Œå› æ­¤å…ˆç¡®ä¿å®‰è£…å¿…å¤‡ä¾èµ–ï¼š `pip install langchain-core langchain-community`

### 4.4.1 æ–‡æ¡£åŠ è½½ï¼ˆDocument Loadingï¼‰

ç¬¬ä¸€æ­¥æ˜¯â€œæ–‡æ¡£åŠ è½½â€â€”â€”æŠŠæˆ‘ä»¬çš„çŸ¥è¯†åº“ï¼ˆæ¯”å¦‚PDFã€Wordã€Markdownã€TXTæ–‡ä»¶ï¼‰åŠ è½½åˆ°LangChainä¸­ï¼Œè½¬æ¢æˆç»Ÿä¸€çš„Documentå¯¹è±¡ï¼ˆLangChainå®šä¹‰çš„æ–‡æ¡£æ ¼å¼ï¼ŒåŒ…å«æ–‡æœ¬å†…å®¹å’Œå…ƒæ•°æ®ï¼‰ã€‚

4.4.1.1 å¸¸è§æ–‡æ¡£æ ¼å¼é€‚é…ï¼ˆPDFã€Wordã€Markdownã€TXTï¼‰

ä¸åŒæ ¼å¼çš„æ–‡æ¡£ï¼ŒåŠ è½½æ–¹å¼ä¸åŒã€‚LangChainæä¾›äº†å¤§é‡çš„æ–‡æ¡£åŠ è½½å™¨ï¼Œè¦†ç›–ä¸»æµæ ¼å¼ã€‚ä¸‹é¢åˆ—å‡ºå¸¸è§æ ¼å¼çš„åŠ è½½å™¨å’Œä¾èµ–åŒ…ï¼š

| æ–‡æ¡£æ ¼å¼        | å®˜æ–¹æ¨èåŠ è½½å™¨                                             | éœ€è¦å®‰è£…çš„ä¾èµ–åŒ…                                             |
| --------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| TXT             | TextLoader                                                 | æ— éœ€é¢å¤–å®‰è£…ï¼ˆlangchain-community å†…ç½®ï¼‰                     |
| PDF             | PyPDFLoaderï¼ˆåŸºç¡€æ¬¾ï¼‰/ PDFPlumberLoaderï¼ˆå¤æ‚æ¬¾ï¼‰          | åŸºç¡€æ¬¾ï¼š`pip install pypdf`ï¼›å¤æ‚æ¬¾ï¼š`pip install pdfplumber` |
| Wordï¼ˆ.docxï¼‰   | DocxLoader                                                 | `pip install python-docx`ï¼ˆæ— éœ€æ—§ç‰ˆ docx2txtï¼‰               |
| Markdownï¼ˆ.mdï¼‰ | MarkdownLoaderï¼ˆè½»é‡æ¬¾ï¼‰/ UnstructuredFileLoaderï¼ˆé€šç”¨æ¬¾ï¼‰ | è½»é‡æ¬¾ï¼š`pip install python-markdown`ï¼›é€šç”¨æ¬¾ï¼š`pip install unstructured` |

#### 4.4.1.2 å®æ“ï¼šå¤šæ ¼å¼æ–‡æ¡£åŠ è½½ä»£ç å®ç°

å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼ä¸‹é¢å’±ä»¬é€ä¸ªå®ç°ä¸åŒæ ¼å¼æ–‡æ¡£çš„åŠ è½½ï¼Œä»£ç é‡Œéƒ½åŠ äº†è¯¦ç»†æ³¨é‡Šï¼Œè·Ÿç€æ•²å°±è¡Œã€‚å…ˆç»Ÿä¸€è¯´æ˜ï¼šæ‰€æœ‰æ–‡æ¡£éƒ½æ”¾åœ¨ä¸€ä¸ªå«ã€Œknowledge_baseã€çš„æ–‡ä»¶å¤¹é‡Œï¼Œå»ºè®®å¤§å®¶å…ˆåˆ›å»ºè¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œå†æŠŠæµ‹è¯•æ–‡æ¡£æ”¾è¿›å»ï¼ˆæ¯”å¦‚æ”¾ä¸€ä¸ªtest.txtã€test.pdfã€test.docxã€test.mdï¼‰ã€‚

**1. TXTæ–‡æ¡£åŠ è½½ï¼ˆæœ€ç®€å•çš„å…¥é—¨æ¡ˆä¾‹ï¼‰**

TextLoader æ˜¯å®˜æ–¹æ¨èçš„TXTä¸“å±åŠ è½½å™¨ï¼Œè½»é‡æ— å†—ä½™ä¾èµ–ï¼Œæ”¯æŒè‡ªå®šä¹‰ç¼–ç ï¼Œé€‚é…ä¸­æ–‡æ–‡æ¡£ã€‚

```python
# å¯¼å…¥TXTåŠ è½½å™¨ï¼ˆæ–°ç‰ˆè·¯å¾„ï¼šlangchain_community.document_loadersï¼‰
from langchain_community.document_loaders import TextLoader
import os

# å®šä¹‰æ–‡æ¡£è·¯å¾„ï¼ˆè¯·æ›¿æ¢æˆä½ è‡ªå·±çš„è·¯å¾„ï¼‰
txt_path = os.path.join("knowledge_base", "test.txt")

# åˆå§‹åŒ–åŠ è½½å™¨å¹¶åŠ è½½æ–‡æ¡£
loader = TextLoader(txt_path, encoding="utf-8")  # æŒ‡å®šç¼–ç ï¼Œé¿å…ä¸­æ–‡ä¹±ç 
txt_docs = loader.load()  # load()è¿”å›Documentå¯¹è±¡åˆ—è¡¨ï¼ˆå³ä½¿åªæœ‰ä¸€ä¸ªæ–‡æ¡£ï¼‰

# æŸ¥çœ‹åŠ è½½ç»“æœ
print("TXTæ–‡æ¡£åŠ è½½ç»“æœï¼š")
print(f"æ–‡æ¡£æ•°é‡ï¼š{len(txt_docs)}")
print(f"æ–‡æ¡£å†…å®¹ï¼š{txt_docs[0].page_content[:200]}...")  # æ‰“å°å‰200ä¸ªå­—ç¬¦
print(f"æ–‡æ¡£å…ƒæ•°æ®ï¼š{txt_docs[0].metadata}")  # å…ƒæ•°æ®åŒ…å«æ–‡æ¡£è·¯å¾„ç­‰ä¿¡æ¯
```

> è¸©å‘æŒ‡å—ï¼šå¦‚æœåŠ è½½ä¸­æ–‡TXTå‡ºç°ä¹±ç ï¼Œå¤§æ¦‚ç‡æ˜¯ç¼–ç é—®é¢˜ï¼æŠŠencodingå‚æ•°æ”¹æˆ"gbk"è¯•è¯•ï¼ˆæœ‰äº›æ—§TXTæ˜¯gbkç¼–ç ï¼‰ã€‚

**2. PDFæ–‡æ¡£åŠ è½½ï¼ˆä¼ä¸šåœºæ™¯æœ€å¸¸ç”¨ï¼‰**

å®˜æ–¹æ¨èåŸºç¡€åœºæ™¯ç”¨ PyPDFLoaderï¼ˆè½»é‡é«˜æ•ˆï¼‰ï¼Œå¤æ‚åœºæ™¯ï¼ˆéœ€ä¿ç•™è¡¨æ ¼ã€ç²¾å‡†é¡µç ã€æ ¼å¼ï¼‰ç”¨ PDFPlumberLoaderã€‚ä¸¤è€…å‡ä¼šæŒ‰é¡µæ‹†åˆ†æ–‡æ¡£ï¼Œç”Ÿæˆç‹¬ç«‹Documentå¯¹è±¡ï¼Œæ–¹ä¾¿åç»­å¤„ç†ã€‚

```python
# æ–¹æ¡ˆ1ï¼šåŸºç¡€æ¬¾ï¼ˆå®˜æ–¹æ¨èï¼Œä»…æå–æ–‡æœ¬ï¼Œè½»é‡ï¼‰
from langchain_community.document_loaders import PyPDFLoader
import os

# å®šä¹‰PDFè·¯å¾„
pdf_path = os.path.join("knowledge_base", "test.pdf")

# åˆå§‹åŒ–åŠ è½½å™¨å¹¶åŠ è½½ï¼ˆæŒ‰é¡µæ‹†åˆ†ï¼‰
loader = PyPDFLoader(pdf_path)
pdf_docs = loader.load_and_split()  # load_and_split()ç›´æ¥æŒ‰é¡µæ‹†åˆ†ï¼Œæ›´æ˜“ç”¨

# æŸ¥çœ‹ç»“æœ
print("\nPDFæ–‡æ¡£åŠ è½½ç»“æœï¼ˆåŸºç¡€æ¬¾ï¼‰ï¼š")
print(f"PDFæ€»é¡µæ•°ï¼š{len(pdf_docs)}")
print(f"ç¬¬1é¡µå†…å®¹ï¼š{pdf_docs[0].page_content[:200]}...")
print(f"ç¬¬1é¡µå…ƒæ•°æ®ï¼š{pdf_docs[0].metadata}")  # å…ƒæ•°æ®åŒ…å«é¡µç ã€æ–‡æ¡£è·¯å¾„

# æ–¹æ¡ˆ2ï¼šå¤æ‚æ¬¾ï¼ˆéœ€ä¿ç•™è¡¨æ ¼/æ ¼å¼æ—¶ç”¨ï¼‰
from langchain_community.document_loaders import PDFPlumberLoader

loader = PDFPlumberLoader(pdf_path)
pdf_docs_adv = loader.load()
print("\nPDFæ–‡æ¡£åŠ è½½ç»“æœï¼ˆå¤æ‚æ¬¾ï¼‰ï¼š")
print(f"ç¬¬1é¡µè¡¨æ ¼/æ ¼å¼ä¿ç•™æƒ…å†µï¼š{pdf_docs_adv[0].page_content[:200]}...")
```

**3. Wordæ–‡æ¡£åŠ è½½ï¼ˆé€‚é….docxæ ¼å¼ï¼‰**

å®˜æ–¹å·²æ·˜æ±°æ—§ç‰ˆ Docx2txtLoaderï¼Œå½“å‰æ¨è DocxLoaderï¼ˆlangchain-community å†…ç½®ï¼‰ï¼Œæ”¯æŒè¯»å–Wordä¸­çš„æ–‡æœ¬ã€è¡¨æ ¼ç­‰å†…å®¹ï¼Œç¨³å®šæ€§æ›´å¼ºï¼Œæ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹ docx2txt åº“ã€‚

```python
# å¯¼å…¥WordåŠ è½½å™¨ï¼ˆæ–°ç‰ˆå®˜æ–¹æ¨èï¼‰
from langchain_community.document_loaders import DocxLoader
import os

# å®šä¹‰Wordè·¯å¾„
docx_path = os.path.join("knowledge_base", "test.docx")

# åŠ è½½æ–‡æ¡£ï¼ˆæ— éœ€å®‰è£…docx2txtï¼Œä»…éœ€æå‰å®‰è£…python-docxï¼‰
loader = DocxLoader(docx_path)
docx_docs = loader.load()

# æŸ¥çœ‹ç»“æœ
print("\nWordæ–‡æ¡£åŠ è½½ç»“æœï¼š")
print(f"æ–‡æ¡£æ•°é‡ï¼š{len(docx_docs)}")
print(f"æ–‡æ¡£å†…å®¹ï¼š{docx_docs[0].page_content[:200]}...")
print(f"å…ƒæ•°æ®ï¼š{docx_docs[0].metadata}")
```

> è¸©å‘æŒ‡å—ï¼š1. ä»…æ”¯æŒ .docx æ ¼å¼ï¼Œæ—§ç‰ˆ .doc éœ€å…ˆè½¬æˆ .docxï¼›2. è‹¥Wordå«å¤§é‡å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æ— æ³•ç›´æ¥æå–ï¼Œéœ€é¢å¤–é›†æˆOCRå·¥å…·ã€‚

**4. Markdownæ–‡æ¡£åŠ è½½ï¼ˆæŠ€æœ¯æ–‡æ¡£å¸¸ç”¨ï¼‰**

å®˜æ–¹æ¨èè½»é‡æ¬¾ MarkdownLoaderï¼ˆä¿ç•™æ ‡é¢˜å±‚çº§ã€åˆ—è¡¨ç­‰ç»“æ„ï¼‰ï¼Œé¿å…ä½¿ç”¨é‡é‡çº§çš„ UnstructuredMarkdownLoaderï¼ˆä¾èµ–å¤æ‚ï¼‰ã€‚è‹¥éœ€é€‚é…å¤šæ ¼å¼é€šç”¨åœºæ™¯ï¼Œå¯å¤‡é€‰ UnstructuredFileLoaderã€‚

```python
# æ–¹æ¡ˆ1ï¼šè½»é‡æ¬¾ï¼ˆå®˜æ–¹æ¨èï¼Œä¿ç•™MDç»“æ„ï¼Œä¼˜å…ˆé€‰ï¼‰
from langchain_community.document_loaders import MarkdownLoader
import os

# å®šä¹‰MDè·¯å¾„
md_path = os.path.join("knowledge_base", "test.md")

# åŠ è½½æ–‡æ¡£ï¼ˆéœ€æå‰å®‰è£…python-markdownï¼‰
loader = MarkdownLoader(md_path)
md_docs = loader.load()

# æŸ¥çœ‹ç»“æœ
print("\nMarkdownæ–‡æ¡£åŠ è½½ç»“æœï¼ˆè½»é‡æ¬¾ï¼‰ï¼š")
print(f"æ–‡æ¡£æ•°é‡ï¼š{len(md_docs)}")
print(f"æ–‡æ¡£å†…å®¹ï¼ˆä¿ç•™ç»“æ„ï¼‰ï¼š{md_docs[0].page_content[:200]}...")
print(f"å…ƒæ•°æ®ï¼š{md_docs[0].metadata}")

# æ–¹æ¡ˆ2ï¼šé€šç”¨æ¬¾ï¼ˆé€‚é…å¤šæ ¼å¼ï¼Œå«MD/TXTç­‰ï¼‰
from langchain_community.document_loaders import UnstructuredFileLoader

loader = UnstructuredFileLoader(md_path, mode="elements")  # mode="elements"ä¿ç•™ç»“æ„
md_docs_univ = loader.load()
print("\nMarkdownæ–‡æ¡£åŠ è½½ç»“æœï¼ˆé€šç”¨æ¬¾ï¼‰ï¼š")
print(f"å†…å®¹é¢„è§ˆï¼š{md_docs_univ[0].page_content[:200]}...")
```

**5. æ‰¹é‡åŠ è½½å¤šæ ¼å¼æ–‡æ¡£ï¼ˆå®ç”¨æŠ€å·§ï¼‰**

å¦‚æœçŸ¥è¯†åº“æ–‡ä»¶å¤¹é‡Œæœ‰å¤šç§æ ¼å¼çš„æ–‡æ¡£ï¼Œä¸€ä¸ªä¸ªåŠ è½½å¤ªéº»çƒ¦ï¼Œå’±ä»¬åŸºäºå®˜æ–¹æ¨èåŠ è½½å™¨å†™ä¸ªæ‰¹é‡åŠ è½½å‡½æ•°ï¼Œè‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶åŠ è½½ï¼š

```python
from langchain_community.document_loaders import (
    TextLoader, PyPDFLoader, DocxLoader, MarkdownLoader
)
import os

def batch_load_documents(folder_path):
    """
    æ‰¹é‡åŠ è½½æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰å®˜æ–¹æ”¯æŒæ ¼å¼æ–‡æ¡£ï¼ˆåŸºäºæ–°ç‰ˆåŠ è½½å™¨ï¼‰
    :param folder_path: çŸ¥è¯†åº“æ–‡ä»¶å¤¹è·¯å¾„
    :return: æ‰€æœ‰æ–‡æ¡£çš„Documentå¯¹è±¡åˆ—è¡¨
    """
    all_docs = []
    # éå†æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶
    for filename in os.listdir(folder_path):
        file_path = os.path.join(folder_path, filename)
        # è·³è¿‡æ–‡ä»¶å¤¹ï¼Œåªå¤„ç†æ–‡ä»¶
        if os.path.isdir(file_path):
            continue
        # æ ¹æ®æ–‡ä»¶åç¼€é€‰æ‹©å¯¹åº”çš„å®˜æ–¹æ¨èåŠ è½½å™¨
        try:
            if filename.endswith(".txt"):
                loader = TextLoader(file_path, encoding="utf-8")
            elif filename.endswith(".pdf"):
                loader = PyPDFLoader(file_path)  # åŸºç¡€æ¬¾ï¼Œå¤æ‚åœºæ™¯å¯æ›¿æ¢ä¸ºPDFPlumberLoader
            elif filename.endswith(".docx"):
                loader = DocxLoader(file_path)
            elif filename.endswith(".md"):
                loader = MarkdownLoader(file_path)
            else:
                print(f"ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š{filename}")
                continue
            # åŠ è½½å¹¶æ·»åŠ åˆ°æ–‡æ¡£åˆ—è¡¨
            docs = loader.load()
            all_docs.extend(docs)
            print(f"æˆåŠŸåŠ è½½ï¼š{filename}ï¼Œç”Ÿæˆ{len(docs)}ä¸ªDocumentå¯¹è±¡")
        except Exception as e:
            print(f"åŠ è½½å¤±è´¥ï¼š{filename}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š{str(e)}")
    return all_docs

# æµ‹è¯•æ‰¹é‡åŠ è½½
if __name__ == "__main__":
    knowledge_base_path = "knowledge_base"
    # ç¡®ä¿çŸ¥è¯†åº“æ–‡ä»¶å¤¹å­˜åœ¨
    if not os.path.exists(knowledge_base_path):
        os.makedirs(knowledge_base_path)
        print(f"å·²è‡ªåŠ¨åˆ›å»ºçŸ¥è¯†åº“æ–‡ä»¶å¤¹ï¼š{knowledge_base_path}ï¼Œè¯·æ”¾å…¥æµ‹è¯•æ–‡æ¡£")
    else:
        all_docs = batch_load_documents(knowledge_base_path)
        print(f"\næ‰¹é‡åŠ è½½å®Œæˆï¼Œæ€»Documentå¯¹è±¡æ•°ï¼š{len(all_docs)}")
        # æ‰“å°æ¯ä¸ªæ–‡æ¡£çš„åŸºæœ¬ä¿¡æ¯
        for i, doc in enumerate(all_docs):
            print(f"\næ–‡æ¡£{i+1}ï¼š")
            print(f"å†…å®¹é¢„è§ˆï¼š{doc.page_content[:100]}...")
            print(f"å…ƒæ•°æ®ï¼š{doc.metadata}")
```

è¿™ä¸ªå‡½æ•°è¶…å®ç”¨ï¼åç»­æ„å»ºè‡ªå·±çš„RAGç³»ç»Ÿæ—¶ï¼Œç›´æ¥è°ƒç”¨å®ƒå°±èƒ½åŠ è½½æ•´ä¸ªçŸ¥è¯†åº“çš„æ–‡æ¡£ï¼Œçœäº†å¾ˆå¤šé‡å¤ä»£ç ã€‚

### 4.4.2 æ–‡æœ¬åˆ†å‰²ï¼ˆText Splittingï¼‰ï¼šè®©æ£€ç´¢æ›´ç²¾å‡†çš„å…³é”®ä¸€æ­¥

åŠ è½½å®Œæ–‡æ¡£åï¼Œä¸‹ä¸€æ­¥è¦åšçš„æ˜¯ã€Œæ–‡æœ¬åˆ†å‰²ã€â€”â€”æŠŠå¤§æ–‡æ¡£åˆ‡æˆä¸€ä¸ªä¸ªå°çš„æ–‡æœ¬ç‰‡æ®µï¼ˆå«Chunksï¼‰ã€‚å¯èƒ½æœ‰åŒå­¦ä¼šé—®ï¼šâ€œç›´æ¥ç”¨æ•´ä¸ªæ–‡æ¡£æ£€ç´¢ä¸è¡Œå—ï¼Ÿâ€ è¿˜çœŸä¸è¡Œï¼è¿™é‡Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒåŸå› ï¼š

1. **å¤§æ¨¡å‹æœ‰ä¸Šä¸‹æ–‡çª—å£é™åˆ¶**ï¼šæ¯”å¦‚GPT-3.5-turbo-instructæœ€å¤šæ”¯æŒ4096ä¸ªtokenï¼ˆå¤§æ¦‚3000ä¸ªä¸­æ–‡å­—ï¼‰ï¼Œå¦‚æœæ–‡æ¡£å¤ªå¤§ï¼Œæ ¹æœ¬å¡ä¸è¿›å¤§æ¨¡å‹çš„â€œè„‘å­â€é‡Œï¼›
2. **æ£€ç´¢ç²¾åº¦ä½**ï¼šç”¨æ•´ä¸ªæ–‡æ¡£å»åŒ¹é…ç”¨æˆ·é—®é¢˜ï¼Œå°±åƒåœ¨ä¸€æœ¬åšåšçš„å­—å…¸é‡Œæ‰¾ä¸€ä¸ªå­—å´ä¸ç¿»ç´¢å¼•â€”â€”èŒƒå›´å¤ªå¤§ï¼Œå¾ˆå®¹æ˜“æŠŠä¸ç›¸å…³çš„å†…å®¹ä¹Ÿæ£€ç´¢å‡ºæ¥ã€‚è€Œåˆ‡æˆå°ç‰‡æ®µåï¼Œèƒ½ç²¾å‡†åŒ¹é…å’Œé—®é¢˜ç›¸å…³çš„å±€éƒ¨å†…å®¹ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šä½ é—®â€œLangChainçš„é“¾å¼å·¥ä½œæµæœ‰å“ªäº›ç±»å‹ï¼Ÿâ€ï¼Œå¦‚æœæŠŠåŒ…å«é“¾å¼å·¥ä½œæµã€RAGã€å‘é‡å­˜å‚¨çš„å¤§æ–‡æ¡£æ•´ä¸ªæ‹¿å»æ£€ç´¢ï¼Œå¯èƒ½ä¼šæŠŠRAGçš„å†…å®¹ä¹Ÿå¸¦å‡ºæ¥ï¼›ä½†å¦‚æœåˆ‡æˆâ€œé“¾å¼å·¥ä½œæµç±»å‹â€â€œRAGæ ¸å¿ƒåŸç†â€ç­‰å°ç‰‡æ®µï¼Œå°±èƒ½ç²¾å‡†å®šä½åˆ°éœ€è¦çš„å†…å®¹ã€‚

#### 4.4.2.1 æ ¸å¿ƒåŸåˆ™ï¼šå¦‚ä½•ç§‘å­¦åœ°åˆ†å‰²æ–‡æœ¬ï¼Ÿ

åˆ†å‰²æ–‡æœ¬ä¸æ˜¯â€œéšä¾¿åˆ‡â€ï¼Œè¦éµå¾ªä¸¤ä¸ªæ ¸å¿ƒåŸåˆ™ï¼Œä¸ç„¶ä¼šå½±å“åç»­æ£€ç´¢æ•ˆæœï¼š

- **ç›¸å…³æ€§åŸåˆ™**ï¼šåŒä¸€ä¸ªç‰‡æ®µå†…çš„å†…å®¹è¦è¯­ä¹‰ç›¸å…³ï¼Œä¸èƒ½æŠŠä¸€ä¸ªå®Œæ•´çš„çŸ¥è¯†ç‚¹åˆ‡æˆä¸¤åŠï¼ˆæ¯”å¦‚æŠŠâ€œçº¿æ€§é“¾çš„å®šä¹‰â€å’Œâ€œè·¯ç”±é“¾çš„å®šä¹‰â€æ··åœ¨ä¸€ä¸ªç‰‡æ®µï¼Œæˆ–æŠŠâ€œçº¿æ€§é“¾çš„å®šä¹‰â€åˆ‡æˆä¸¤æ®µï¼‰ï¼›
- **å¤§å°é€‚ä¸­åŸåˆ™**ï¼šç‰‡æ®µä¸èƒ½å¤ªå¤§ï¼ˆè¶…è¿‡å¤§æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£ï¼‰ï¼Œä¹Ÿä¸èƒ½å¤ªå°ï¼ˆå¤ªå°ä¼šä¸¢å¤±ä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚åªåˆ‡ä¸€ä¸ªè¯ï¼‰ã€‚ä¸€èˆ¬å»ºè®®ä¸­æ–‡ç‰‡æ®µé•¿åº¦åœ¨200-500å­—ï¼Œè‹±æ–‡åœ¨200-500ä¸ªtokenã€‚

#### 4.4.2.2 å¸¸è§åˆ†å‰²ç­–ç•¥ä¸LangChainæ¨èå®ç°

LangChain v0.1+ ç‰ˆæœ¬å¯¹æ–‡æœ¬åˆ†å‰²å™¨è¿›è¡Œäº†æ ‡å‡†åŒ–ä¼˜åŒ–ï¼Œæ ¸å¿ƒæ¨è `RecursiveCharacterTextSplitter` ä½œä¸ºé»˜è®¤åˆ†å‰²å™¨ï¼ˆé€‚é…ç»å¤§å¤šæ•°åœºæ™¯ï¼‰ï¼ŒåŒæ—¶ä¿ç•™é’ˆå¯¹æ€§åˆ†å‰²æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯å®˜æ–¹æ¨èçš„å®æ“æ–¹æ¡ˆï¼ˆå…¼å®¹æœ€æ–°APIï¼‰ï¼š

**1.é»˜è®¤æ¨èï¼šRecursiveCharacterTextSplitterï¼ˆæ™ºèƒ½è¯­ä¹‰åˆ†å‰²ï¼‰**

LangChain å®˜æ–¹æ¨èæ­¤åˆ†å‰²å™¨ä½œä¸ºé¦–é€‰â€”â€”å®ƒé€šè¿‡â€œåˆ†å±‚åˆ†éš”ç¬¦ä¼˜å…ˆçº§â€å®ç°è¯­ä¹‰æ„ŸçŸ¥åˆ†å‰²ï¼Œå…ˆæŒ‰å¤§åˆ†éš”ç¬¦ï¼ˆå¦‚ç©ºè¡Œï¼‰æ‹†åˆ†æ®µè½ï¼Œå†æŒ‰å°åˆ†éš”ç¬¦ï¼ˆå¦‚å¥å·ã€é€—å·ï¼‰å¾®è°ƒï¼Œç›´åˆ°ç‰‡æ®µé•¿åº¦ç¬¦åˆè¦æ±‚ï¼Œæœ€å¤§ç¨‹åº¦ä¿è¯è¯­ä¹‰å®Œæ•´æ€§ã€‚é€‚é…TXTã€Markdownã€PDFç­‰ç»å¤§å¤šæ•°æ–‡æœ¬ç±»å‹ã€‚

```python
from langchain_text_splitters import RecursiveCharacterTextSplitter 
from langchain_community.document_loaders import TextLoader   # LangChainæ¨èçš„åŸºç¡€æ–‡æœ¬åŠ è½½å™¨
from pathlib import Path  # å®˜æ–¹æ¨èç”¨pathlibå¤„ç†è·¯å¾„ï¼ˆæ¯”os.pathæ›´ç°ä»£ï¼‰

# 1. åŠ è½½æ–‡æ¡£ï¼ˆæ¨èç”¨Pathå¤„ç†è·¯å¾„ï¼Œé¿å…è·¨ç³»ç»Ÿå…¼å®¹é—®é¢˜ï¼‰
txt_path = Path("knowledge_base") / "test.txt"
loader = TextLoader(txt_path, encoding="utf-8")
txt_docs = loader.load()  # è¿”å›Documentå¯¹è±¡åˆ—è¡¨ï¼ˆå«å†…å®¹+å…ƒæ•°æ®ï¼‰

# 2. åˆå§‹åŒ–åˆ†å‰²å™¨ï¼ˆLangChainæ¨èå‚æ•°ï¼‰
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=300,          # ä¸­æ–‡ç‰‡æ®µæ¨èé•¿åº¦ï¼š200-500å­—
    chunk_overlap=50,        # é‡å é•¿åº¦ï¼šå»ºè®®ä¸ºchunk_sizeçš„10%-20%ï¼Œé¿å…è·¨ç‰‡æ®µè¯­ä¹‰ä¸¢å¤±
    length_function=len,     # ä¸­æ–‡ç”¨lenè®¡æ•°ï¼Œè‹±æ–‡å¯æ”¹ç”¨tiktoken.count_tokens
    separators=["\n\n", "\n", "ã€‚", "ï¼", "ï¼Ÿ", "ï¼Œ", "ï¼›", "ã€"]  # ä¸­æ–‡æ¨èåˆ†éš”ç¬¦ä¼˜å…ˆçº§
)

# 3. æ‰§è¡Œåˆ†å‰²ï¼ˆsplit_documentsä¸ºå®˜æ–¹æ¨èæ–¹æ³•ï¼Œæ¥æ”¶Documentåˆ—è¡¨ï¼‰
split_docs = text_splitter.split_documents(txt_docs)

# 4. éªŒè¯ç»“æœ
print(f"åŸå§‹æ–‡æ¡£æ•°ï¼š{len(txt_docs)}")
print(f"åˆ†å‰²åç‰‡æ®µæ•°ï¼š{len(split_docs)}")
print("\nå‰3ä¸ªç‰‡æ®µç¤ºä¾‹ï¼š")
for i, doc in enumerate(split_docs[:3]):
    print(f"\nç‰‡æ®µ{i+1}ï¼ˆå­—ç¬¦æ•°ï¼š{len(doc.page_content)}ï¼‰ï¼š")
    print(doc.page_content.strip())
    print(f"ç‰‡æ®µå…ƒæ•°æ®ï¼š{doc.metadata}")  # ä¿ç•™åŸå§‹æ–‡æ¡£è·¯å¾„ç­‰å…ƒæ•°æ®ï¼ˆæ£€ç´¢æ—¶æœ‰ç”¨ï¼‰
    
```

å…³é”®è¯´æ˜ï¼š

- separatorså‚æ•°ï¼šå®˜æ–¹å»ºè®®æŒ‰â€œè¯­ä¹‰é¢—ç²’åº¦ä»å¤§åˆ°å°â€æ’åºï¼Œä¸­æ–‡åœºæ™¯ä¼˜å…ˆç”¨ç©ºè¡Œã€æ¢è¡Œã€å¥æœ«æ ‡ç‚¹ï¼Œé¿å…æ‹†åˆ†å®Œæ•´å¥å­ï¼›
- å…ƒæ•°æ®ä¿ç•™ï¼šåˆ†å‰²åçš„æ¯ä¸ªç‰‡æ®µä¼šç»§æ‰¿åŸå§‹Documentçš„å…ƒæ•°æ®ï¼ˆå¦‚æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œè¿™æ˜¯LangChainæ¨èçš„å®è·µâ€”â€”åç»­æ£€ç´¢æ—¶å¯è¿½æº¯å†…å®¹æ¥æºï¼›
- é•¿åº¦è®¡ç®—ï¼šè‹¥éœ€å¯¹æ¥OpenAIç­‰æ¨¡å‹ï¼Œå¯æ”¹ç”¨`tiktoken.count_tokens`è®¡ç®—tokenæ•°ï¼ˆéœ€å®‰è£…tiktokenåŒ…ï¼‰ï¼Œæ›´è´´åˆæ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶ã€‚

**2. åŸºç¡€å¤‡é€‰ï¼šCharacterTextSplitterï¼ˆæŒ‰å­—ç¬¦æ•°åˆ†å‰²ï¼‰**

ä»…é€‚ç”¨äºç»“æ„æç®€å•çš„æ–‡æœ¬ï¼ˆå¦‚çº¯æ–‡æœ¬æ—¥å¿—ï¼‰ï¼ŒLangChainä¸æ¨èä½œä¸ºé»˜è®¤æ–¹æ¡ˆã€‚æ ¸å¿ƒä¼˜åŠ¿æ˜¯è½»é‡ã€é€Ÿåº¦å¿«ï¼Œéœ€æ‰‹åŠ¨ä¿è¯è¯­ä¹‰å®Œæ•´æ€§ã€‚

```python
from langchain_text_splitters import CharacterTextSplitter
from langchain_community.document_loaders import TextLoader 
from pathlib import Path

# åŠ è½½æ–‡æ¡£
txt_path = Path("knowledge_base") / "test.txt"
loader = TextLoader(txt_path, encoding="utf-8")
txt_docs = loader.load()

# åˆå§‹åŒ–ï¼ˆå®˜æ–¹æ¨èè®¾ç½®è‡ªç„¶åˆ†éš”ç¬¦ï¼‰
text_splitter = CharacterTextSplitter(
    separator="\n\n",        # ä¼˜å…ˆæŒ‰ç©ºè¡Œåˆ†å‰²ï¼Œå‡å°‘è¯­ä¹‰ç ´å
    chunk_size=300,
    chunk_overlap=50,
    length_function=len,
    keep_separator=False     # å®˜æ–¹é»˜è®¤Falseï¼Œä¸ä¿ç•™åˆ†éš”ç¬¦ï¼ˆé¿å…ç‰‡æ®µå†—ä½™ï¼‰
)

split_docs = text_splitter.split_documents(txt_docs)

# éªŒè¯ç»“æœ
print(f"åˆ†å‰²åç‰‡æ®µæ•°ï¼š{len(split_docs)}")
```

**3. é’ˆå¯¹æ€§åˆ†å‰²ï¼šMarkdownTextSplitterï¼ˆä¿ç•™MDæ ‡é¢˜å±‚çº§ï¼‰**

é’ˆå¯¹Markdownæ–‡æ¡£ï¼ˆæŠ€æœ¯æ–‡æ¡£ã€ç¬”è®°ï¼‰ï¼ŒLangChainæ¨èç”¨`MarkdownTextSplitter`â€”â€”å®ƒä¼šè¯†åˆ«MDæ ‡é¢˜å±‚çº§ï¼ˆ#ã€##ã€###ï¼‰ï¼Œç¡®ä¿â€œæ ‡é¢˜+å¯¹åº”å†…å®¹â€ä¸è¢«æ‹†åˆ†ï¼Œåç»­æ£€ç´¢æ—¶èƒ½é€šè¿‡æ ‡é¢˜å¿«é€Ÿå®šä½ä¸»é¢˜ã€‚æ­é…`UnstructuredMarkdownLoader`åŠ è½½æ–‡æ¡£ï¼ˆä¿ç•™MDç»“æ„å…ƒæ•°æ®ï¼‰ã€‚

```python
from langchain_text_splitters import MarkdownTextSplitter
from langchain_community.document_loaders import UnstructuredMarkdownLoader  # å®˜æ–¹æ¨èMDåŠ è½½å™¨
from pathlib import Path

# åŠ è½½MDæ–‡æ¡£ï¼ˆä¿ç•™æ ‡é¢˜å±‚çº§å…ƒæ•°æ®ï¼‰
md_path = Path("knowledge_base") / "test.md"
loader = UnstructuredMarkdownLoader(str(md_path), mode="elements")  # Pathè½¬å­—ç¬¦ä¸²å…¼å®¹æ‰€æœ‰ç‰ˆæœ¬
md_docs = loader.load()

# 3. åˆå§‹åŒ–MDåˆ†å‰²å™¨ï¼ˆä¿ç•™ä½ åŸæœ‰æ ¸å¿ƒå‚æ•°ï¼Œ1.xç‰ˆæœ¬å®Œå…¨å…¼å®¹ï¼‰
text_splitter = MarkdownTextSplitter(
    chunk_size=500,          # MDæœ‰æ ‡é¢˜å¼•å¯¼ï¼Œç‰‡æ®µé•¿åº¦å¯ç¨å¤§
    chunk_overlap=50,        # é‡å éƒ¨åˆ†é¿å…æ ‡é¢˜/å†…å®¹å‰²è£‚
    length_function=len,     # ä¸­æ–‡ç”¨lenè®¡æ•°å­—ç¬¦
    separators=["\n\n", "# ", "## ", "### "]  # ä¼˜å…ˆæŒ‰æ ‡é¢˜å±‚çº§åˆ†å‰²ï¼Œä¿ç•™è¯­ä¹‰
)

# 4. æ‰§è¡Œåˆ†å‰²ï¼ˆæ–¹æ³•åsplit_documentsåœ¨1.xç‰ˆæœ¬æ— å˜åŒ–ï¼‰
split_docs = text_splitter.split_documents(md_docs)

# 5. éªŒè¯ç»“æœï¼ˆç‰‡æ®µä¼šä¿ç•™MDæ ‡é¢˜å±‚çº§ï¼Œç¬¦åˆé¢„æœŸï¼‰
print(f"åˆ†å‰²åç‰‡æ®µæ•°ï¼š{len(split_docs)}")
print("\nå‰2ä¸ªMDç‰‡æ®µç¤ºä¾‹ï¼š")
for i, doc in enumerate(split_docs[:2]):
    print(f"\nç‰‡æ®µ{i+1}ï¼š")
    print(doc.page_content.strip())
    
```

### 4.4.3 å‘é‡å­˜å‚¨ä¸åµŒå…¥ï¼ˆVector Storage & Embeddingï¼‰ï¼šç»™æ–‡æœ¬åšâ€œæ•°å­—æŒ‡çº¹â€

åˆ†å‰²å®Œæ–‡æœ¬ç‰‡æ®µåï¼Œä¸‹ä¸€æ­¥è¦åšçš„æ˜¯ã€Œå‘é‡åµŒå…¥ã€å’Œã€Œå‘é‡å­˜å‚¨ã€ã€‚

è¿™ä¸€æ­¥æ˜¯RAGèƒ½å®ç°â€œç²¾å‡†æ£€ç´¢â€çš„æ ¸å¿ƒâ€”â€”æŠŠæ–‡å­—å˜æˆè®¡ç®—æœºèƒ½ç†è§£çš„â€œæ•°å­—â€ï¼Œå†å­˜åˆ°ä¸“é—¨çš„å‘é‡æ•°æ®åº“é‡Œï¼Œåç»­ç”¨æˆ·æé—®æ—¶ï¼Œä¹ŸæŠŠé—®é¢˜å˜æˆæ•°å­—ï¼Œé€šè¿‡æ¯”å¯¹æ•°å­—çš„ç›¸ä¼¼åº¦ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡æœ¬ç‰‡æ®µã€‚

ç”¨é€šä¿—çš„è¯è®²ï¼šæ¯ä¸ªæ–‡æœ¬ç‰‡æ®µå°±åƒä¸€ä¸ªäººï¼Œå‘é‡åµŒå…¥å°±æ˜¯ç»™æ¯ä¸ªäººåšä¸€ä¸ªâ€œæŒ‡çº¹â€ï¼ˆä¸€ä¸²æ•°å­—ï¼‰ï¼Œå‘é‡æ•°æ®åº“å°±æ˜¯å­˜æŒ‡çº¹çš„â€œæ•°æ®åº“â€ã€‚ç”¨æˆ·æé—®æ—¶ï¼Œå…ˆç»™é—®é¢˜åšä¸ªæŒ‡çº¹ï¼Œå†å»æ•°æ®åº“é‡Œæ‰¾æŒ‡çº¹æœ€åƒçš„äººï¼ˆæ–‡æœ¬ç‰‡æ®µï¼‰ï¼Œå°±æ˜¯æœ€ç›¸å…³çš„å†…å®¹ã€‚

#### 4.4.3.1 æ ¸å¿ƒæ¦‚å¿µï¼šåµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰

æŠŠæ–‡å­—å˜æˆå‘é‡çš„å·¥å…·å°±æ˜¯ã€ŒåµŒå…¥æ¨¡å‹ã€ã€‚å¥½çš„åµŒå…¥æ¨¡å‹èƒ½ç²¾å‡†æ•æ‰æ–‡æœ¬çš„è¯­ä¹‰â€”â€”æ„æ€è¶Šæ¥è¿‘çš„æ–‡æœ¬ï¼Œå‘é‡è¶Šåƒï¼ˆæ•°å­—å·®å€¼è¶Šå°ï¼‰ã€‚å¸¸è§çš„åµŒå…¥æ¨¡å‹æœ‰ï¼š

- å›½å†…æ¨¡å‹ï¼šqwen3-embeddingï¼›
- å¼€æºæ¨¡å‹ï¼šBERTã€Sentence-BERTï¼ˆå¯ä»¥æœ¬åœ°éƒ¨ç½²ï¼Œå…è´¹ï¼Œé€‚åˆéšç§æ•æ„Ÿåœºæ™¯ï¼‰ã€‚

å’±ä»¬å®æ“ç”¨qwen3-embedding-0.6bï¼Œè¯¥æ¨¡å‹åŸºäºé€šä¹‰åƒé—®å¤§æ¨¡å‹æŠ€æœ¯ç ”å‘ï¼Œè½»é‡é«˜æ•ˆï¼Œæ”¯æŒä¸­æ–‡è¯­ä¹‰ç²¾å‡†æ•æ‰ï¼Œé€‚åˆä¸­å°å‹RAGé¡¹ç›®ã€‚

**å‰ç½®å‡†å¤‡**

é¦–å…ˆå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„æ ¸å¿ƒä¾èµ–åŒ…ï¼Œç¡®ä¿LangChainç›¸å…³ç»„ä»¶å®Œæ•´æ€§ï¼ˆ1.xç‰ˆæœ¬æ‹†åˆ†äº†å¤šä¸ªå­åŒ…ï¼Œéœ€å®Œæ•´å®‰è£…ï¼‰ï¼š

```bash
pip install -U langchain langchain-core langchain-community langchain-openai faiss-cpu transformers torch python-dotenv
```

è¯´æ˜ï¼š`langchain-core`æ˜¯LCELçš„æ ¸å¿ƒä¾èµ–ï¼Œ`langchain-community`æä¾›å‘é‡åº“ã€æœ¬åœ°åµŒå…¥æ¨¡å‹ç­‰ç¤¾åŒºç»„ä»¶ï¼Œç¼ºä¸€ä¸å¯ã€‚

#### 4.4.3.2 å‘é‡æ•°æ®åº“é€‰æ‹©ï¼šfaissï¼ˆè½»é‡æ˜“ä¸Šæ‰‹ï¼‰

å‘é‡éœ€è¦å­˜åœ¨ä¸“é—¨çš„å‘é‡æ•°æ®åº“é‡Œï¼Œæ–¹ä¾¿åç»­å¿«é€Ÿæ£€ç´¢ã€‚LangChainæ”¯æŒå¾ˆå¤šå‘é‡æ•°æ®åº“ï¼Œæ¯”å¦‚FAISSã€Chromaã€Pineconeç­‰ã€‚å’±ä»¬é€‰FAISSâ€”â€”å®ƒæ˜¯Metaå¼€æºçš„è½»é‡çº§å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒé«˜æ•ˆçš„ç›¸ä¼¼æ€§æ£€ç´¢ï¼Œä¸éœ€è¦å•ç‹¬éƒ¨ç½²æœåŠ¡ï¼Œç›´æ¥åœ¨ä»£ç é‡Œåˆå§‹åŒ–å°±èƒ½ç”¨ï¼ŒåŒæ—¶å…¼å®¹å¤šç§åµŒå…¥æ¨¡å‹ï¼Œç‰¹åˆ«é€‚åˆåˆå­¦è€…å’Œå°å‹é¡¹ç›®ã€‚

> å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£å‘é‡æ•°æ®åº“ç›¸å…³çŸ¥è¯†ï¼Œå¯å­¦ä¹ datawhaleç¤¾åŒºã€Šeasy-vectordbã€‹ç›¸å…³å†…å®¹ã€‚é“¾æ¥ï¼šhttps://github.com/datawhalechina/easy-vectordb

#### 4.4.3.3 å®æ“ï¼šæ–‡æœ¬åµŒå…¥ä¸å‘é‡å­˜å‚¨å®Œæ•´æµç¨‹

æµç¨‹ï¼šåŠ è½½æ–‡æ¡£â†’åˆ†å‰²æ–‡æœ¬â†’åˆå§‹åŒ–åµŒå…¥æ¨¡å‹â†’åˆå§‹åŒ–å‘é‡æ•°æ®åº“â†’å°†åˆ†å‰²åçš„æ–‡æœ¬åµŒå…¥å¹¶å­˜å‚¨ã€‚

qwen3-embedding-0.6bæ˜¯ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒè½»é‡çš„åµŒå…¥æ¨¡å‹ï¼Œå› æ­¤æœ¬èŠ‚çš„æ•™ç¨‹æ¨èå¤§å®¶ä½¿ç”¨åŸç”Ÿå¯¼å…¥ã€‚åœ°å€ï¼šhttps://www.modelscope.cn/models/Qwen/Qwen3-Embedding-0.6B

```python
#æ¨¡å‹ä¸‹è½½
from modelscope import snapshot_download
model_dir = snapshot_download('Qwen/Qwen3-Embedding-0.6B',cache_dir='./models')
```

å®è·µä»£ç 

```python
import os
from dotenv import load_dotenv
from langchain_community.document_loaders import TextLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_core.documents import Document
from langchain_huggingface import HuggingFaceEmbeddings

txt_path = os.path.join("knowledge_base", "test.txt")
if not os.path.exists(txt_path):
    raise FileNotFoundError(f"æ–‡æ¡£æ–‡ä»¶ä¸å­˜åœ¨ï¼š{txt_path}")

# åŠ è½½æ–‡æœ¬æ–‡æ¡£
loader = TextLoader(txt_path, encoding="utf-8")
txt_docs: list[Document] = loader.load()

# æ–‡æœ¬åˆ†å‰²ï¼ˆä½¿ç”¨æœ€æ–°çš„ RecursiveCharacterTextSplitter é…ç½®ï¼‰
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=300,          # æ¯ä¸ªæ–‡æœ¬å—çš„å¤§å°
    chunk_overlap=50,        # å—ä¹‹é—´çš„é‡å é•¿åº¦ï¼ˆæå‡ä¸Šä¸‹æ–‡è¿ç»­æ€§ï¼‰
    length_function=len,     # é•¿åº¦è®¡ç®—å‡½æ•°ï¼ˆä¸­æ–‡ç”¨lenå³å¯ï¼‰
    is_separator_regex=False # æ˜¾å¼æŒ‡å®šéæ­£åˆ™åˆ†éš”ç¬¦ï¼ˆé»˜è®¤å€¼ï¼Œå¢åŠ å¯è¯»æ€§ï¼‰
)
split_docs: list[Document] = text_splitter.split_documents(txt_docs)
print(f"åˆ†å‰²åçš„æ–‡æœ¬ç‰‡æ®µæ•°ï¼š{len(split_docs)}")

# 3. åˆå§‹åŒ–æœ¬åœ°CPUè¿è¡Œçš„åµŒå…¥æ¨¡å‹ï¼ˆæ›¿æ¢QwenEmbeddingsï¼‰
embedding_model_name = "./models/Qwen/Qwen3-Embedding-0___6B"

embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_name,
    model_kwargs={
        "device": "cpu"  # å¼ºåˆ¶ä½¿ç”¨CPUè¿è¡Œï¼Œæ— éœ€GPU
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢æ•ˆæœ
    }
)

# 4. æ„å»ºå¹¶æŒä¹…åŒ–FAISSå‘é‡åº“
try:
    # ç”Ÿæˆå‘é‡å¹¶åˆå§‹åŒ–FAISSï¼ˆæœ¬åœ°CPUè®¡ç®—ï¼Œé¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹ï¼Œéœ€è”ç½‘ï¼‰
    vector_db = FAISS.from_documents(
        documents=split_docs,
        embedding=embeddings,
    )

    # æŒä¹…åŒ–å‘é‡åº“åˆ°æœ¬åœ°
    vector_db.save_local(
        folder_path="./faiss_db",
        index_name="local_cpu_faiss_index"  # ç´¢å¼•åæ”¹ä¸ºæœ¬åœ°CPUç‰ˆ
    )
    print("å‘é‡å­˜å‚¨å®Œæˆï¼å‘é‡æ•°æ®å·²ä¿å­˜åˆ° ./faiss_db æ–‡ä»¶å¤¹")
except Exception as e:
    raise RuntimeError(f"æ„å»º/ä¿å­˜å‘é‡åº“å¤±è´¥ï¼š{str(e)}")

# 5. ç›¸ä¼¼æ€§æ£€ç´¢æµ‹è¯•
query = "LangChainçš„é“¾å¼å·¥ä½œæµæœ‰å“ªäº›ç±»å‹ï¼Ÿ"
try:
    # ä¸€æ¬¡æ€§è·å–å¸¦è¯„åˆ†çš„æ£€ç´¢ç»“æœ
    retrieved_docs_with_scores = vector_db.similarity_search_with_score(query, k=3)
    
    print(f"\nä¸é—®é¢˜ã€Œ{query}ã€æœ€ç›¸å…³çš„3ä¸ªæ–‡æœ¬ç‰‡æ®µï¼š")
    for i, (doc, score) in enumerate(retrieved_docs_with_scores):
        print(f"\nç‰‡æ®µ{i+1}ï¼š")
        print(f"å†…å®¹ï¼š{doc.page_content}")
        print(f"ç›¸å…³æ€§è¯„åˆ†ï¼ˆè¶Šå°è¶Šç›¸ä¼¼ï¼‰ï¼š{round(score, 4)}")
        print(f"æ¥æºï¼š{doc.metadata.get('source', 'æœªçŸ¥')}")
except Exception as e:
    raise RuntimeError(f"æ£€ç´¢å‘é‡åº“å¤±è´¥ï¼š{str(e)}")
```

### 4.4.4 æ£€ç´¢å™¨é…ç½®ä¸æ£€ç´¢ç­–ç•¥ä¼˜åŒ–

å‘é‡å­˜å‚¨å¥½åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ã€Œæ£€ç´¢ã€â€”â€”ç”¨æˆ·æé—®æ—¶ï¼Œä»å‘é‡æ•°æ®åº“é‡Œæ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡æœ¬ç‰‡æ®µã€‚LangChainçš„ã€Œæ£€ç´¢å™¨ã€ï¼ˆRetrieverï¼‰å°±æ˜¯å¹²è¿™ä¸ªæ´»çš„ï¼Œå®ƒå°è£…äº†æ£€ç´¢é€»è¾‘ï¼Œè¿˜æ”¯æŒå¤šç§æ£€ç´¢ç­–ç•¥ï¼Œèƒ½æå‡æ£€ç´¢ç²¾åº¦ã€‚

#### 4.4.4.1 åŸºç¡€æ£€ç´¢å™¨ï¼šFAISSRetriever

ç›´æ¥ä»FAISSå‘é‡æ•°æ®åº“åˆ›å»ºæ£€ç´¢å™¨ï¼Œæœ€åŸºç¡€çš„æ£€ç´¢æ–¹å¼ï¼Œæ”¯æŒç›¸ä¼¼æ€§æ£€ç´¢ã€‚

```python
import os
from langchain_community.vectorstores import FAISS
from langchain_huggingface import HuggingFaceEmbeddings
from langchain_core.retrievers import BaseRetriever
from langchain_core.documents import Document

# æœ¬åœ°QwenåµŒå…¥æ¨¡å‹è·¯å¾„
embedding_model_name = "./models/Qwen/Qwen3-Embedding-0___6B"

# åˆå§‹åŒ–æœ¬åœ°CPUè¿è¡Œçš„åµŒå…¥æ¨¡å‹
embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_name,
    model_kwargs={
        "device": "cpu"  # å¼ºåˆ¶ä½¿ç”¨CPUè¿è¡Œ
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢æ•ˆæœ
    }
)

# åŠ è½½å·²æœ‰çš„FAISSå‘é‡æ•°æ®åº“
try:
    vector_db = FAISS.load_local(
        folder_path="./faiss_db",  # ä¹‹å‰çš„æŒä¹…åŒ–è·¯å¾„
        embeddings=embeddings,
        allow_dangerous_deserialization=True, 
        index_name="local_cpu_faiss_index"
    )
    print("FAISSå‘é‡åº“åŠ è½½æˆåŠŸï¼")
except FileNotFoundError:
    raise FileNotFoundError("æœªæ‰¾åˆ° ./faiss_db æ–‡ä»¶å¤¹ï¼Œè¯·ç¡®è®¤å‘é‡åº“å·²æ­£ç¡®ä¿å­˜")
except Exception as e:
    raise RuntimeError(f"åŠ è½½FAISSå‘é‡åº“å¤±è´¥ï¼š{str(e)}")

# åˆ›å»ºæ£€ç´¢å™¨ï¼ˆv0.1+ è§„èŒƒï¼‰
retriever: BaseRetriever = vector_db.as_retriever(
    search_kwargs={"k": 3},  # æ¯æ¬¡æ£€ç´¢è¿”å›3ä¸ªæœ€ç›¸å…³çš„ç‰‡æ®µ
    # å¯é€‰ï¼šæŒ‰åˆ†æ•°é˜ˆå€¼æ£€ç´¢ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
    # search_type="similarity_score_threshold",
    # search_kwargs={"k": 3, "score_threshold": 0.5}
)

# æµ‹è¯•æ£€ç´¢
query = "LangChainçš„SequentialChainæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"
try:
    # æ ¸å¿ƒä¿®æ”¹ï¼šæ›¿æ¢ get_relevant_documents â†’ invokeï¼ˆRunnableæ¥å£æ ‡å‡†ï¼‰
    retrieved_docs: list[Document] = retriever.invoke(query)

    print(f"\næ£€ç´¢åˆ°çš„ç›¸å…³ç‰‡æ®µï¼ˆ{len(retrieved_docs)}ä¸ªï¼‰ï¼š")
    for i, doc in enumerate(retrieved_docs):
        print(f"\nç‰‡æ®µ{i+1}ï¼š")
        print(f"å†…å®¹ï¼š{doc.page_content}")
        print(f"æ¥æºæ–‡ä»¶ï¼š{doc.metadata.get('source', 'æœªçŸ¥')}")

    # å¦‚éœ€è·å–æ£€ç´¢è¯„åˆ†ï¼ˆè¡¥å……å®Œæ•´å¯è¿è¡Œçš„è¯„åˆ†è·å–é€»è¾‘ï¼‰
    print("\n===== å¸¦è¯„åˆ†çš„æ£€ç´¢ç»“æœ =====")
    docs_with_scores = vector_db.similarity_search_with_score(query, k=3)
    for i, (doc, score) in enumerate(docs_with_scores):
        print(f"\nç‰‡æ®µ{i+1}ï¼ˆç›¸å…³æ€§è¯„åˆ†ï¼š{round(score, 4)}ï¼‰ï¼š")
        print(f"å†…å®¹ï¼š{doc.page_content}")
        
except Exception as e:
    raise RuntimeError(f"æ£€ç´¢å‘é‡åº“å¤±è´¥ï¼š{str(e)}")
```

æ£€ç´¢å™¨çš„ä¼˜åŠ¿ï¼šå¯ä»¥ç›´æ¥å’ŒLangChainçš„é“¾ç»“åˆï¼ˆæ¯”å¦‚åç»­çš„æ£€ç´¢-ç”Ÿæˆé“¾ï¼‰ï¼Œä¸ç”¨å•ç‹¬å†™æ£€ç´¢é€»è¾‘ï¼Œç®€åŒ–ä»£ç ã€‚

#### 4.4.4.2 è¿›é˜¶æ£€ç´¢ç­–ç•¥ï¼šç›¸ä¼¼æ€§æ£€ç´¢ vs MMRæ£€ç´¢

åŸºç¡€çš„ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆSimilarity Searchï¼‰å¯èƒ½ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ£€ç´¢åˆ°çš„ç‰‡æ®µå†…å®¹å¤ªç›¸ä¼¼ï¼Œå¯¼è‡´ä¿¡æ¯å†—ä½™ã€‚

è€ŒMMRï¼ˆMaximum Marginal Relevanceï¼Œæœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼‰æ£€ç´¢èƒ½è§£å†³è¿™ä¸ªé—®é¢˜â€”â€”åœ¨ä¿è¯ç›¸å…³æ€§çš„åŒæ—¶ï¼Œå°½é‡é€‰æ‹©å¤šæ ·åŒ–çš„ç‰‡æ®µï¼Œé¿å…å†—ä½™ã€‚

æ¯”å¦‚ä½ é—®â€œLangChainçš„é“¾æœ‰å“ªäº›ï¼Ÿâ€ï¼Œç›¸ä¼¼æ€§æ£€ç´¢å¯èƒ½è¿”å›3ä¸ªéƒ½è®²çº¿æ€§é“¾çš„ç‰‡æ®µï¼›è€ŒMMRæ£€ç´¢ä¼šè¿”å›1ä¸ªçº¿æ€§é“¾ã€1ä¸ªè·¯ç”±é“¾ã€1ä¸ªå¹¶è¡Œé“¾çš„ç‰‡æ®µï¼Œä¿¡æ¯æ›´å…¨é¢ã€‚

```python
import os
from langchain_community.vectorstores import FAISS  # v0.1+ æ­£ç¡®å¯¼å…¥è·¯å¾„
from langchain_huggingface import HuggingFaceEmbeddings  # æœ¬åœ°æ¨¡å‹ç”¨è¿™ä¸ª
from langchain_core.retrievers import BaseRetriever
from langchain_core.documents import Document

# 1. é…ç½®æœ¬åœ°QwenåµŒå…¥æ¨¡å‹ï¼ˆæ›¿æ¢åŸAPIç‰ˆQwenEmbeddingsï¼‰
embedding_model_name = "./models/Qwen/Qwen3-Embedding-0___6B"

# åˆå§‹åŒ–æœ¬åœ°CPUè¿è¡Œçš„åµŒå…¥æ¨¡å‹
embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_name,
    model_kwargs={
        "device": "cpu",  # å¼ºåˆ¶CPUè¿è¡Œï¼Œæ— éœ€GPU
        # å¦‚éœ€åŠ è½½é‡åŒ–æ¨¡å‹ï¼Œå¯æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆæŒ‰éœ€ï¼‰
        # "trust_remote_code": True,
        # "load_in_8bit": False
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢æ•ˆæœ
    }
)

# 2. åŠ è½½FAISSå‘é‡æ•°æ®åº“
try:
    vector_db = FAISS.load_local(
        folder_path="./faiss_db",
        embeddings=embeddings,
        allow_dangerous_deserialization=True,
        index_name="local_cpu_faiss_index"  # éœ€å’Œä¿å­˜æ—¶çš„ç´¢å¼•åä¸€è‡´
    )
    print("FAISSå‘é‡åº“åŠ è½½æˆåŠŸï¼")
except FileNotFoundError:
    raise FileNotFoundError("æœªæ‰¾åˆ° ./faiss_db æ–‡ä»¶å¤¹ï¼Œè¯·ç¡®è®¤å‘é‡åº“å·²æ­£ç¡®ä¿å­˜")
except Exception as e:
    raise RuntimeError(f"åŠ è½½FAISSå‘é‡åº“å¤±è´¥ï¼š{str(e)}")

# 3. åˆ›å»ºä¸åŒç±»å‹çš„æ£€ç´¢å™¨ï¼ˆä¿ç•™ç›¸ä¼¼æ€§+MMRå¯¹æ¯”ï¼‰
# 3.1 ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆé»˜è®¤ï¼‰
retriever_similar: BaseRetriever = vector_db.as_retriever(
    search_type="similarity",  # æ£€ç´¢ç±»å‹ï¼šçº¯ç›¸ä¼¼æ€§
    search_kwargs={"k": 3}     # è¿”å›3ä¸ªæœ€ç›¸ä¼¼çš„ç‰‡æ®µ
)

# 3.2 MMRæ£€ç´¢ï¼ˆæœ€å¤§åŒ–è¾¹é™…ç›¸å…³æ€§ï¼Œå…¼é¡¾ç›¸å…³æ€§å’Œå¤šæ ·æ€§ï¼‰
retriever_mmr: BaseRetriever = vector_db.as_retriever(
    search_type="mmr",  # æ£€ç´¢ç±»å‹ï¼šMMR
    search_kwargs={
        "k": 3,         # æœ€ç»ˆè¿”å›3ä¸ªç‰‡æ®µ
        "fetch_k": 10,  # å…ˆæ£€ç´¢10ä¸ªæœ€ç›¸å…³çš„ï¼Œå†ä»ä¸­é€‰å¤šæ ·åŒ–çš„
        "lambda_mult": 0.5  # æƒé‡ï¼š0=åªçœ‹å¤šæ ·æ€§ï¼Œ1=åªçœ‹ç›¸å…³æ€§ï¼Œ0.5å¹³è¡¡
    }
)

# 4. æµ‹è¯•å¯¹æ¯”ä¸¤ç§æ£€ç´¢æ–¹å¼ï¼ˆé€‚é…v0.1+çš„invokeæ–¹æ³•ï¼‰
query = "LangChainçš„é“¾æœ‰å“ªäº›ç±»å‹ï¼Ÿ"

# 4.1 ç›¸ä¼¼æ€§æ£€ç´¢æµ‹è¯•
print("=== ç›¸ä¼¼æ€§æ£€ç´¢ç»“æœ ===")
try:
    similar_docs: list[Document] = retriever_similar.invoke(query)  # æ›¿æ¢get_relevant_documents
    for i, doc in enumerate(similar_docs):
        print(f"\nç‰‡æ®µ{i+1}ï¼š{doc.page_content[:100]}...")
        print(f"æ¥æºæ–‡ä»¶ï¼š{doc.metadata.get('source', 'æœªçŸ¥')}")
except Exception as e:
    raise RuntimeError(f"ç›¸ä¼¼æ€§æ£€ç´¢å¤±è´¥ï¼š{str(e)}")

# 4.2 MMRæ£€ç´¢æµ‹è¯•
print("\n=== MMRæ£€ç´¢ç»“æœ ===")
try:
    mmr_docs: list[Document] = retriever_mmr.invoke(query)  # æ›¿æ¢get_relevant_documents
    for i, doc in enumerate(mmr_docs):
        print(f"\nç‰‡æ®µ{i+1}ï¼š{doc.page_content[:100]}...")
        print(f"æ¥æºæ–‡ä»¶ï¼š{doc.metadata.get('source', 'æœªçŸ¥')}")
except Exception as e:
    raise RuntimeError(f"MMRæ£€ç´¢å¤±è´¥ï¼š{str(e)}")

# å¯é€‰ï¼šè¡¥å……MMRæ£€ç´¢çš„è¯„åˆ†å¯¹æ¯”ï¼ˆä¾¿äºç†è§£å·®å¼‚ï¼‰
print("\n===== ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆå¸¦è¯„åˆ†ï¼‰ =====")
similar_docs_with_score = vector_db.similarity_search_with_score(query, k=3)
for i, (doc, score) in enumerate(similar_docs_with_score):
    print(f"ç‰‡æ®µ{i+1}ï¼ˆè¯„åˆ†ï¼š{round(score,4)}ï¼‰ï¼š{doc.page_content[:80]}...")
```

>  å°æŠ€å·§ï¼šå¦‚æœä½ çš„çŸ¥è¯†åº“å†…å®¹æ¯”è¾ƒå•ä¸€ï¼Œç”¨ç›¸ä¼¼æ€§æ£€ç´¢å°±è¡Œï¼›å¦‚æœçŸ¥è¯†åº“å†…å®¹ä¸°å¯Œï¼Œéœ€è¦å…¨é¢çš„ä¿¡æ¯ï¼Œç”¨MMRæ£€ç´¢æ›´å¥½ã€‚lambda_multå‚æ•°å¯ä»¥è°ƒï¼Œæ¯”å¦‚0.7æ›´åå‘ç›¸å…³æ€§ï¼Œ0.3æ›´åå‘å¤šæ ·æ€§ã€‚

#### 4.4.4.3 å®æ“æ¡ˆä¾‹ï¼šæ£€ç´¢å™¨å‚æ•°é…ç½®ä¸æ£€ç´¢æ•ˆæœéªŒè¯

å’±ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´æ¡ˆä¾‹ï¼ŒéªŒè¯ä¸åŒæ£€ç´¢å™¨å‚æ•°å¯¹æ£€ç´¢æ•ˆæœçš„å½±å“ã€‚

**ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ä¸å‘é‡æ•°æ®åº“åŠ è½½**

æ²¿ç”¨ä¹‹å‰åˆ›å»ºçš„FAISSå‘é‡æ•°æ®åº“ï¼ˆä»¥qwen-embedding-0.6bä¸ºä¾‹ï¼‰ï¼Œå…ˆå®Œæˆç¯å¢ƒåˆå§‹åŒ–å’Œæ•°æ®åº“åŠ è½½ï¼š

```python
from langchain_community.vectorstores import FAISS
from langchain_huggingface import HuggingFaceEmbeddings

embedding_model_name = "./models/Qwen/Qwen3-Embedding-0___6B"

# åˆå§‹åŒ–æœ¬åœ°CPUè¿è¡Œçš„åµŒå…¥æ¨¡å‹
embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_name,
    model_kwargs={
        "device": "cpu",  # å¼ºåˆ¶CPUè¿è¡Œï¼Œæ— éœ€GPU
        # å¦‚éœ€åŠ è½½é‡åŒ–æ¨¡å‹ï¼Œå¯æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆæŒ‰éœ€ï¼‰
        # "trust_remote_code": True,
        # "load_in_8bit": False
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢æ•ˆæœ
    }
)

# åŠ è½½å·²æœ‰çš„FAISSå‘é‡æ•°æ®åº“
vector_db = FAISS.load_local(
    folder_path="./faiss_db",  # ä¹‹å‰å­˜å‚¨å‘é‡çš„è·¯å¾„
    embeddings=embeddings,
    allow_dangerous_deserialization=True
)
print("å‘é‡æ•°æ®åº“åŠ è½½æˆåŠŸï¼")
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®ä¸åŒå‚æ•°çš„æ£€ç´¢å™¨**

æˆ‘ä»¬é…ç½®4ç§ä¸åŒå‚æ•°çš„æ£€ç´¢å™¨ï¼Œåˆ†åˆ«éªŒè¯â€œè¿”å›æ•°é‡ï¼ˆkå€¼ï¼‰â€â€œæ£€ç´¢ç±»å‹ï¼ˆç›¸ä¼¼æ€§/MMRï¼‰â€â€œå¤šæ ·æ€§æƒé‡ï¼ˆlambda_multï¼‰â€å¯¹ç»“æœçš„å½±å“ï¼š

```python
retriever_similar_k2 = vector_db.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 2}
)

# 4.2 ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆk=5ï¼‰
retriever_similar_k5 = vector_db.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 5}
)

# 4.3 MMRæ£€ç´¢ï¼ˆåå‘ç›¸å…³æ€§ï¼Œlambda_mult=0.8ï¼‰
retriever_mmr_high_rel = vector_db.as_retriever(
    search_type="mmr",
    search_kwargs={"k": 3, "fetch_k": 10, "lambda_mult": 0.8}
)

# 4.4 MMRæ£€ç´¢ï¼ˆåå‘å¤šæ ·æ€§ï¼Œlambda_mult=0.3ï¼‰
retriever_mmr_high_div = vector_db.as_retriever(
    search_type="mmr",
    search_kwargs={"k": 3, "fetch_k": 10, "lambda_mult": 0.3}
)

# 5. å®šä¹‰æµ‹è¯•æŸ¥è¯¢å¹¶æ‰§è¡Œæ£€ç´¢ï¼ˆé€‚é…v0.1+ invokeæ–¹æ³•ï¼‰
test_query = "RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ"
```

**ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ£€ç´¢å¹¶å¯¹æ¯”ç»“æœ**

åˆ†åˆ«è°ƒç”¨4ä¸ªæ£€ç´¢å™¨ï¼Œæ‰“å°æ£€ç´¢ç»“æœï¼Œå¯¹æ¯”ä¸åŒå‚æ•°çš„æ•ˆæœå·®å¼‚ï¼š

```python
def test_retriever(retriever: BaseRetriever, retriever_name: str):
    """æµ‹è¯•æ£€ç´¢å™¨å¹¶æ‰“å°ç»“æœ"""
    try:
        # æ ¸å¿ƒé€‚é…ï¼šä½¿ç”¨invoke()æ›¿ä»£æ—§çš„get_relevant_documents()
        results: list[Document] = retriever.invoke(test_query)
        print(f"=== {retriever_name} æ£€ç´¢ç»“æœï¼ˆå…±{len(results)}æ¡ï¼‰ ===")
        for i, doc in enumerate(results):
            print(f"\n[{i+1}] å†…å®¹ï¼š{doc.page_content[:120]}...")
            print(f"   æ¥æºï¼š{doc.metadata.get('source', 'æœªçŸ¥')}")
        print("\n" + "-"*80 + "\n")
    except Exception as e:
        raise RuntimeError(f"{retriever_name} æ£€ç´¢å¤±è´¥ï¼š{str(e)}")

# æ‰§è¡Œæ‰€æœ‰æ£€ç´¢å¹¶æ‰“å°ç»“æœ
test_retriever(retriever_similar_k2, "ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆk=2ï¼‰")
test_retriever(retriever_similar_k5, "ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆk=5ï¼‰")
test_retriever(retriever_mmr_high_rel, "MMRæ£€ç´¢ï¼ˆåå‘ç›¸å…³æ€§ Î»=0.8ï¼‰")
test_retriever(retriever_mmr_high_div, "MMRæ£€ç´¢ï¼ˆåå‘å¤šæ ·æ€§ Î»=0.3ï¼‰")

# å¯é€‰ï¼šè¡¥å……ç›¸ä¼¼æ€§è¯„åˆ†å±•ç¤ºï¼ˆFAISSç‰¹æœ‰ï¼‰
print("=== ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆk=3ï¼‰å¸¦è¯„åˆ†ç»“æœ ===")
docs_with_scores = vector_db.similarity_search_with_score(test_query, k=3)
for i, (doc, score) in enumerate(docs_with_scores):
    print(f"\n[{i+1}] è¯„åˆ†ï¼š{round(score, 4)} | å†…å®¹ï¼š{doc.page_content[:80]}...")
```

**ç¬¬å››æ­¥ï¼šæ£€ç´¢ç»“æœåˆ†æä¸å‚æ•°é€‰æ‹©å»ºè®®**

è¿è¡Œä¸Šè¿°ä»£ç åï¼Œä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„ç»“æœï¼ˆå¿½è§†å†…å®¹éƒ¨åˆ†ï¼‰ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„çŸ¥è¯†åº“è‡ªå·±çš„é—®é¢˜æ¥æ¯”è¾ƒ

æˆ‘ä»¬ç»“åˆç»“æœåˆ†æå‚æ•°çš„å½±å“ï¼š

```text
å‘é‡æ•°æ®åº“åŠ è½½æˆåŠŸï¼

=== ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆk=2ï¼‰ æ£€ç´¢ç»“æœ ===

ç‰‡æ®µ1ï¼ˆå­—ç¬¦æ•°ï¼š286ï¼‰ï¼š
RAG çš„æ ¸å¿ƒä»·å€¼ï¼šæå‡åº”ç”¨å‡†ç¡®æ€§ã€æ‹“å±•çŸ¥è¯†è¾¹ç•Œã€é™ä½å¾®è°ƒæˆæœ¬
ç›¸æ¯”ç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹ï¼ŒRAGæœ‰ä¸‰ä¸ªæ ¸å¿ƒä»·å€¼ï¼Œä¹Ÿæ˜¯ä¼ä¸šä¸ºä»€ä¹ˆæ„¿æ„ç”¨RAGçš„åŸå› ï¼š1. æå‡å‡†ç¡®æ€§ï¼šç­”æ¡ˆåŸºäºçœŸå®çš„å‚è€ƒèµ„æ–™ï¼Œå¤§å¤§å‡å°‘äº‹å®æ€§é”™è¯¯ã€‚æ¯”å¦‚é—®å…¬å¸å†…éƒ¨æ”¿ç­–ï¼ŒRAGä¼šä»å…¬å¸æ–‡æ¡£ä¸­æ£€ç´¢å‡†ç¡®ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å¤§æ¨¡å‹çç¼–ï¼›2. æ‹“å±•çŸ¥è¯†è¾¹ç•Œï¼šå¤§æ¨¡å‹å¯ä»¥è·å–è®­ç»ƒæ•°æ®ä¹‹å¤–çš„çŸ¥è¯†...
ç›¸ä¼¼åº¦è¯„åˆ†ï¼š0.1862ï¼ˆè¶Šå°è¶Šç›¸å…³ï¼‰

ç‰‡æ®µ2ï¼ˆå­—ç¬¦æ•°ï¼š215ï¼‰ï¼š
1. æå‡å‡†ç¡®æ€§ï¼šç­”æ¡ˆåŸºäºçœŸå®çš„å‚è€ƒèµ„æ–™ï¼Œå¤§å¤§å‡å°‘äº‹å®æ€§é”™è¯¯ã€‚æ¯”å¦‚é—®å…¬å¸å†…éƒ¨æ”¿ç­–ï¼ŒRAGä¼šä»å…¬å¸æ–‡æ¡£ä¸­æ£€ç´¢å‡†ç¡®ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å¤§æ¨¡å‹çç¼–ï¼›2. æ‹“å±•çŸ¥è¯†è¾¹ç•Œï¼šå¤§æ¨¡å‹å¯ä»¥è·å–è®­ç»ƒæ•°æ®ä¹‹å¤–çš„çŸ¥è¯†ï¼ŒåŒ…æ‹¬æœ€æ–°ä¿¡æ¯ï¼ˆæ¯”å¦‚2025å¹´çš„è¡Œä¸šæ•°æ®ï¼‰å’Œç§æœ‰ä¿¡æ¯ï¼ˆæ¯”å¦‚å…¬å¸å†…éƒ¨æ–‡æ¡£ã€å®¢æˆ·èµ„æ–™ï¼‰ï¼›3. é™ä½æˆæœ¬ï¼šæ›´æ–°çŸ¥è¯†ä¸éœ€è¦é‡æ–°è®­ç»ƒå¤§æ¨¡å‹ï¼ˆå¾®è°ƒæˆæœ¬å¾ˆé«˜ï¼ŒåŠ¨è¾„å‡ åä¸‡ï¼‰...
ç›¸ä¼¼åº¦è¯„åˆ†ï¼š0.1987ï¼ˆè¶Šå°è¶Šç›¸å…³ï¼‰

=== ç›¸ä¼¼æ€§æ£€ç´¢ï¼ˆk=5ï¼‰ æ£€ç´¢ç»“æœ ===
ï¼ˆå‰2ä¸ªç‰‡æ®µä¸ä¸Šè¿°ä¸€è‡´ï¼Œæ–°å¢3ä¸ªç›¸å…³æ€§è¾ƒä½çš„ç‰‡æ®µï¼‰
ç‰‡æ®µ3ï¼ˆå­—ç¬¦æ•°ï¼š198ï¼‰ï¼š
RAGçš„å…¨ç§°æ˜¯Retrieval-Augmented Generationï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼Œæ ¸å¿ƒé€»è¾‘è¶…ç®€å•ï¼šåœ¨å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆä¹‹å‰ï¼Œå…ˆä»å¤–éƒ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³çš„çœŸå®ã€æœ€æ–°ä¿¡æ¯ï¼ŒæŠŠè¿™äº›ä¿¡æ¯ä½œä¸ºâ€œå‚è€ƒèµ„æ–™â€ä¼ ç»™å¤§æ¨¡å‹ï¼Œè®©å¤§æ¨¡å‹åŸºäºå‚è€ƒèµ„æ–™ç”Ÿæˆç­”æ¡ˆã€‚
ç›¸ä¼¼åº¦è¯„åˆ†ï¼š0.2345
...

=== MMRæ£€ç´¢ï¼ˆåå‘ç›¸å…³æ€§ï¼Œlambda=0.8ï¼‰ æ£€ç´¢ç»“æœ ===

ç‰‡æ®µ1ï¼ˆå­—ç¬¦æ•°ï¼š286ï¼‰ï¼š
RAG çš„æ ¸å¿ƒä»·å€¼ï¼šæå‡åº”ç”¨å‡†ç¡®æ€§ã€æ‹“å±•çŸ¥è¯†è¾¹ç•Œã€é™ä½å¾®è°ƒæˆæœ¬
ç›¸æ¯”ç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹ï¼ŒRAGæœ‰ä¸‰ä¸ªæ ¸å¿ƒä»·å€¼ï¼Œä¹Ÿæ˜¯ä¼ä¸šä¸ºä»€ä¹ˆæ„¿æ„ç”¨RAGçš„åŸå› ï¼š1. æå‡å‡†ç¡®æ€§ï¼šç­”æ¡ˆåŸºäºçœŸå®çš„å‚è€ƒèµ„æ–™ï¼Œå¤§å¤§å‡å°‘äº‹å®æ€§é”™è¯¯ã€‚æ¯”å¦‚é—®å…¬å¸å†…éƒ¨æ”¿ç­–ï¼ŒRAGä¼šä»å…¬å¸æ–‡æ¡£ä¸­æ£€ç´¢å‡†ç¡®ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å¤§æ¨¡å‹çç¼–ï¼›2. æ‹“å±•çŸ¥è¯†è¾¹ç•Œï¼šå¤§æ¨¡å‹å¯ä»¥è·å–è®­ç»ƒæ•°æ®ä¹‹å¤–çš„çŸ¥è¯†...

ç‰‡æ®µ2ï¼ˆå­—ç¬¦æ•°ï¼š198ï¼‰ï¼š
RAGçš„å…¨ç§°æ˜¯Retrieval-Augmented Generationï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼Œæ ¸å¿ƒé€»è¾‘è¶…ç®€å•ï¼šåœ¨å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆä¹‹å‰ï¼Œå…ˆä»å¤–éƒ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³çš„çœŸå®ã€æœ€æ–°ä¿¡æ¯ï¼ŒæŠŠè¿™äº›ä¿¡æ¯ä½œä¸ºâ€œå‚è€ƒèµ„æ–™â€ä¼ ç»™å¤§æ¨¡å‹ï¼Œè®©å¤§æ¨¡å‹åŸºäºå‚è€ƒèµ„æ–™ç”Ÿæˆç­”æ¡ˆã€‚

ç‰‡æ®µ3ï¼ˆå­—ç¬¦æ•°ï¼š182ï¼‰ï¼š
å¤§æ¨¡å‹çš„ä¸¤ä¸ªè‡´å‘½ç¼ºç‚¹ï¼Œè®©å®ƒåœ¨ä¼ä¸šçº§åº”ç”¨ä¸­â€œå¯¸æ­¥éš¾è¡Œâ€ï¼š1. çŸ¥è¯†æ»åï¼šå¤§æ¨¡å‹çš„çŸ¥è¯†æˆªæ­¢äºè®­ç»ƒæ•°æ®çš„æ—¶é—´ï¼Œæ¯”å¦‚2023å¹´è®­ç»ƒçš„æ¨¡å‹ï¼Œä¸çŸ¥é“2024å¹´ä¹‹åå‘ç”Ÿçš„äº‹ã€‚å°±åƒä¸€ä¸ªäººå¾ˆä¹…æ²¡ä¸Šç½‘ï¼Œä¸çŸ¥é“æœ€æ–°çš„çƒ­ç‚¹æ–°é—»ï¼›2. äº‹å®æ€§é”™è¯¯ï¼ˆå¹»è§‰ï¼‰ï¼šå¤§æ¨¡å‹ä¼šâ€œä¸€æœ¬æ­£ç»åœ°èƒ¡è¯´å…«é“â€...

=== MMRæ£€ç´¢ï¼ˆåå‘å¤šæ ·æ€§ï¼Œlambda=0.3ï¼‰ æ£€ç´¢ç»“æœ ===

ç‰‡æ®µ1ï¼ˆå­—ç¬¦æ•°ï¼š286ï¼‰ï¼š
RAG çš„æ ¸å¿ƒä»·å€¼ï¼šæå‡åº”ç”¨å‡†ç¡®æ€§ã€æ‹“å±•çŸ¥è¯†è¾¹ç•Œã€é™ä½å¾®è°ƒæˆæœ¬
ç›¸æ¯”ç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹ï¼ŒRAGæœ‰ä¸‰ä¸ªæ ¸å¿ƒä»·å€¼ï¼Œä¹Ÿæ˜¯ä¼ä¸šä¸ºä»€ä¹ˆæ„¿æ„ç”¨RAGçš„åŸå› ï¼š1. æå‡å‡†ç¡®æ€§ï¼šç­”æ¡ˆåŸºäºçœŸå®çš„å‚è€ƒèµ„æ–™ï¼Œå¤§å¤§å‡å°‘äº‹å®æ€§é”™è¯¯ã€‚æ¯”å¦‚é—®å…¬å¸å†…éƒ¨æ”¿ç­–ï¼ŒRAGä¼šä»å…¬å¸æ–‡æ¡£ä¸­æ£€ç´¢å‡†ç¡®ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å¤§æ¨¡å‹çç¼–ï¼›2. æ‹“å±•çŸ¥è¯†è¾¹ç•Œï¼šå¤§æ¨¡å‹å¯ä»¥è·å–è®­ç»ƒæ•°æ®ä¹‹å¤–çš„çŸ¥è¯†...

ç‰‡æ®µ2ï¼ˆå­—ç¬¦æ•°ï¼š175ï¼‰ï¼š
RAGé€‚ç”¨åœºæ™¯ä¸ä¸é€‚ç”¨åœºæ™¯è¾¨æ
RAGä¸æ˜¯ä¸‡èƒ½çš„ï¼Œè¦æ ¹æ®åœºæ™¯é€‰æ‹©æ˜¯å¦ä½¿ç”¨ã€‚ä¸‹é¢åˆ—å‡ºé€‚ç”¨å’Œä¸é€‚ç”¨çš„åœºæ™¯ï¼Œå¸®å¤§å®¶é¿å‘ï¼šé€‚ç”¨åœºæ™¯ï¼š1. ä¼ä¸šå†…éƒ¨çŸ¥è¯†åº“é—®ç­”ï¼ˆæ¯”å¦‚å‘˜å·¥æ‰‹å†Œã€äº§å“æ–‡æ¡£ã€æŠ€æœ¯æ‰‹å†Œï¼‰ï¼›2. è¡Œä¸šæŠ¥å‘Š/æ”¿ç­–æ–‡ä»¶é—®ç­”...

ç‰‡æ®µ3ï¼ˆå­—ç¬¦æ•°ï¼š168ï¼‰ï¼š
å‘é‡å­˜å‚¨ä¸åµŒå…¥ï¼ˆVector Storage & Embeddingï¼‰ï¼šç»™æ–‡æœ¬åšâ€œæ•°å­—æŒ‡çº¹â€
åˆ†å‰²å®Œæ–‡æœ¬ç‰‡æ®µåï¼Œä¸‹ä¸€æ­¥è¦åšçš„æ˜¯ã€Œå‘é‡åµŒå…¥ã€å’Œã€Œå‘é‡å­˜å‚¨ã€ã€‚è¿™ä¸€æ­¥æ˜¯RAGèƒ½å®ç°â€œç²¾å‡†æ£€ç´¢â€çš„æ ¸å¿ƒâ€”â€”æŠŠæ–‡å­—å˜æˆè®¡ç®—æœºèƒ½ç†è§£çš„â€œæ•°å­—â€ï¼Œå†å­˜åˆ°ä¸“é—¨çš„å‘é‡æ•°æ®åº“é‡Œ...
```

åŸºäºç»“æœï¼Œæ€»ç»“å‚æ•°é€‰æ‹©å»ºè®®ï¼š

- **kå€¼ï¼ˆè¿”å›æ•°é‡ï¼‰**ï¼šä¸å®œè¿‡å¤§æˆ–è¿‡å°ã€‚k=2-3é€‚åˆç²¾å‡†å®šä½æ ¸å¿ƒä¿¡æ¯ï¼Œé¿å…å†—ä½™ï¼›k=5åŠä»¥ä¸Šé€‚åˆéœ€è¦å…¨é¢ä¿¡æ¯è¦†ç›–çš„åœºæ™¯ï¼ˆæ¯”å¦‚å¤æ‚é—®é¢˜è§£ç­”ï¼‰ï¼Œä½†ä¼šå¼•å…¥ç›¸å…³æ€§è¾ƒä½çš„å†…å®¹ï¼Œå¢åŠ å¤§æ¨¡å‹å¤„ç†è´Ÿæ‹…ã€‚å®é™…åº”ç”¨ä¸­å»ºè®®k=3-4ã€‚
- **æ£€ç´¢ç±»å‹**ï¼šç®€å•é—®é¢˜ï¼ˆå¦‚â€œRAGæ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆâ€ï¼‰ç”¨ç›¸ä¼¼æ€§æ£€ç´¢å³å¯ï¼Œé«˜æ•ˆç²¾å‡†ï¼›å¤æ‚é—®é¢˜ï¼ˆå¦‚â€œå¯¹æ¯”RAGä¸å¾®è°ƒçš„ä¼˜åŠ£â€ï¼‰ç”¨MMRæ£€ç´¢ï¼Œèƒ½è·å–å¤šæ ·åŒ–ä¿¡æ¯ï¼Œé¿å…ä¿¡æ¯ç‰‡é¢ã€‚
- **lambda_multï¼ˆMMRå¤šæ ·æ€§æƒé‡ï¼‰**ï¼šæ ¸å¿ƒé—®é¢˜ä¼˜å…ˆä¿è¯ç›¸å…³æ€§ï¼Œå»ºè®®lambda_mult=0.7-0.8ï¼›éœ€è¦å¤šè§’åº¦åˆ†æçš„é—®é¢˜å¯é€‚å½“æå‡å¤šæ ·æ€§ï¼Œå»ºè®®lambda_mult=0.4-0.5ï¼›ä¸å»ºè®®ä½äº0.3ï¼Œå¦åˆ™ä¼šå¼•å…¥æ— å…³ä¿¡æ¯ã€‚

>  è¸©å‘æŒ‡å—ï¼šå‚æ•°æ²¡æœ‰â€œæœ€ä¼˜å€¼â€ï¼Œéœ€ç»“åˆçŸ¥è¯†åº“è§„æ¨¡å’Œä¸šåŠ¡åœºæ™¯è°ƒè¯•ï¼æ¯”å¦‚å°çŸ¥è¯†åº“ï¼ˆ100ä¸ªç‰‡æ®µä»¥å†…ï¼‰ï¼Œk=2å³å¯ï¼›å¤§çŸ¥è¯†åº“ï¼ˆ1000+ç‰‡æ®µï¼‰ï¼Œkå¯é€‚å½“å¢å¤§åˆ°4-5ï¼ŒåŒæ—¶ç”¨MMRæ£€ç´¢ä¿è¯ä¿¡æ¯å¤šæ ·æ€§ã€‚

### 4.4.5 æ£€ç´¢-ç”Ÿæˆï¼ˆRetrieval-Generationï¼‰å…¨æµç¨‹æ•´åˆ

å‰é¢æˆ‘ä»¬å·²ç»å®Œæˆäº†â€œæ–‡æ¡£åŠ è½½â†’æ–‡æœ¬åˆ†å‰²â†’å‘é‡å­˜å‚¨â†’æ£€ç´¢â€çš„æ‰€æœ‰ç¯èŠ‚ï¼Œæœ€åä¸€æ­¥æ˜¯â€œç”Ÿæˆâ€â€”â€”å°†æ£€ç´¢åˆ°çš„ç›¸å…³ç‰‡æ®µå’Œç”¨æˆ·é—®é¢˜ç»“åˆï¼Œä¼ ç»™å¤§æ¨¡å‹ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚åŸºäºLangChainæœ€æ–°æ¨èçš„LCELï¼ˆLangChain Expression Languageï¼‰é£æ ¼ï¼Œæˆ‘ä»¬é‡‡ç”¨FAISSå‘é‡æ•°æ®åº“å’Œæœ¬åœ°Qwen3åµŒå…¥æ¨¡å‹ï¼Œæ­å»ºç«¯åˆ°ç«¯çš„RAGé—®ç­”ç³»ç»Ÿã€‚

#### 4.4.5.1 æ ¸å¿ƒåŸç†ï¼šæ£€ç´¢ä¸ç”Ÿæˆçš„ååŒé€»è¾‘

æ ¸å¿ƒé€»è¾‘ï¼šç”¨æˆ·æé—®â†’æ£€ç´¢å™¨ä»FAISSå‘é‡æ•°æ®åº“è·å–ç›¸å…³ç‰‡æ®µâ†’å°†â€œç”¨æˆ·é—®é¢˜+ç›¸å…³ç‰‡æ®µâ€æŒ‰æŒ‡å®šè§„åˆ™æ‹¼æ¥â†’ä¼ ç»™å¤§æ¨¡å‹â†’å¤§æ¨¡å‹åŸºäºç›¸å…³ç‰‡æ®µç”Ÿæˆç­”æ¡ˆã€‚

LangChain 1.xç‰ˆæœ¬é€šè¿‡LCELå®ç°æ£€ç´¢ä¸ç”Ÿæˆçš„æ¨¡å—åŒ–ååŒï¼Œæ ¸å¿ƒä¼˜åŠ¿åœ¨äº**ç»„ä»¶åŒ–ä¸²è”**ä¸**æ•°æ®æµå¼ä¼ é€’**ï¼šæ— éœ€ä¾èµ–`create_retrieval_chain`ç­‰å°è£…å‡½æ•°ï¼Œç›´æ¥é€šè¿‡ç®¡é“ç¬¦ï¼ˆ|ï¼‰å°†æ£€ç´¢å™¨ã€æ–‡æ¡£æ ¼å¼åŒ–å‡½æ•°ã€æç¤ºè¯æ¨¡æ¿ã€å¤§æ¨¡å‹ã€è¾“å‡ºè§£æå™¨ç­‰ç»„ä»¶ä¸²è”æˆé“¾ã€‚æ•°æ®åœ¨é“¾ä¸­æŒ‰é¡ºåºæµè½¬ï¼Œä¸Šä¸€ä¸ªç»„ä»¶çš„è¾“å‡ºè‡ªåŠ¨ä½œä¸ºä¸‹ä¸€ä¸ªç»„ä»¶çš„è¾“å…¥ï¼Œæ—¢ç®€åŒ–äº†ä»£ç é€»è¾‘ï¼Œåˆæå‡äº†è‡ªå®šä¹‰çµæ´»æ€§ï¼ˆå¦‚å¯éšæ—¶æ’å…¥æ—¥å¿—ã€æ•°æ®è¿‡æ»¤ç­‰è‡ªå®šä¹‰ç»„ä»¶ï¼‰ã€‚

#### 4.4.5.2 å®æ“ï¼šå®Œæ•´RAGç³»ç»Ÿä»£ç å®ç°

åŸºäºå‰é¢æ„å»ºçš„FAISSå‘é‡æ•°æ®åº“å’Œæ£€ç´¢å™¨ï¼Œæ­å»ºç«¯åˆ°ç«¯çš„RAGé—®ç­”ç³»ç»Ÿï¼Œå…¨ç¨‹ä½¿ç”¨æœ¬åœ°CPUè¿è¡ŒåµŒå…¥æ¨¡å‹ï¼Œæ— éœ€GPUä¾èµ–ã€‚ä»¥ä¸‹æ˜¯LangChain 1.xç‰ˆæœ¬å®˜æ–¹æ¨èå†™æ³•ï¼š

**ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ä¸ç»„ä»¶åˆå§‹åŒ–**

```python
from langchain_community.vectorstores import FAISS
from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_openai import ChatOpenAI  # 1.xæ¨èç”¨ChatOpenAIï¼Œé€‚é…å¯¹è¯æ¨¡å‹ï¼ŒåŠŸèƒ½æ›´å…¨
from langchain_core.prompts import ChatPromptTemplate  # æ›¿ä»£PromptTemplateï¼Œé€‚é…LCEL
from langchain_core.runnables import RunnablePassthrough  # LCELæ ¸å¿ƒç»„ä»¶ï¼Œä¼ é€’æ•°æ®
from langchain_core.output_parsers import StrOutputParser  # ç»Ÿä¸€è¾“å‡ºæ ¼å¼è§£æ
from dotenv import load_dotenv
import os

# åŠ è½½å¹¶éªŒè¯ç¯å¢ƒå˜é‡ï¼ˆ1.xæ¨èæ˜¾å¼éªŒè¯ï¼Œé¿å…é…ç½®ç¼ºå¤±ï¼‰
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
if not api_key:
    raise ValueError("æœªæ‰¾åˆ°OPENAI_API_KEYç¯å¢ƒå˜é‡ï¼Œè¯·æ£€æŸ¥.envæ–‡ä»¶é…ç½®")

# 1. åˆå§‹åŒ–æœ¬åœ°CPUè¿è¡Œçš„Qwen3åµŒå…¥æ¨¡å‹ï¼ˆå‚æ•°å…¼å®¹1.xç‰ˆæœ¬ï¼Œä¿æŒåŸæ¨èé…ç½®ï¼‰
embedding_model_path = "./models/Qwen/Qwen3-Embedding-0___6B"
# éªŒè¯æ¨¡å‹è·¯å¾„æœ‰æ•ˆæ€§
if not os.path.exists(embedding_model_path):
    raise FileNotFoundError(f"Qwen3åµŒå…¥æ¨¡å‹è·¯å¾„ä¸å­˜åœ¨ï¼š{embedding_model_path}")

embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_path,
    model_kwargs={
        "device": "cpu",  # å¼ºåˆ¶CPUè¿è¡Œï¼Œæ— éœ€GPU
        "trust_remote_code": True,  # Qwen3æ¨¡å‹å¿…é€‰é…ç½®ï¼Œä¿¡ä»»è¿œç¨‹ä»£ç 
        # å¦‚éœ€åŠ è½½é‡åŒ–æ¨¡å‹ï¼Œå¯å¯ç”¨ä»¥ä¸‹é…ç½®ï¼ˆé™ä½å†…å­˜å ç”¨ï¼‰
        # "load_in_8bit": True,
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢ç›¸ä¼¼åº¦è®¡ç®—ç²¾åº¦
    }
)

# 2. åŠ è½½FAISSå‘é‡æ•°æ®åº“ï¼ˆ1.xç‰ˆæœ¬ç”¨æ³•å®Œå…¨å…¼å®¹ï¼Œä¿ç•™åŸé€»è¾‘ï¼‰
# æ³¨æ„ï¼šé¦–æ¬¡æ„å»ºæ—¶éœ€ç”¨FAISS.from_documents(docs, embeddings)åˆ›å»ºå¹¶save_local
vector_db = FAISS.load_local(
    folder_path="./faiss_db",
    embeddings=embeddings,
    allow_dangerous_deserialization=True  # æœ¬åœ°å¼€å‘å¯ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…ï¼ˆå­˜åœ¨å®‰å…¨é£é™©ï¼‰
)

# 3. åˆå§‹åŒ–æ£€ç´¢å™¨ï¼ˆMMRç­–ç•¥ï¼Œå¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§ï¼Œå‚æ•°æ— å˜åŒ–ï¼‰
retriever = vector_db.as_retriever(
    search_type="mmr",
    search_kwargs={"k": 3, "fetch_k": 10, "lambda_mult": 0.7}
)

# 4. åˆå§‹åŒ–å¤§æ¨¡å‹ï¼ˆ1.xæ¨èç”¨ChatOpenAIï¼Œæ”¯æŒæ›´ä¸°å¯Œçš„å¯¹è¯é…ç½®ï¼‰
llm = ChatOpenAI(
    api_key=api_key,
    temperature=0.3,  # ä½æ¸©åº¦ä¿è¯ç­”æ¡ˆç²¾å‡†ï¼Œå‡å°‘å¹»è§‰
    timeout=30,  # æ–°å¢è¶…æ—¶é…ç½®ï¼Œé¿å…è¯·æ±‚æŒ‚èµ·ï¼ˆ1.xå®˜æ–¹æ¨èï¼‰
    max_retries=2  # ç½‘ç»œæ³¢åŠ¨æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæå‡ç¨³å®šæ€§
)
```

**ç¬¬äºŒæ­¥ï¼šç”¨LCELæ„å»ºæ£€ç´¢-ç”Ÿæˆé“¾ï¼ˆæœ€æ–°æ¨èå†™æ³•ï¼‰**

é€šè¿‡LCELç®¡é“ç¬¦ï¼ˆ|ï¼‰ä¸²è”ç»„ä»¶ï¼Œé€»è¾‘æ›´æ¸…æ™°ã€è‡ªå®šä¹‰æ€§æ›´å¼ºã€‚æ ¸å¿ƒæ­¥éª¤ï¼šæ ¼å¼åŒ–æ£€ç´¢æ–‡æ¡£â†’æ‹¼æ¥æç¤ºè¯â†’å¤§æ¨¡å‹ç”Ÿæˆâ†’è§£æè¾“å‡ºã€‚

```python
# 1. è‡ªå®šä¹‰æ–‡æ¡£æ ¼å¼åŒ–å‡½æ•°ï¼ˆå°†æ£€ç´¢åˆ°çš„å¤šä¸ªæ–‡æ¡£æ‹¼æ¥ä¸ºç»Ÿä¸€æ–‡æœ¬ï¼Œä¾›æç¤ºè¯ä½¿ç”¨ï¼‰
def format_docs(docs):
    """æ ¼å¼åŒ–æ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µï¼Œç”¨ç©ºè¡Œåˆ†éš”"""
    return "\n\n".join([doc.page_content for doc in docs])

# 2. è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼ˆ1.xæ¨èç”¨ChatPromptTemplateï¼Œé€šè¿‡from_messagesåˆ›å»ºï¼‰
# ä¿æŒåŸä¸šåŠ¡è§„åˆ™ï¼šåŸºäºå‚è€ƒèµ„æ–™ã€åˆ†ç‚¹è¯´æ˜ã€å¸¦æ¡ˆä¾‹
system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„RAGç³»ç»Ÿé—®ç­”åŠ©æ‰‹ï¼Œå¿…é¡»åŸºäºä»¥ä¸‹æä¾›çš„å‚è€ƒèµ„æ–™ï¼ˆcontextï¼‰å›ç­”ç”¨æˆ·é—®é¢˜ã€‚
è§„åˆ™ï¼š
1. ç­”æ¡ˆå¿…é¡»ä¸¥æ ¼åŸºäºå‚è€ƒèµ„æ–™ï¼Œä¸èƒ½ç¼–é€ æœªæåŠçš„ä¿¡æ¯ï¼›
2. è¯­è¨€ç®€æ´æ˜äº†ï¼Œåˆ†ç‚¹è¯´æ˜ï¼ˆå¦‚æœæœ‰å¤šä¸ªè¦ç‚¹ï¼‰ï¼›
3. æ¯ä¸ªè¦ç‚¹æ­é…1ä¸ªç®€å•æ¡ˆä¾‹ï¼Œå¸®åŠ©ç†è§£ã€‚

å‚è€ƒèµ„æ–™ï¼š{context}"""

custom_prompt = ChatPromptTemplate.from_messages([
    ("system", system_prompt),  # ç³»ç»ŸæŒ‡ä»¤
    ("human", "{question}")     # ç”¨æˆ·é—®é¢˜ï¼ˆ1.xæ¨èç”¨"question"é”®ï¼Œè¯­ä¹‰æ›´æ¸…æ™°ï¼‰
])

# 3. ç”¨LCELæ„å»ºå®Œæ•´æ£€ç´¢-ç”Ÿæˆé“¾ï¼ˆç®¡é“ç¬¦ä¸²è”ç»„ä»¶ï¼Œæ•°æ®æµå¼ä¼ é€’ï¼‰
rag_qa_chain = (
    # ç¬¬ä¸€æ­¥ï¼šå¹¶è¡Œå¤„ç†è¾“å…¥ï¼ˆä¼ é€’ç”¨æˆ·é—®é¢˜+æ£€ç´¢æ–‡æ¡£ï¼‰
    {"context": retriever | format_docs, "question": RunnablePassthrough()},
    # ç¬¬äºŒæ­¥ï¼šå°†æ ¼å¼åŒ–æ•°æ®ä¼ å…¥æç¤ºè¯æ¨¡æ¿
    custom_prompt,
    # ç¬¬ä¸‰æ­¥ï¼šä¼ å…¥å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆ
    llm,
    # ç¬¬å››æ­¥ï¼šè§£æè¾“å‡ºï¼ˆç»Ÿä¸€ä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼‰
    StrOutputParser()
)

# è¡¥å……ï¼šå¦‚éœ€è¿”å›æ£€ç´¢çš„æºæ–‡æ¡£ï¼ˆç”¨äºéªŒè¯ç­”æ¡ˆæ¥æºï¼‰ï¼Œå¯è°ƒæ•´é“¾ç»“æ„ï¼š
rag_qa_chain_with_sources = (
    {
        "context": retriever | format_docs,
        "question": RunnablePassthrough(),
        "source_documents": retriever  # ä¿ç•™åŸå§‹æ£€ç´¢æ–‡æ¡£
    }
    | custom_prompt
    | llm
    | StrOutputParser()
)
```

**ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•RAGç³»ç»Ÿå¹¶éªŒè¯ç»“æœ**

1.xç‰ˆæœ¬ç»Ÿä¸€ç”¨`invoke`æ–¹æ³•æ‰§è¡Œé“¾ï¼Œå‚æ•°ä¸ºå­—å…¸æ ¼å¼ï¼Œè·å–ç»“æœåå¯ç›´æ¥æ‰“å°ç­”æ¡ˆå’Œæºæ–‡æ¡£

```python
# æµ‹è¯•é—®é¢˜åˆ—è¡¨ï¼ˆè¦†ç›–ä¸åŒç±»å‹çš„æŸ¥è¯¢ï¼‰
test_questions = [
    "RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ",
    "RAGå’Œç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹ç›¸æ¯”ï¼Œä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ",
    "ä¼ä¸šå†…éƒ¨çŸ¥è¯†åº“é—®ç­”ä¸ºä»€ä¹ˆé€‚åˆç”¨RAGï¼Ÿ"
]

# æ‰§è¡Œæµ‹è¯•å¹¶æ‰“å°ç»“æœ
for i, question in enumerate(test_questions):
    print(f"\n===== æµ‹è¯•é—®é¢˜{i+1}ï¼š{question} =====")
    # æ‰§è¡ŒRAGé“¾ï¼ˆ1.xç»Ÿä¸€ç”¨invokeæ–¹æ³•ï¼‰
    result = rag_qa_chain_with_sources.invoke(question)  # å¸¦æºæ–‡æ¡£çš„é“¾
    
    # æ‰“å°ç”Ÿæˆçš„ç­”æ¡ˆ
    print("\nç”Ÿæˆç­”æ¡ˆï¼š")
    print(result)
    
    # æ‰“å°å‚è€ƒèµ„æ–™ï¼ˆéªŒè¯ç­”æ¡ˆæ¥æºï¼‰
    print("\nå‚è€ƒèµ„æ–™ï¼š")
    # æ³¨æ„ï¼šæºæ–‡æ¡£ä»é“¾çš„è¾“å…¥å‚æ•°ä¸­è·å–ï¼ˆå› é“¾ç»“æ„ä¸­ä¿ç•™äº†source_documentsï¼‰
    sources = retriever.invoke(question)  # é‡æ–°è°ƒç”¨æ£€ç´¢å™¨è·å–æºæ–‡æ¡£ï¼ˆæˆ–åœ¨é“¾ä¸­ä¼ é€’ï¼‰
    for j, doc in enumerate(sources):
        print(f"\nå‚è€ƒç‰‡æ®µ{j+1}ï¼š")
        print(doc.page_content)
        if doc.metadata:  # æ‰“å°æ–‡æ¡£å…ƒæ•°æ®ï¼ˆå¦‚æ–‡ä»¶åã€é¡µç ç­‰ï¼‰
            print(f"å…ƒæ•°æ®ï¼š{doc.metadata}")
```

**ç¬¬å››æ­¥ï¼šè¿è¡Œç»“æœä¸ç³»ç»ŸéªŒè¯**

#### ç¬¬äº”æ­¥ï¼šè¿è¡Œç»“æœä¸ç³»ç»ŸéªŒè¯

è¿è¡Œä»£ç åï¼Œå°†å¾—åˆ°æ¸…æ™°çš„ç­”æ¡ˆã€å‚è€ƒèµ„æ–™åŠå¯¹åº”å…³ç³»ã€‚æ ¸å¿ƒéªŒè¯ç‚¹ï¼š

- ç­”æ¡ˆä¸¥æ ¼åŸºäºæ£€ç´¢çš„å‚è€ƒèµ„æ–™ï¼Œæ— ç¼–é€ ä¿¡æ¯ï¼›
- ç­”æ¡ˆæŒ‰è¦æ±‚åˆ†ç‚¹è¯´æ˜ï¼Œæ¯ä¸ªè¦ç‚¹å¸¦æ¡ˆä¾‹ï¼›
- æºæ–‡æ¡£å¯æ­£å¸¸æ‰“å°ï¼Œèƒ½è¿½æº¯ç­”æ¡ˆæ¥æºã€‚

> å°æŠ€å·§ï¼šRetrievalQAçš„chain_typeé™¤äº†â€œstuffâ€ï¼Œè¿˜æœ‰â€œmap_reduceâ€â€œrefineâ€ç­‰ã€‚å¦‚æœæ£€ç´¢ç‰‡æ®µè¾ƒå¤šã€è¾ƒé•¿ï¼Œå»ºè®®ç”¨â€œmap_reduceâ€ï¼ˆå…ˆåˆ†åˆ«å¤„ç†æ¯ä¸ªç‰‡æ®µï¼Œå†æ±‡æ€»ç­”æ¡ˆï¼‰ï¼Œé¿å…æç¤ºè¯è¶…è¿‡å¤§æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ã€‚

### 4.4.6 RAGç³»ç»Ÿå¸¸è§é—®é¢˜ä¸ä¼˜åŒ–æ–¹å‘

æ­å»ºå®ŒåŸºç¡€RAGç³»ç»Ÿåï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šé‡åˆ°æ£€ç´¢ä¸å‡†ã€ç”Ÿæˆç­”æ¡ˆè´¨é‡ä½ç­‰é—®é¢˜ã€‚ä¸‹é¢æ€»ç»“å¸¸è§é—®é¢˜åŠå¯¹åº”çš„ä¼˜åŒ–æ–¹å‘ï¼Œå¸®åŠ©å¤§å®¶æå‡ç³»ç»Ÿæ€§èƒ½ã€‚

#### 4.4.6.1 å¸¸è§é—®é¢˜æ’æŸ¥

| å¸¸è§é—®é¢˜             | å¯èƒ½åŸå›                                                      | æ’æŸ¥ä¸è§£å†³æ–¹æ³•                                               |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| æ£€ç´¢ç»“æœä¸ç›¸å…³       | 1. æ–‡æœ¬åˆ†å‰²ä¸åˆç†ï¼ˆç‰‡æ®µè¿‡å¤§/è¿‡å°ï¼Œè¯­ä¹‰ä¸å®Œæ•´ï¼‰ï¼›2. åµŒå…¥æ¨¡å‹ä¸é€‚åˆä¸­æ–‡åœºæ™¯ï¼›3. æ£€ç´¢å‚æ•°è®¾ç½®ä¸å½“ï¼ˆkå€¼è¿‡å¤§ã€MMRå¤šæ ·æ€§è¿‡é«˜ï¼‰ | 1. è°ƒæ•´åˆ†å‰²å‚æ•°ï¼ˆchunk_size=200-500å­—ï¼Œç”¨RecursiveCharacterTextSplitterï¼‰ï¼›2. æ›¿æ¢ä¸ºä¸­æ–‡ä¼˜åŒ–çš„åµŒå…¥æ¨¡å‹ï¼ˆå¦‚é€šä¹‰åƒé—®embedding-v2ï¼‰ï¼›3. å‡å°kå€¼ï¼ˆk=2-3ï¼‰ï¼Œé™ä½MMRå¤šæ ·æ€§æƒé‡ï¼ˆlambda_mult=0.7-0.8ï¼‰ |
| ç”Ÿæˆç­”æ¡ˆé—æ¼å…³é”®ä¿¡æ¯ | 1. æ£€ç´¢ç‰‡æ®µæœªè¦†ç›–å…³é”®ä¿¡æ¯ï¼›2. æç¤ºè¯æœªæ˜ç¡®è¦æ±‚â€œå…¨é¢å›ç­”â€ï¼›3. å¤§æ¨¡å‹temperatureè¿‡ä½ï¼Œç”Ÿæˆè¿‡äºç®€æ´ | 1. å¢å¤§kå€¼ï¼ˆk=4-5ï¼‰ï¼Œæ”¹ç”¨ç›¸ä¼¼æ€§æ£€ç´¢ä¿è¯æ ¸å¿ƒä¿¡æ¯è¦†ç›–ï¼›2. ä¼˜åŒ–æç¤ºè¯ï¼Œæ·»åŠ â€œå…¨é¢è¦†ç›–å‚è€ƒèµ„æ–™ä¸­çš„æ‰€æœ‰å…³é”®è¦ç‚¹â€ï¼›3. é€‚å½“æé«˜temperatureï¼ˆ0.4-0.5ï¼‰ |
| ç”Ÿæˆç­”æ¡ˆåŒ…å«ç¼–é€ ä¿¡æ¯ | 1. æç¤ºè¯æœªä¸¥æ ¼é™åˆ¶â€œåŸºäºå‚è€ƒèµ„æ–™â€ï¼›2. æ£€ç´¢ç‰‡æ®µç›¸å…³æ€§ä½ï¼Œå¤§æ¨¡å‹æ— è¶³å¤Ÿä¿¡æ¯ç”Ÿæˆç­”æ¡ˆï¼›3. å¤§æ¨¡å‹temperatureè¿‡é«˜ | 1. ä¼˜åŒ–æç¤ºè¯ï¼Œæ˜ç¡®â€œç¦æ­¢ç¼–é€ ä¿¡æ¯ï¼Œæ— ç›¸å…³ä¿¡æ¯åˆ™å›å¤â€˜æ— æ³•å›ç­”â€™â€ï¼›2. æå‡æ£€ç´¢ç²¾åº¦ï¼ˆè°ƒæ•´åˆ†å‰²ã€åµŒå…¥æ¨¡å‹ã€æ£€ç´¢å‚æ•°ï¼‰ï¼›3. é™ä½temperatureï¼ˆ0.2-0.3ï¼‰ |
| ç³»ç»Ÿå“åº”é€Ÿåº¦æ…¢       | 1. æ£€ç´¢ç‰‡æ®µè¿‡å¤šï¼ˆkå€¼è¿‡å¤§ï¼‰ï¼›2. å‘é‡æ•°æ®åº“æœªä¼˜åŒ–ï¼ˆæœªæŒä¹…åŒ–ã€ç‰‡æ®µæ•°é‡è¿‡å¤šï¼‰ï¼›3. å¤§æ¨¡å‹æ¨ç†é€Ÿåº¦æ…¢ | 1. å‡å°kå€¼ï¼ˆk=2-3ï¼‰ï¼›2. ä¼˜åŒ–å‘é‡æ•°æ®åº“ï¼ˆå®šæœŸæ¸…ç†æ— æ•ˆç‰‡æ®µã€ä½¿ç”¨æ›´é«˜æ•ˆçš„å‘é‡æ•°æ®åº“å¦‚FAISSï¼‰ï¼›3. æ›¿æ¢ä¸ºè½»é‡å‹å¤§æ¨¡å‹ï¼ˆå¦‚GPT-3.5-turbo-instructæ›¿ä»£GPT-4ï¼‰ |

#### 4.4.6.2 è¿›é˜¶ä¼˜åŒ–æ–¹å‘

å¦‚æœåŸºç¡€RAGç³»ç»Ÿæ»¡è¶³ä¸äº†ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥ä»ä»¥ä¸‹3ä¸ªæ–¹å‘è¿›é˜¶ä¼˜åŒ–ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ï¼š

1. **æ£€ç´¢ä¼˜åŒ–**ï¼šå¼•å…¥â€œæ··åˆæ£€ç´¢â€ï¼ˆç›¸ä¼¼æ€§æ£€ç´¢+å…³é”®è¯æ£€ç´¢ï¼‰ï¼Œç»“åˆè¯­ä¹‰ç›¸å…³æ€§å’Œå…³é”®è¯åŒ¹é…ï¼Œæå‡æ£€ç´¢ç²¾åº¦ï¼›ä½¿ç”¨â€œæ£€ç´¢é‡æ’â€ï¼ˆå¦‚Cross-Encoderï¼‰ï¼Œå¯¹åˆæ­¥æ£€ç´¢ç»“æœé‡æ–°æ’åºï¼Œç­›é€‰å‡ºæœ€ç›¸å…³çš„ç‰‡æ®µã€‚
2. **æç¤ºè¯å·¥ç¨‹ä¼˜åŒ–**ï¼šé‡‡ç”¨â€œæ€ç»´é“¾ï¼ˆCoTï¼‰â€æç¤ºè¯ï¼Œå¼•å¯¼å¤§æ¨¡å‹é€æ­¥åˆ†æå‚è€ƒèµ„æ–™ã€ç”Ÿæˆç­”æ¡ˆï¼›é’ˆå¯¹ç‰¹å®šè¡Œä¸šï¼ˆå¦‚åŒ»ç–—ã€æ³•å¾‹ï¼‰å®šåˆ¶é¢†åŸŸä¸“å±æç¤ºè¯æ¨¡æ¿ï¼Œæå‡ç­”æ¡ˆä¸“ä¸šæ€§ã€‚
3. **çŸ¥è¯†åº“ä¼˜åŒ–**ï¼šå»ºç«‹çŸ¥è¯†åº“æ›´æ–°æœºåˆ¶ï¼ˆå®šæœŸæ·»åŠ æ–°æ–‡æ¡£ã€åˆ é™¤è¿‡æœŸæ–‡æ¡£ï¼‰ï¼›å¯¹æ–‡æ¡£è¿›è¡Œé¢„å¤„ç†ï¼ˆæ¸…æ´—å†—ä½™ä¿¡æ¯ã€æ ‡æ³¨æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼‰ï¼Œæå‡æ–‡æœ¬åˆ†å‰²å’ŒåµŒå…¥çš„æ•ˆæœã€‚

è¿™äº›è¿›é˜¶ä¼˜åŒ–æ–¹å‘åœ¨ä¼ä¸šçº§RAGåº”ç”¨ä¸­éå¸¸é‡è¦ï¼Œåç»­ç« èŠ‚ä¼šç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯æ·±å…¥è®²è§£ã€‚

## 4.6 RAG ç³»ç»Ÿçš„è¯„ä¼°ä¸è°ƒä¼˜æ–¹æ³•ï¼ˆé€‰å­¦ï¼‰

> ä»¥ä¸‹éƒ¨åˆ†å†…å®¹ï¼Œæ›´åŠ çš„ä¸“ä¸šåŒ–ï¼Œå·¥ç¨‹åŒ–ï¼Œé€‚åˆåœ¨èŒæˆ–æœ‰å·¥ä½œç»éªŒçš„åŒå­¦å­¦ä¹ ã€‚

æ­å»ºå®ŒRAGç³»ç»Ÿå¹¶ä¸æ„å‘³ç€ç»“æŸï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦é€šè¿‡ç§‘å­¦çš„è¯„ä¼°å‘ç°é—®é¢˜ï¼Œå†é’ˆå¯¹æ€§è°ƒä¼˜ï¼Œæ‰èƒ½è®©ç³»ç»Ÿç¨³å®šè¾“å‡ºé«˜è´¨é‡ç»“æœã€‚

æœ¬èŠ‚å°†ä»æ ¸å¿ƒè¯„ä¼°æŒ‡æ ‡ã€è¯„ä¼°æ–¹æ³•ã€è°ƒä¼˜æ–¹å‘å’Œå·¥ç¨‹åŒ–å®è·µå››ä¸ªç»´åº¦ï¼Œå®Œæ•´è¦†ç›–RAGç³»ç»Ÿâ€œè¯„ä¼°-è°ƒä¼˜â€çš„é—­ç¯æµç¨‹ã€‚

### 4.6.1 è¯„ä¼°æ ¸å¿ƒæŒ‡æ ‡ï¼šç›¸å…³æ€§ã€å‡†ç¡®æ€§ã€å“åº”é€Ÿåº¦

è¯„ä¼°RAGç³»ç»Ÿçš„æ•ˆæœï¼Œæ ¸å¿ƒå›´ç»•â€œèƒ½å¦ç²¾å‡†æ‰¾åˆ°æœ‰ç”¨ä¿¡æ¯â€â€œç­”æ¡ˆæ˜¯å¦æ­£ç¡®å¯ç”¨â€â€œç”¨æˆ·ç­‰å¾…æ—¶é—´æ˜¯å¦å¯æ¥å—â€ä¸‰ä¸ªæ ¸å¿ƒè¯‰æ±‚ï¼Œå¯¹åº”ä¸‰ä¸ªå…³é”®æŒ‡æ ‡ï¼šç›¸å…³æ€§ã€å‡†ç¡®æ€§ã€å“åº”é€Ÿåº¦ã€‚æ¯ä¸ªæŒ‡æ ‡éƒ½æœ‰æ˜ç¡®çš„å®šä¹‰å’Œå¯é‡åŒ–çš„è¡¡é‡æ ‡å‡†ã€‚

| æŒ‡æ ‡åç§°                      | æ ¸å¿ƒå®šä¹‰                                                   | è¡¡é‡æ ‡å‡†ä¸è®¡ç®—æ–¹å¼                                           | ä¼˜åŒ–ç›®æ ‡                                             |
| ----------------------------- | ---------------------------------------------------------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| ç›¸å…³æ€§ï¼ˆRetrieval Relevanceï¼‰ | æ£€ç´¢å™¨è¿”å›çš„æ–‡æœ¬ç‰‡æ®µä¸ç”¨æˆ·é—®é¢˜çš„è¯­ä¹‰å…³è”ç¨‹åº¦               | 1. ç²¾ç¡®ç‡ï¼ˆPrecisionï¼‰ï¼šæ£€ç´¢åˆ°çš„ç›¸å…³ç‰‡æ®µæ•° / æ£€ç´¢åˆ°çš„æ€»ç‰‡æ®µæ•°ï¼› 2. å¬å›ç‡ï¼ˆRecallï¼‰ï¼šæ£€ç´¢åˆ°çš„ç›¸å…³ç‰‡æ®µæ•° / çŸ¥è¯†åº“ä¸­æ‰€æœ‰ç›¸å…³ç‰‡æ®µæ•°ï¼› 3. F1åˆ†æ•°ï¼š2Ã—(ç²¾ç¡®ç‡Ã—å¬å›ç‡)/(ç²¾ç¡®ç‡+å¬å›ç‡)ï¼ˆç»¼åˆç²¾ç¡®ç‡å’Œå¬å›ç‡ï¼‰ | F1åˆ†æ•°â‰¥0.8ï¼Œç¡®ä¿æ£€ç´¢ç»“æœâ€œæ—¢å‡†åˆå…¨â€                   |
| å‡†ç¡®æ€§ï¼ˆGeneration Accuracyï¼‰ | å¤§æ¨¡å‹ç”Ÿæˆçš„ç­”æ¡ˆä¸å‚è€ƒèµ„æ–™ï¼ˆæ£€ç´¢ç‰‡æ®µï¼‰çš„ä¸€è‡´æ€§ã€äº‹å®æ­£ç¡®æ€§ | 1. äº‹å®ä¸€è‡´æ€§ï¼ˆFactualityï¼‰ï¼šäººå·¥æˆ–è‡ªåŠ¨åŒ–å·¥å…·åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦ç¬¦åˆæ£€ç´¢ç‰‡æ®µä¸­çš„äº‹å®ï¼› 2. ä¿¡æ¯å®Œæ•´æ€§ï¼ˆCompletenessï¼‰ï¼šç­”æ¡ˆæ˜¯å¦è¦†ç›–ç”¨æˆ·é—®é¢˜æ‰€éœ€çš„æ‰€æœ‰æ ¸å¿ƒä¿¡æ¯ï¼› 3. é”™è¯¯ç‡ï¼šåŒ…å«ç¼–é€ ä¿¡æ¯ã€é”™è¯¯å…³è”çš„ç­”æ¡ˆå æ¯” | äº‹å®ä¸€è‡´æ€§â‰¥95%ï¼Œé”™è¯¯ç‡â‰¤5%ï¼Œæ ¸å¿ƒä¿¡æ¯è¦†ç›–ç‡â‰¥90%        |
| å“åº”é€Ÿåº¦ï¼ˆResponse Speedï¼‰    | ç”¨æˆ·å‘èµ·æé—®åˆ°è·å–æœ€ç»ˆç­”æ¡ˆçš„æ€»è€—æ—¶ï¼Œå«æ£€ç´¢è€—æ—¶å’Œç”Ÿæˆè€—æ—¶   | 1. æ£€ç´¢è€—æ—¶ï¼šä»æ¥æ”¶é—®é¢˜åˆ°è·å–ç›¸å…³ç‰‡æ®µçš„æ—¶é—´ï¼› 2. ç”Ÿæˆè€—æ—¶ï¼šä»ä¼ å…¥æ£€ç´¢ç‰‡æ®µåˆ°ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆçš„æ—¶é—´ï¼› 3. æ€»è€—æ—¶=æ£€ç´¢è€—æ—¶+ç”Ÿæˆè€—æ—¶ | æ€»è€—æ—¶â‰¤2ç§’ï¼ˆæ™®é€šé—®ç­”åœºæ™¯ï¼‰ï¼Œâ‰¤5ç§’ï¼ˆå¤æ‚æ–‡æ¡£é—®ç­”åœºæ™¯ï¼‰ |

> å°æç¤ºï¼šä¸‰ä¸ªæŒ‡æ ‡å­˜åœ¨ä¸€å®šæƒè¡¡å…³ç³»ã€‚æ¯”å¦‚å¢å¤§æ£€ç´¢ç‰‡æ®µæ•°é‡ï¼ˆkå€¼ï¼‰å¯èƒ½æå‡å¬å›ç‡ï¼Œä½†ä¼šå¢åŠ å“åº”é€Ÿåº¦ï¼›æé«˜å¤§æ¨¡å‹temperatureå¯èƒ½æå‡ç­”æ¡ˆä¸°å¯Œåº¦ï¼Œä½†å¯èƒ½é™ä½å‡†ç¡®æ€§ã€‚å®é™…ä¼˜åŒ–éœ€ç»“åˆä¸šåŠ¡åœºæ™¯ä¼˜å…ˆçº§è°ƒæ•´ã€‚

### 4.6.2 è¯„ä¼°æ–¹æ³•ï¼šäººå·¥è¯„ä¼°ä¸è‡ªåŠ¨åŒ–è¯„ä¼°å·¥å…·

æ ¹æ®è¯„ä¼°æˆæœ¬å’Œæ•ˆç‡ï¼ŒRAGç³»ç»Ÿçš„è¯„ä¼°æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼šäººå·¥è¯„ä¼°ï¼ˆç²¾å‡†ä½†ä½æ•ˆï¼Œé€‚åˆå°è§„æ¨¡éªŒè¯ï¼‰å’Œè‡ªåŠ¨åŒ–è¯„ä¼°ï¼ˆé«˜æ•ˆä½†éœ€æ ¡å‡†ï¼Œé€‚åˆå¤§è§„æ¨¡è¿­ä»£ï¼‰ã€‚

å®é™…é¡¹ç›®ä¸­é€šå¸¸ç»“åˆä½¿ç”¨ï¼Œå…ˆé€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·å¿«é€Ÿç­›é€‰é—®é¢˜ï¼Œå†ç”¨äººå·¥è¯„ä¼°ç²¾å‡†éªŒè¯æ ¸å¿ƒåœºæ™¯ã€‚

#### 4.6.2.1 äººå·¥è¯„ä¼°ï¼šç²¾å‡†éªŒè¯æ ¸å¿ƒåœºæ™¯

äººå·¥è¯„ä¼°é€‚åˆå¯¹æ ¸å¿ƒä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚é«˜ä»·å€¼å®¢æˆ·å’¨è¯¢ã€å…³é”®æ”¿ç­–é—®ç­”ï¼‰çš„æ•ˆæœéªŒè¯ï¼Œéœ€è¦åˆ¶å®šæ¸…æ™°çš„è¯„ä¼°æ ‡å‡†å’Œæµç¨‹ï¼Œé¿å…ä¸»è§‚åå·®ã€‚

**1. è¯„ä¼°æµç¨‹**

1. æ„å»ºæµ‹è¯•é›†ï¼šé€‰å–100-200ä¸ªè¦†ç›–æ ¸å¿ƒåœºæ™¯çš„ç”¨æˆ·é—®é¢˜ï¼ˆå«ç®€å•é—®é¢˜ã€å¤æ‚é—®é¢˜ã€è¾¹ç¼˜é—®é¢˜ï¼‰ï¼Œå¹¶æ ‡æ³¨æ¯ä¸ªé—®é¢˜åœ¨çŸ¥è¯†åº“ä¸­å¯¹åº”çš„æ­£ç¡®å‚è€ƒç‰‡æ®µï¼›
2. ç³»ç»Ÿè¾“å‡ºé‡‡é›†ï¼šå°†æµ‹è¯•é›†é—®é¢˜è¾“å…¥RAGç³»ç»Ÿï¼Œè®°å½•æ¯ä¸ªé—®é¢˜çš„æ£€ç´¢ç‰‡æ®µã€ç”Ÿæˆç­”æ¡ˆã€å“åº”è€—æ—¶ï¼›
3. äººå·¥æ‰“åˆ†ï¼šç”±2-3åè¯„ä¼°è€…æŒ‰ç…§é¢„è®¾æ ‡å‡†å¯¹æ¯ä¸ªæŒ‡æ ‡æ‰“åˆ†ï¼Œæ‰“åˆ†ç»“æœå–å¹³å‡å€¼ï¼ˆå‡å°‘ä¸»è§‚åå·®ï¼‰ï¼›
4. ç»“æœåˆ†æï¼šç»Ÿè®¡å„æŒ‡æ ‡å¾—åˆ†ï¼Œå®šä½è–„å¼±ç¯èŠ‚ï¼ˆå¦‚æŸç±»é—®é¢˜æ£€ç´¢ç›¸å…³æ€§ä½ã€æŸç±»ç­”æ¡ˆå‡†ç¡®æ€§å·®ï¼‰ã€‚

**2. æ‰“åˆ†æ ‡å‡†ç¤ºä¾‹ï¼ˆä»¥å‡†ç¡®æ€§ä¸ºä¾‹ï¼‰**

| åˆ†æ•°ç­‰çº§ | æ ‡å‡†æè¿°                                                     |
| -------- | ------------------------------------------------------------ |
| 5åˆ†      | ç­”æ¡ˆå®Œå…¨ç¬¦åˆæ£€ç´¢ç‰‡æ®µäº‹å®ï¼Œæ ¸å¿ƒä¿¡æ¯å®Œæ•´ï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ— ä»»ä½•ç¼–é€ å†…å®¹ |
| 3åˆ†      | ç­”æ¡ˆåŸºæœ¬ç¬¦åˆäº‹å®ï¼Œä½†é—æ¼1-2ä¸ªéå…³é”®ä¿¡æ¯ï¼Œæˆ–è¡¨è¿°å­˜åœ¨è½»å¾®æ­§ä¹‰  |
| 1åˆ†      | ç­”æ¡ˆå­˜åœ¨äº‹å®é”™è¯¯ï¼Œæˆ–ç¼–é€ æ£€ç´¢ç‰‡æ®µä¸­æœªæåŠçš„ä¿¡æ¯ï¼Œæ— æ³•æ»¡è¶³ç”¨æˆ·éœ€æ±‚ |

#### 4.6.2.2 è‡ªåŠ¨åŒ–è¯„ä¼°å·¥å…·ï¼šé«˜æ•ˆè¿­ä»£ä¼˜åŒ–

å¯¹äºå¤§è§„æ¨¡è¿­ä»£ï¼ˆå¦‚æ¯æ—¥ä¼˜åŒ–åçš„æ•ˆæœéªŒè¯ï¼‰ï¼Œäººå·¥è¯„ä¼°æˆæœ¬è¿‡é«˜ï¼Œéœ€å€ŸåŠ©è‡ªåŠ¨åŒ–å·¥å…·å¿«é€Ÿè¯„ä¼°ã€‚å¸¸ç”¨çš„è‡ªåŠ¨åŒ–è¯„ä¼°å·¥å…·åˆ†ä¸ºä¸¤ç±»ï¼šLangChainåŸç”Ÿå·¥å…·å’Œç¬¬ä¸‰æ–¹ä¸“ç”¨å·¥å…·ï¼ˆå¦‚RAGASã€LLM-as-a-Judgeï¼‰ã€‚

**1. LangChainåŸç”Ÿè¯„ä¼°å·¥å…·**

LangChain 1.xæä¾›äº†æ£€ç´¢è¯„ä¼°ä¸“ç”¨çš„`RetrievalEvaluator`ï¼ˆè¿ç§»è‡³`langchain.evaluation.retrieval`å­æ¨¡å—ï¼‰å’Œç­”æ¡ˆè¯„ä¼°ä¸“ç”¨çš„`QAEvalChain`ï¼Œå¯ç›´æ¥è¯„ä¼°æ£€ç´¢ç›¸å…³æ€§å’Œç­”æ¡ˆå‡†ç¡®æ€§ï¼Œæ— éœ€é¢å¤–å¼€å‘ã€‚

```python
# 1. è¯„ä¼°æ£€ç´¢ç›¸å…³æ€§ï¼ˆç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°ï¼‰
from langchain.evaluation.retrieval import RetrievalEvaluator  # 1.x æ­£ç¡®å¯¼å…¥è·¯å¾„
from langchain_community.vectorstores import FAISS  # æ›¿æ¢ï¼šå¯¼å…¥FAISSï¼ˆåŸChromaï¼‰
from langchain_community.embeddings import HuggingFaceEmbeddings
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
if not api_key:
    raise ValueError("æœªæ‰¾åˆ°OPENAI_API_KEYç¯å¢ƒå˜é‡")

# åˆå§‹åŒ–Qwen3æœ¬åœ°åµŒå…¥æ¨¡å‹
embedding_model_path = "./models/Qwen/Qwen3-Embedding-0___6B"
# éªŒè¯æ¨¡å‹è·¯å¾„æœ‰æ•ˆæ€§
if not os.path.exists(embedding_model_path):
    raise FileNotFoundError(f"Qwen3åµŒå…¥æ¨¡å‹è·¯å¾„ä¸å­˜åœ¨ï¼š{embedding_model_path}")

embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_path,
    model_kwargs={
        "device": "cpu",  # å¼ºåˆ¶CPUè¿è¡Œï¼Œæ— éœ€GPU
        "trust_remote_code": True,  # Qwen3æ¨¡å‹å¿…é€‰é…ç½®ï¼Œä¿¡ä»»è¿œç¨‹ä»£ç 
        # å¦‚éœ€åŠ è½½é‡åŒ–æ¨¡å‹ï¼Œå¯å¯ç”¨ä»¥ä¸‹é…ç½®ï¼ˆé™ä½å†…å­˜å ç”¨ï¼‰
        # "load_in_8bit": True,
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢ç›¸ä¼¼åº¦è®¡ç®—ç²¾åº¦
    }
)

# åˆå§‹åŒ–å‘é‡æ•°æ®åº“å’Œæ£€ç´¢å™¨ï¼ˆæ›¿æ¢ï¼šChromaâ†’FAISSï¼Œé€‚é…FAISSæœ¬åœ°åŠ è½½æ–¹å¼ï¼‰
faiss_db_path = "./faiss_db"  # FAISSæ•°æ®åº“å­˜å‚¨è·¯å¾„
if not os.path.exists(faiss_db_path):
    raise FileNotFoundError(f"FAISSå‘é‡æ•°æ®åº“è·¯å¾„ä¸å­˜åœ¨ï¼š{faiss_db_path}")

vector_db = FAISS.load_local(
    folder_path=faiss_db_path,
    embeddings=embeddings,
    allow_dangerous_deserialization=True  # æœ¬åœ°å¼€å‘å…è®¸åŠ è½½ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…
)
retriever = vector_db.as_retriever(search_kwargs={"k": 3})

# è¾…åŠ©å‡½æ•°ï¼šFAISSé€šè¿‡document_idè·å–æ ‡æ³¨æ–‡æ¡£ï¼ˆFAISSæ— ç›´æ¥getæ–¹æ³•ï¼Œéœ€è‡ªå®šä¹‰ï¼‰
def get_doc_by_id(vector_db, doc_id):
    for doc in vector_db.docstore._dict.values():
        if doc.metadata.get("document_id") == doc_id:
            return doc
    raise ValueError(f"æœªæ‰¾åˆ°document_idä¸º{doc_id}çš„æ–‡æ¡£")

# å®šä¹‰æµ‹è¯•é›†ï¼ˆå…³é”®ä¿®æ­£ï¼šrelevant_documentséœ€ä¸ºäººå·¥æ ‡æ³¨çš„æ­£ç¡®æ–‡æ¡£ï¼Œè€ŒéåŠ¨æ€æ£€ç´¢ï¼‰
# æ³¨æ„ï¼šéœ€æå‰ä¸ºFAISSä¸­çš„æ–‡æ¡£æ·»åŠ document_idå…ƒæ•°æ®ï¼Œç¡®ä¿è¯„ä¼°çœŸå®æ€§
test_cases = [
    {
        "query": "RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ",
        # ç¤ºä¾‹ï¼šäººå·¥ä»FAISSå‘é‡åº“ä¸­ç­›é€‰çš„2ç¯‡æ­£ç¡®ç›¸å…³æ–‡æ¡£ï¼ˆçœŸå®åœºæ™¯éœ€æ‰‹åŠ¨æ ‡æ³¨ï¼‰
        "relevant_documents": [
            get_doc_by_id(vector_db, "doc1"),  # é€šè¿‡è‡ªå®šä¹‰å‡½æ•°è·å–æ ‡æ³¨æ–‡æ¡£
            get_doc_by_id(vector_db, "doc2")
        ]
    },
    {
        "query": "LangChainçš„SequentialChainæœ‰ä»€ä¹ˆç”¨ï¼Ÿ",
        "relevant_documents": [
            get_doc_by_id(vector_db, "doc3")
        ]
    }
]

# åˆå§‹åŒ–æ£€ç´¢è¯„ä¼°å™¨ï¼ˆ1.x ç”¨æ³•ä¸å˜ï¼ŒæŒ‡æ ‡æ”¯æŒå®Œæ•´ï¼‰
retrieval_evaluator = RetrievalEvaluator(
    metric_names=["precision", "recall", "f1"],  # è¦è¯„ä¼°çš„æŒ‡æ ‡
    retriever=retriever
)

# æ‰§è¡Œè¯„ä¼°
results = retrieval_evaluator.evaluate_batch(
    [case["query"] for case in test_cases],
    [case["relevant_documents"] for case in test_cases]
)

# æ‰“å°ç»“æœ
for i, result in enumerate(results):
    print(f"\næµ‹è¯•ç”¨ä¾‹{i+1}ï¼ˆé—®é¢˜ï¼š{test_cases[i]['query']}ï¼‰")
    print(f"ç²¾ç¡®ç‡ï¼š{round(result['precision'], 4)}")
    print(f"å¬å›ç‡ï¼š{round(result['recall'], 4)}")
    print(f"F1åˆ†æ•°ï¼š{round(result['f1'], 4)}")

# 2. è¯„ä¼°ç­”æ¡ˆå‡†ç¡®æ€§ï¼ˆäº‹å®ä¸€è‡´æ€§ã€å®Œæ•´æ€§ï¼‰
from langchain.evaluation import QAEvalChain
from langchain_openai import ChatOpenAI  # 1.x æ¨èç”¨ChatOpenAIï¼ˆæ›¿ä»£æ—§ç‰ˆOpenAIï¼‰

# åˆå§‹åŒ–å¤§æ¨¡å‹ï¼ˆ1.x æ¨èé…ç½®ï¼šæ·»åŠ è¶…æ—¶ã€é‡è¯•ï¼Œæå‡ç¨³å®šæ€§ï¼‰
llm = ChatOpenAI(
    api_key=api_key,
    temperature=0,  # 0æ¸©åº¦ä¿è¯è¯„ä¼°æ ‡å‡†ç»Ÿä¸€
    timeout=30,
    max_retries=2
)
eval_chain = QAEvalChain.from_llm(llm=llm)

# å®šä¹‰æµ‹è¯•é›†ï¼ˆé—®é¢˜-æ­£ç¡®ç­”æ¡ˆ-ç³»ç»Ÿç­”æ¡ˆï¼‰
test_data = [
    {
        "question": "RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ",
        "answer": "RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼åŒ…æ‹¬æå‡å‡†ç¡®æ€§ã€æ‹“å±•çŸ¥è¯†è¾¹ç•Œã€é™ä½å¾®è°ƒæˆæœ¬ã€‚æå‡å‡†ç¡®æ€§æŒ‡ç­”æ¡ˆåŸºäºçœŸå®å‚è€ƒèµ„æ–™ï¼Œå‡å°‘äº‹å®é”™è¯¯ï¼›æ‹“å±•çŸ¥è¯†è¾¹ç•ŒæŒ‡å¤§æ¨¡å‹å¯è·å–è®­ç»ƒæ•°æ®å¤–çš„æœ€æ–°ä¿¡æ¯å’Œç§æœ‰ä¿¡æ¯ï¼›é™ä½æˆæœ¬æŒ‡æ›´æ–°çŸ¥è¯†æ— éœ€å¾®è°ƒå¤§æ¨¡å‹ï¼Œä»…éœ€æ›´æ–°çŸ¥è¯†åº“ã€‚",
        "prediction": "RAGçš„æ ¸å¿ƒä»·å€¼æ˜¯æå‡ç­”æ¡ˆå‡†ç¡®æ€§ã€æ‹“å±•çŸ¥è¯†èŒƒå›´ã€é™ä½ä¼ä¸šä½¿ç”¨å¤§æ¨¡å‹çš„æˆæœ¬ã€‚å‡†ç¡®æ€§æ–¹é¢ï¼Œä¾æ‰˜å¤–éƒ¨çŸ¥è¯†åº“ä¿éšœäº‹å®æ­£ç¡®ï¼›çŸ¥è¯†èŒƒå›´å¯è¦†ç›–æœ€æ–°è¡Œä¸šæ•°æ®å’Œå†…éƒ¨æ–‡æ¡£ï¼›æˆæœ¬ä¸Šé¿å…äº†æ˜‚è´µçš„å¤§æ¨¡å‹å¾®è°ƒã€‚"
    },
    {
        "question": "SequentialChainçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ",
        "answer": "SequentialChainç”¨äºä¸²è”å¤šä¸ªLLMChainï¼Œæ”¯æŒå¤šè¾“å…¥å¤šè¾“å‡ºï¼Œå¯æŒ‡å®šæ•´ä¸ªæµç¨‹çš„è¾“å…¥å˜é‡å’Œè¾“å‡ºå˜é‡ï¼Œèƒ½ç»“åˆå¤šä¸ªç»´åº¦çš„ä¿¡æ¯å®Œæˆå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ã€‚",
        "prediction": "SequentialChainå¯ä»¥æŠŠå¤šä¸ªé“¾æŒ‰é¡ºåºè¿æ¥èµ·æ¥ï¼Œæ”¯æŒå¤šä¸ªè¾“å…¥å’Œè¾“å‡ºï¼Œé€‚åˆå¤„ç†éœ€è¦å¤šæ­¥éª¤çš„ä»»åŠ¡ï¼Œæ¯”å¦‚å…ˆæå–äº§å“å–ç‚¹å†å†™è¥é”€è¯æœ¯ã€‚"
    }
]

# æ‰§è¡Œè¯„ä¼°
eval_results = eval_chain.evaluate(
    test_data,
    prediction_key="prediction",  # ç³»ç»Ÿç­”æ¡ˆçš„é”®å
    question_key="question",      # é—®é¢˜çš„é”®å
    answer_key="answer"           # æ­£ç¡®ç­”æ¡ˆçš„é”®å
)

# æ‰“å°è¯„ä¼°ç»“æœ
for i, result in enumerate(eval_results):
    print(f"\næµ‹è¯•ç”¨ä¾‹{i+1}è¯„ä¼°ç»“æœï¼š")
    print(f"äº‹å®ä¸€è‡´æ€§è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ï¼š{result['correctness']}")
    print(f"è¯„ä¼°è¯´æ˜ï¼š{result['reasoning']}")
```

**2. ç¬¬ä¸‰æ–¹ä¸“ç”¨å·¥å…·ï¼šRAGASï¼ˆRAGä¸“ç”¨è¯„ä¼°æ¡†æ¶ï¼‰**

RAGASæ˜¯ä¸“é—¨é’ˆå¯¹RAGç³»ç»Ÿçš„è¯„ä¼°æ¡†æ¶ï¼Œæ”¯æŒè¯„ä¼°ç›¸å…³æ€§ã€å‡†ç¡®æ€§ã€å®Œæ•´æ€§ç­‰æ ¸å¿ƒæŒ‡æ ‡ï¼Œä¸”æ— éœ€æ ‡æ³¨æ­£ç¡®ç­”æ¡ˆï¼ˆä»…éœ€é—®é¢˜ã€æ£€ç´¢ç‰‡æ®µã€ç³»ç»Ÿç­”æ¡ˆï¼‰ï¼Œä½¿ç”¨æ›´ä¾¿æ·

```python
# å®‰è£…ä¾èµ–ï¼špip install ragas datasets faiss-cpu  # è¡¥å……ï¼šå®‰è£…FAISSä¾èµ–
from ragas import evaluate
from ragas.metrics import (
    RetrievalPrecision,  # æ£€ç´¢ç²¾ç¡®ç‡
    RetrievalRecall,     # æ£€ç´¢å¬å›ç‡
    Faithfulness,        # äº‹å®ä¸€è‡´æ€§
    AnswerCompleteness   # ç­”æ¡ˆå®Œæ•´æ€§
)
from datasets import Dataset
from langchain_community.vectorstores import FAISS  # æ›¿æ¢ï¼šå¯¼å…¥FAISSï¼ˆåŸChromaï¼‰
from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
if not api_key:
    raise ValueError("æœªæ‰¾åˆ°OPENAI_API_KEYç¯å¢ƒå˜é‡")

# 1. åˆå§‹åŒ–RAGç³»ç»Ÿç»„ä»¶ï¼ˆ1.x å®˜æ–¹æ¨èLCELé“¾å¼å†™æ³•ï¼Œæ›¿ä»£æ—§ç‰ˆRetrievalQAï¼‰
# åˆå§‹åŒ–Qwen3æœ¬åœ°åµŒå…¥æ¨¡å‹
embedding_model_path = "./models/Qwen/Qwen3-Embedding-0___6B"
# éªŒè¯æ¨¡å‹è·¯å¾„æœ‰æ•ˆæ€§
if not os.path.exists(embedding_model_path):
    raise FileNotFoundError(f"Qwen3åµŒå…¥æ¨¡å‹è·¯å¾„ä¸å­˜åœ¨ï¼š{embedding_model_path}")

embeddings = HuggingFaceEmbeddings(
    model_name=embedding_model_path,
    model_kwargs={
        "device": "cpu",  # å¼ºåˆ¶CPUè¿è¡Œï¼Œæ— éœ€GPU
        "trust_remote_code": True,  # Qwen3æ¨¡å‹å¿…é€‰é…ç½®ï¼Œä¿¡ä»»è¿œç¨‹ä»£ç 
        # å¦‚éœ€åŠ è½½é‡åŒ–æ¨¡å‹ï¼Œå¯å¯ç”¨ä»¥ä¸‹é…ç½®ï¼ˆé™ä½å†…å­˜å ç”¨ï¼‰
        # "load_in_8bit": True,
    },
    encode_kwargs={
        "normalize_embeddings": True  # å½’ä¸€åŒ–å‘é‡ï¼Œæå‡æ£€ç´¢ç›¸ä¼¼åº¦è®¡ç®—ç²¾åº¦
    }
)

# åˆå§‹åŒ–FAISSå‘é‡æ•°æ®åº“ï¼ˆæ›¿æ¢ï¼šChromaâ†’FAISSï¼‰
faiss_db_path = "./faiss_db"
if not os.path.exists(faiss_db_path):
    raise FileNotFoundError(f"FAISSå‘é‡æ•°æ®åº“è·¯å¾„ä¸å­˜åœ¨ï¼š{faiss_db_path}")

vector_db = FAISS.load_local(
    folder_path=faiss_db_path,
    embeddings=embeddings,
    allow_dangerous_deserialization=True  # æœ¬åœ°å¼€å‘å…è®¸åŠ è½½ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…
)
retriever = vector_db.as_retriever(search_kwargs={"k": 3})

# å®šä¹‰æç¤ºè¯æ¨¡æ¿
system_prompt = "åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š{context}"
prompt = ChatPromptTemplate.from_messages([
    ("system", system_prompt),
    ("human", "{question}")
])

# å®šä¹‰æ–‡æ¡£æ ¼å¼åŒ–å‡½æ•°
def format_docs(docs):
    return "\n\n".join([doc.page_content for doc in docs])

# æ„å»ºLCELé£æ ¼çš„RAGé“¾
rag_qa_chain = (
    {"context": retriever | format_docs, "question": RunnablePassthrough()},
    prompt,
    ChatOpenAI(api_key=api_key, temperature=0.3),
    StrOutputParser()
)

# 2. æ„å»ºæµ‹è¯•æ•°æ®é›†ï¼ˆä»…éœ€é—®é¢˜ï¼‰
test_questions = [
    "RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ",
    "SequentialChainçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ",
    "RAGç³»ç»Ÿçš„æ„å»ºæµç¨‹æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ"
]

# 3. é‡‡é›†ç³»ç»Ÿè¾“å‡ºï¼ˆæ£€ç´¢ç‰‡æ®µã€ç”Ÿæˆç­”æ¡ˆï¼‰
test_data = []
for question in test_questions:
    # è·å–ç”Ÿæˆç­”æ¡ˆï¼ˆ1.x ç»Ÿä¸€ç”¨invokeæ–¹æ³•æ‰§è¡Œé“¾ï¼‰
    answer = rag_qa_chain.invoke(question)
    # è·å–æ£€ç´¢ç‰‡æ®µï¼ˆ1.x ç”¨invokeæ›¿ä»£get_relevant_documentsï¼ŒFAISSå®Œå…¨å…¼å®¹ï¼‰
    retrieved_docs = retriever.invoke(question)
    contexts = [doc.page_content for doc in retrieved_docs]
    
    test_data.append({
        "question": question,
        "answer": answer,
        "contexts": contexts
    })

# 4. è½¬æ¢ä¸ºRAGASæ”¯æŒçš„Datasetæ ¼å¼
dataset = Dataset.from_list(test_data)

# 5. å®šä¹‰è¦è¯„ä¼°çš„æŒ‡æ ‡
metrics = [RetrievalPrecision(), RetrievalRecall(), Faithfulness(), AnswerCompleteness()]

# 6. æ‰§è¡Œè¯„ä¼°ï¼ˆå…³é”®ä¿®æ­£ï¼šæœ€æ–°ç‰ˆRAGASé€šè¿‡llmå‚æ•°æŒ‡å®šå¤§æ¨¡å‹ï¼Œæ— éœ€ç›´æ¥ä¼ api_keyï¼‰
results = evaluate(
    dataset=dataset,
    metrics=metrics,
    llm=ChatOpenAI(api_key=api_key, temperature=0)  # ä¼ å…¥LangChain LLMå®ä¾‹
)

# 7. æ‰“å°è¯„ä¼°ç»“æœï¼ˆè½¬æ¢ä¸ºDataFrameæ›´æ˜“è¯»ï¼‰
print("RAGç³»ç»Ÿè‡ªåŠ¨åŒ–è¯„ä¼°ç»“æœï¼š")
print(results.to_pandas())
```

è¿è¡Œç»“æœç¤ºä¾‹ï¼š

```text
RAGç³»ç»Ÿè‡ªåŠ¨åŒ–è¯„ä¼°ç»“æœï¼š
   question  retrieval_precision  retrieval_recall  faithfulness  answer_completeness
0  RAGç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ               0.85              0.82         0.96                  0.88
1  SequentialChainçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ               0.90              0.88         0.98                  0.92
2  RAGç³»ç»Ÿçš„æ„å»ºæµç¨‹æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ               0.82              0.79         0.95                  0.85
```

>  è¸©å‘æŒ‡å—ï¼šè‡ªåŠ¨åŒ–è¯„ä¼°å·¥å…·çš„ç»“æœéœ€äººå·¥æ ¡å‡†ã€‚æ¯”å¦‚RAGASçš„äº‹å®ä¸€è‡´æ€§è¯„åˆ†å¯èƒ½å­˜åœ¨åå·®ï¼Œå¯¹äºæ ¸å¿ƒåœºæ™¯çš„è¯„ä¼°ç»“æœï¼Œå»ºè®®æŠ½å–10%-20%çš„æ ·æœ¬è¿›è¡Œäººå·¥å¤æ ¸ï¼Œç¡®ä¿è¯„ä¼°å‡†ç¡®æ€§ã€‚

### 4.6.3 è°ƒä¼˜æ–¹å‘ï¼šåˆ†å‰²ç­–ç•¥ã€å‘é‡æ¨¡å‹ã€æ£€ç´¢å‚æ•°ä¼˜åŒ–

æ ¹æ®è¯„ä¼°ç»“æœå®šä½é—®é¢˜åï¼Œéœ€é’ˆå¯¹æ€§è°ƒä¼˜ã€‚RAGç³»ç»Ÿçš„è°ƒä¼˜æ ¸å¿ƒå›´ç»•â€œæ£€ç´¢ç¯èŠ‚â€ï¼ˆæ£€ç´¢æ˜¯ç”Ÿæˆçš„åŸºç¡€ï¼Œæ£€ç´¢ä¸å‡†åˆ™ç”Ÿæˆå¿…é”™ï¼‰ï¼Œä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ–¹å‘ï¼šæ–‡æœ¬åˆ†å‰²ç­–ç•¥ã€å‘é‡æ¨¡å‹é€‰æ‹©ã€æ£€ç´¢å‚æ•°é…ç½®ã€‚

#### 4.6.3.1 æ–‡æœ¬åˆ†å‰²ç­–ç•¥ä¼˜åŒ–

æ–‡æœ¬åˆ†å‰²æ˜¯RAGçš„â€œåŸºç¡€å·¥ç¨‹â€ï¼Œåˆ†å‰²ä¸åˆç†ä¼šç›´æ¥å¯¼è‡´æ£€ç´¢ç›¸å…³æ€§ä½ã€‚ä¼˜åŒ–éœ€ç»“åˆæ–‡æ¡£ç±»å‹å’Œé—®é¢˜åœºæ™¯è°ƒæ•´ï¼Œæ ¸å¿ƒæ˜¯ä¿è¯ç‰‡æ®µçš„â€œè¯­ä¹‰å®Œæ•´æ€§â€å’Œâ€œå¤§å°é€‚ä¸­â€ã€‚

| å¸¸è§é—®é¢˜                                  | ä¼˜åŒ–æ–¹æ¡ˆ                          | å®æ“å»ºè®®                                                     |
| ----------------------------------------- | --------------------------------- | ------------------------------------------------------------ |
| ç‰‡æ®µè¿‡å¤§ï¼ˆè¶…è¿‡500å­—ï¼‰ï¼Œæ£€ç´¢æ—¶æ— å…³ä¿¡æ¯è¿‡å¤š | å‡å°chunk_sizeï¼Œä¼˜åŒ–åˆ†å‰²ç¬¦ä¼˜å…ˆçº§  | ä¸­æ–‡æ–‡æ¡£ï¼šchunk_size=200-300å­—ï¼Œåˆ†å‰²ç¬¦é¡ºåºï¼š\n\nâ†’\nâ†’ã€‚â†’ï¼Œï¼›è‹±æ–‡æ–‡æ¡£ï¼šchunk_size=200-300tokenï¼Œåˆ†å‰²ç¬¦é¡ºåºï¼š\n\nâ†’\nâ†’.â†’,â†’ |
| ç‰‡æ®µè¿‡å°ï¼ˆå°äº100å­—ï¼‰ï¼Œä¸¢å¤±ä¸Šä¸‹æ–‡ä¿¡æ¯     | å¢å¤§chunk_sizeï¼Œå¢åŠ chunk_overlap | chunk_sizeè°ƒæ•´ä¸º300-400å­—ï¼Œchunk_overlap=50-80å­—ï¼Œé¿å…è·¨ç‰‡æ®µçš„çŸ¥è¯†ç‚¹è¢«åˆ‡æ–­ |
| ç»“æ„åŒ–æ–‡æ¡£ï¼ˆå¦‚MDã€PDFï¼‰åˆ†å‰²åç ´åå±‚çº§å…³ç³» | ä½¿ç”¨é’ˆå¯¹æ€§åˆ†å‰²å™¨ï¼Œä¿ç•™å±‚çº§ä¿¡æ¯    | MDæ–‡æ¡£ç”¨MarkdownTextSplitterï¼ŒPDFæ–‡æ¡£ç”¨PyPDFLoaderæŒ‰é¡µåˆ†å‰²åå†äºŒæ¬¡ç»†åˆ†ï¼ˆæŒ‰æ®µè½ï¼‰ |

#### 4.6.3.2 å‘é‡æ¨¡å‹é€‰æ‹©ä¸ä¼˜åŒ–

å‘é‡æ¨¡å‹çš„è´¨é‡ç›´æ¥å†³å®šæ–‡æœ¬åµŒå…¥çš„è¯­ä¹‰è¡¨å¾èƒ½åŠ›ï¼Œè¿›è€Œå½±å“æ£€ç´¢ç›¸å…³æ€§ã€‚ä¼˜åŒ–éœ€ç»“åˆè¯­è¨€ç±»å‹ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰ã€ä¸šåŠ¡åœºæ™¯ï¼ˆé€šç”¨/ä¸“ä¸šé¢†åŸŸï¼‰é€‰æ‹©åˆé€‚çš„æ¨¡å‹ï¼Œå¿…è¦æ—¶è¿›è¡Œæ¨¡å‹å¾®è°ƒã€‚

| æ¨¡å‹ç±»å‹     | ä»£è¡¨æ¨¡å‹                                                 | ä¼˜åŠ¿                                           | é€‚ç”¨åœºæ™¯                                         |
| ------------ | -------------------------------------------------------- | ---------------------------------------------- | ------------------------------------------------ |
| é€šç”¨è‹±æ–‡æ¨¡å‹ | text-embedding-ada-002ï¼ˆOpenAIï¼‰                         | è¯­ä¹‰è¡¨å¾èƒ½åŠ›å¼ºï¼Œå…¼å®¹æ€§å¥½ï¼Œæ”¯æŒé•¿æ–‡æœ¬           | è‹±æ–‡é€šç”¨æ–‡æ¡£é—®ç­”ï¼ˆå¦‚å›½é™…æ–°é—»ã€è‹±æ–‡æŠ€æœ¯æ–‡æ¡£ï¼‰     |
| é€šç”¨ä¸­æ–‡æ¨¡å‹ | text-embedding-v2ï¼ˆé€šä¹‰åƒé—®ï¼‰ã€m3e-baseï¼ˆå¼€æºï¼‰          | é’ˆå¯¹ä¸­æ–‡è¯­ä¹‰ä¼˜åŒ–ï¼Œæ€§ä»·æ¯”é«˜ï¼Œéƒ¨åˆ†å¼€æºå¯æœ¬åœ°éƒ¨ç½² | ä¸­æ–‡é€šç”¨åœºæ™¯ï¼ˆå¦‚ä¼ä¸šå†…éƒ¨ä¸­æ–‡æ‰‹å†Œã€ä¸­æ–‡å®¢æœé—®ç­”ï¼‰ |
| ä¸“ä¸šé¢†åŸŸæ¨¡å‹ | åŒ»ç–—é¢†åŸŸï¼šMedBERT-Embeddingï¼›æ³•å¾‹é¢†åŸŸï¼šLawBERT-Embedding | å¯¹ä¸“ä¸šæœ¯è¯­çš„è¯­ä¹‰ç†è§£æ›´ç²¾å‡†                     | åŒ»ç–—ã€æ³•å¾‹ã€é‡‘èç­‰ä¸“ä¸šé¢†åŸŸçš„æ–‡æ¡£é—®ç­”             |

> å®æ“æŠ€å·§ï¼šå¦‚æœé€šç”¨æ¨¡å‹æ•ˆæœä¸ä½³ï¼Œå¯å°è¯•â€œæ¨¡å‹å¯¹æ¯”æµ‹è¯•â€â€”â€”ç”¨å¤šä¸ªæ¨¡å‹å¯¹åŒä¸€æ‰¹æµ‹è¯•æ•°æ®è¿›è¡ŒåµŒå…¥å’Œæ£€ç´¢ï¼Œé€šè¿‡F1åˆ†æ•°å¯¹æ¯”é€‰æ‹©æœ€ä¼˜æ¨¡å‹ã€‚

#### 4.6.3.3 æ£€ç´¢å‚æ•°é…ç½®ä¼˜åŒ–

æ£€ç´¢å‚æ•°çš„è°ƒæ•´ç›´æ¥å½±å“æ£€ç´¢ç»“æœçš„â€œç›¸å…³æ€§â€å’Œâ€œå¤šæ ·æ€§â€ï¼Œéœ€ç»“åˆè¯„ä¼°æŒ‡æ ‡ï¼ˆç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°ï¼‰åŠ¨æ€è°ƒæ•´ï¼Œæ ¸å¿ƒå‚æ•°åŒ…æ‹¬kå€¼ã€æ£€ç´¢ç±»å‹ã€MMRç›¸å…³å‚æ•°ã€‚

| å‚æ•°ç±»å‹ | æ ¸å¿ƒå‚æ•°                                   | è°ƒæ•´é€»è¾‘                                                   | å®æ“å»ºè®®                                                   |
| -------- | ------------------------------------------ | ---------------------------------------------------------- | ---------------------------------------------------------- |
| åŸºç¡€å‚æ•° | kï¼ˆè¿”å›ç‰‡æ®µæ•°é‡ï¼‰                          | ç²¾ç¡®ç‡ä½â†’å‡å°kå€¼ï¼›å¬å›ç‡ä½â†’å¢å¤§kå€¼                         | é€šç”¨åœºæ™¯k=3-4ï¼›å¤æ‚é—®é¢˜k=4-5ï¼›ç®€å•é—®é¢˜k=2-3                |
| æ£€ç´¢ç±»å‹ | similarityï¼ˆç›¸ä¼¼æ€§ï¼‰/mmrï¼ˆæœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼‰ | éœ€ç²¾å‡†æ ¸å¿ƒä¿¡æ¯â†’similarityï¼›éœ€å…¨é¢å¤šæ ·åŒ–ä¿¡æ¯â†’mmr            | ç®€å•é—®ç­”ç”¨similarityï¼›å¤æ‚å¯¹æ¯”ã€å¤šç»´åº¦åˆ†æç”¨mmr            |
| MMRå‚æ•°  | lambda_multï¼ˆç›¸å…³æ€§-å¤šæ ·æ€§æƒé‡ï¼‰           | éœ€ä¼˜å…ˆç›¸å…³æ€§â†’å¢å¤§lambda_multï¼›éœ€ä¼˜å…ˆå¤šæ ·æ€§â†’å‡å°lambda_mult | é€šç”¨åœºæ™¯lambda_mult=0.7-0.8ï¼›å¤šæ ·åŒ–éœ€æ±‚lambda_mult=0.4-0.5 |

### 4.6.4 å·¥ç¨‹åŒ–è°ƒä¼˜å®è·µæ€»ç»“

åœ¨ä¼ä¸šçº§RAGé¡¹ç›®ä¸­ï¼Œè°ƒä¼˜ä¸æ˜¯â€œä¸€æ¬¡æ€§æ“ä½œâ€ï¼Œè€Œæ˜¯â€œè¯„ä¼°-è°ƒä¼˜-éªŒè¯â€çš„å¾ªç¯è¿‡ç¨‹ã€‚ç»“åˆå®é™…é¡¹ç›®ç»éªŒï¼Œæ€»ç»“å‡ºä»¥ä¸‹å·¥ç¨‹åŒ–è°ƒä¼˜æµç¨‹ï¼Œç¡®ä¿è°ƒä¼˜æ•ˆæœç¨³å®šã€å¯å¤ç°ã€‚

1. **é—®é¢˜å®šä½é˜¶æ®µ**ï¼šé€šè¿‡è‡ªåŠ¨åŒ–è¯„ä¼°å·¥å…·å¿«é€Ÿæ‰«æå…¨é‡æµ‹è¯•æ•°æ®ï¼Œç»Ÿè®¡å„æŒ‡æ ‡çš„è–„å¼±ç¯èŠ‚ï¼ˆå¦‚â€œåŒ»ç–—æœ¯è¯­ç›¸å…³é—®é¢˜æ£€ç´¢ç›¸å…³æ€§ä½â€â€œé•¿æ–‡æ¡£é—®ç­”å‡†ç¡®æ€§å·®â€ï¼‰ï¼›å¯¹è–„å¼±ç¯èŠ‚çš„æ ·æœ¬è¿›è¡Œäººå·¥åˆ†æï¼Œæ˜ç¡®æ ¹å› ï¼ˆå¦‚â€œåˆ†å‰²ç‰‡æ®µè¿‡å°å¯¼è‡´åŒ»ç–—æœ¯è¯­ä¸Šä¸‹æ–‡ä¸¢å¤±â€â€œå‘é‡æ¨¡å‹å¯¹ä¸“ä¸šæœ¯è¯­è¡¨å¾ä¸è¶³â€ï¼‰ã€‚
2. **é’ˆå¯¹æ€§è°ƒä¼˜é˜¶æ®µ**ï¼šæ ¹æ®æ ¹å› é€‰æ‹©è°ƒä¼˜æ–¹å‘ï¼Œåˆ¶å®šè°ƒä¼˜æ–¹æ¡ˆå¹¶æ‰§è¡Œã€‚ä¾‹å¦‚ï¼šæ ¹å› ä¸ºâ€œä¸“ä¸šæœ¯è¯­è¡¨å¾ä¸è¶³â€ï¼Œè°ƒä¼˜æ–¹æ¡ˆä¸ºâ€œæ›¿æ¢ä¸ºåŒ»ç–—é¢†åŸŸä¸“ç”¨åµŒå…¥æ¨¡å‹â€ï¼›æ ¹å› ä¸ºâ€œç‰‡æ®µè¿‡å°â€ï¼Œè°ƒä¼˜æ–¹æ¡ˆä¸ºâ€œè°ƒæ•´chunk_sizeä»200å­—åˆ°350å­—ï¼Œchunk_overlapä»50å­—åˆ°80å­—â€ã€‚
3. **æ•ˆæœéªŒè¯é˜¶æ®µ**ï¼šå°†è°ƒä¼˜åçš„ç³»ç»Ÿé‡æ–°è¿è¡Œæµ‹è¯•é›†ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·è¯„ä¼°æŒ‡æ ‡å˜åŒ–ï¼›æŠ½å–æ ¸å¿ƒåœºæ™¯æ ·æœ¬è¿›è¡Œäººå·¥å¤æ ¸ï¼Œç¡®ä¿è°ƒä¼˜åæ— æ–°é—®é¢˜ï¼ˆå¦‚â€œè°ƒæ•´kå€¼åå“åº”é€Ÿåº¦æ˜¯å¦è¾¾æ ‡â€â€œæ›¿æ¢æ¨¡å‹åå…¶ä»–åœºæ™¯ç›¸å…³æ€§æ˜¯å¦ä¸‹é™â€ï¼‰ã€‚
4. **è¿­ä»£ä¼˜åŒ–é˜¶æ®µ**ï¼šå°†è°ƒä¼˜æ–¹æ¡ˆå›ºåŒ–åˆ°ç³»ç»Ÿé…ç½®ä¸­ï¼Œè®°å½•è°ƒä¼˜å‰åçš„æŒ‡æ ‡å˜åŒ–ï¼ˆå½¢æˆè°ƒä¼˜æ—¥å¿—ï¼‰ï¼›å®šæœŸï¼ˆå¦‚æ¯æœˆï¼‰æ›´æ–°æµ‹è¯•é›†ï¼ˆåŠ å…¥æ–°åœºæ™¯é—®é¢˜ï¼‰ï¼Œé‡æ–°è¯„ä¼°å¹¶è°ƒä¼˜ï¼Œç¡®ä¿ç³»ç»Ÿé€‚é…ä¸šåŠ¡éœ€æ±‚çš„å˜åŒ–ã€‚

å·¥ç¨‹åŒ–æŠ€å·§ï¼šå»ºç«‹â€œè°ƒä¼˜é…ç½®ä¸­å¿ƒâ€ï¼Œå°†åˆ†å‰²å‚æ•°ã€å‘é‡æ¨¡å‹ã€æ£€ç´¢å‚æ•°ç­‰é…ç½®é¡¹é›†ä¸­ç®¡ç†ï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢é…ç½®å¹¶å¯¹æ¯”æ•ˆæœï¼Œé¿å…ç¡¬ç¼–ç å¯¼è‡´çš„è°ƒä¼˜æ•ˆç‡ä½ä¸‹ã€‚

## 4.7 æœ¬ç« å°ç»“

æœ¬ç« å›´ç»•LangChainçš„æ ¸å¿ƒåº”ç”¨â€”â€”é“¾å¼å·¥ä½œæµå’ŒRAGç³»ç»Ÿï¼Œä»åŸç†ã€å®æ“ã€è¯„ä¼°è°ƒä¼˜ä¸‰ä¸ªç»´åº¦å±•å¼€ï¼Œè¦†ç›–äº†ä»â€œç®€å•é“¾â€åˆ°â€œä¼ä¸šçº§RAGç³»ç»Ÿâ€çš„å…¨é“¾è·¯çŸ¥è¯†ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒçŸ¥è¯†ç‚¹å’ŒæŠ€æœ¯è½åœ°è¦ç‚¹çš„æ€»ç»“ï¼Œå¸®åŠ©å¤§å®¶æ¢³ç†è„‰ç»œã€å·©å›ºé‡ç‚¹ã€‚

**1. é“¾å¼å·¥ä½œæµï¼šè®©å¤§æ¨¡å‹æŒ‰æ­¥éª¤è§£å†³å¤æ‚é—®é¢˜**

- æ ¸å¿ƒä»·å€¼ï¼šå°†å¤æ‚ä»»åŠ¡æ‹†è§£ä¸ºå¤šä¸ªç®€å•å­ä»»åŠ¡ï¼Œé€šè¿‡ä¸²è”æˆ–åŠ¨æ€åˆ†å‘çš„æ–¹å¼ï¼Œè®©å¤§æ¨¡å‹é€æ­¥å®Œæˆï¼Œæå‡ä»»åŠ¡å¤„ç†çš„ç²¾å‡†åº¦å’Œå¯æ§æ€§ã€‚
- ä¸‰ç§æ ¸å¿ƒé“¾ç±»å‹ï¼š  - SimpleSequentialChainï¼šå•è¾“å…¥å•è¾“å‡ºï¼Œçº¿æ€§ä¸²è”å¤šä¸ªé“¾ï¼Œé€‚åˆç®€å•çš„å¤šæ­¥éª¤ä»»åŠ¡ï¼ˆå¦‚â€œæ–‡æœ¬æ‘˜è¦â†’å…³é”®è¯æå–â€ï¼‰ï¼›  - SequentialChainï¼šå¤šè¾“å…¥å¤šè¾“å‡ºï¼Œæ”¯æŒæŒ‡å®šè¾“å…¥è¾“å‡ºå˜é‡ï¼Œé€‚åˆéœ€è¦ç»“åˆå¤šä¸ªç»´åº¦ä¿¡æ¯çš„ä»»åŠ¡ï¼ˆå¦‚â€œæå–äº§å“å–ç‚¹â†’é’ˆå¯¹ç‰¹å®šäººç¾¤å†™è¥é”€è¯æœ¯â€ï¼‰ï¼›  - RouterChainï¼šåŠ¨æ€ä»»åŠ¡åˆ†å‘ï¼Œé€šè¿‡è·¯ç”±é€‰æ‹©å™¨åˆ¤æ–­ç”¨æˆ·éœ€æ±‚ï¼Œåˆ†å‘åˆ°å¯¹åº”çš„ç›®æ ‡é“¾ï¼Œé€‚åˆå¤šåœºæ™¯å®¢æœã€å¤šä»»åŠ¡å¤„ç†ç³»ç»Ÿã€‚
- å¼‚å¸¸å¤„ç†ï¼šé€šè¿‡é‡è¯•æœºåˆ¶ï¼ˆRetryWithErrorOutputChainï¼‰ã€å¼‚å¸¸æ•è·ï¼ˆtry-exceptï¼‰ã€åˆ†æ”¯é™çº§ï¼ˆæ ¸å¿ƒé“¾å¤±è´¥åˆ‡æ¢å¤‡ç”¨é“¾ï¼‰æå‡ç³»ç»Ÿç¨³å¥æ€§ã€‚

**2. RAG ç³»ç»Ÿï¼šè§£å†³å¤§æ¨¡å‹çŸ¥è¯†æ»åä¸äº‹å®æ€§é”™è¯¯**

- æ ¸å¿ƒé€»è¾‘ï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œé€šè¿‡â€œæ–‡æ¡£åŠ è½½â†’æ–‡æœ¬åˆ†å‰²â†’å‘é‡å­˜å‚¨â†’æ£€ç´¢â†’ç”Ÿæˆâ€çš„æµç¨‹ï¼Œè®©å¤§æ¨¡å‹åŸºäºå¤–éƒ¨çŸ¥è¯†åº“çš„çœŸå®ä¿¡æ¯ç”Ÿæˆç­”æ¡ˆï¼Œé¿å…èƒ¡ç¼–ä¹±é€ ã€‚
- å…¨æµç¨‹å…³é”®ç¯èŠ‚ï¼š  - æ–‡æ¡£åŠ è½½ï¼šé€‚é…PDFã€Wordã€MDã€TXTç­‰å¤šæ ¼å¼æ–‡æ¡£ï¼Œè½¬æ¢ä¸ºLangChainç»Ÿä¸€çš„Documentå¯¹è±¡ï¼›  - æ–‡æœ¬åˆ†å‰²ï¼šç”¨RecursiveCharacterTextSplitterç­‰å·¥å…·ï¼Œä¿è¯ç‰‡æ®µè¯­ä¹‰å®Œæ•´ã€å¤§å°é€‚ä¸­ï¼›  - å‘é‡å­˜å‚¨ï¼šé€šè¿‡åµŒå…¥æ¨¡å‹å°†æ–‡æœ¬ç‰‡æ®µè½¬ä¸ºå‘é‡ï¼Œå­˜å‚¨åˆ°Chromaç­‰å‘é‡æ•°æ®åº“ï¼Œå®ç°å¿«é€Ÿç›¸ä¼¼æ€§æ£€ç´¢ï¼›  - æ£€ç´¢ä¼˜åŒ–ï¼šç»“åˆç›¸ä¼¼æ€§æ£€ç´¢å’ŒMMRæ£€ç´¢ï¼Œå¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§ï¼›  - æ£€ç´¢-ç”Ÿæˆæ•´åˆï¼šç”¨RetrievalQAé“¾æ•´åˆæ£€ç´¢å™¨å’Œå¤§æ¨¡å‹ï¼Œæ”¯æŒè‡ªå®šä¹‰æç¤ºè¯ï¼Œå®ç°ç«¯åˆ°ç«¯é—®ç­”ã€‚

## 4.8 æœ¬ç« ç»ƒä¹ 

é€šè¿‡åˆ†å±‚ç»ƒä¹ å·©å›ºæœ¬ç« æ ¸å¿ƒçŸ¥è¯†ï¼Œä»åŸºç¡€çš„é“¾å¼å·¥ä½œæµå®ç°ï¼Œåˆ°è¿›é˜¶çš„RAGç³»ç»Ÿæ„å»ºä¸è°ƒä¼˜ï¼Œå†åˆ°æ‹“å±•çš„å·¥ç¨‹åŒ–èƒ½åŠ›æå‡ï¼Œé€æ­¥æå‡å¤§æ¨¡å‹åº”ç”¨å¼€å‘å®æˆ˜èƒ½åŠ›ã€‚

### 1.åŸºç¡€ç»ƒä¹ ï¼šåŸºäº SequentialChain å®ç°å¤šæ­¥éª¤æ–‡æœ¬å¤„ç†ä»»åŠ¡

**ç»ƒä¹ ä»»åŠ¡**

å®ç°â€œæ–°é—»æ–‡æœ¬åˆ†ç±»â†’æå–æ ¸å¿ƒäº‹ä»¶â†’ç”Ÿæˆæ‘˜è¦â€çš„å¤šæ­¥éª¤ä»»åŠ¡ï¼š

1. è¾“å…¥ï¼šæ–°é—»æ–‡æœ¬ï¼ˆnews_textï¼‰ã€åˆ†ç±»æ ‡ç­¾åˆ—è¡¨ï¼ˆcategory_listï¼Œå¦‚[â€œç§‘æŠ€â€, â€œè´¢ç»â€, â€œå¨±ä¹â€, â€œä½“è‚²â€]ï¼‰ï¼›
2. æ­¥éª¤1ï¼ˆé“¾1ï¼‰ï¼šæ ¹æ®åˆ†ç±»æ ‡ç­¾åˆ—è¡¨ï¼Œå¯¹æ–°é—»æ–‡æœ¬è¿›è¡Œåˆ†ç±»ï¼Œè¾“å‡ºåˆ†ç±»ç»“æœï¼ˆcategoryï¼‰ï¼›
3. æ­¥éª¤2ï¼ˆé“¾2ï¼‰ï¼šæ ¹æ®åˆ†ç±»ç»“æœå’Œæ–°é—»æ–‡æœ¬ï¼Œæå–è¯¥ç±»æ–°é—»çš„æ ¸å¿ƒäº‹ä»¶ï¼ˆå¦‚ç§‘æŠ€æ–°é—»æå–â€œæŠ€æœ¯çªç ´ã€äº§å“å‘å¸ƒâ€ç­‰ï¼Œè´¢ç»æ–°é—»æå–â€œæ”¿ç­–å˜åŒ–ã€ä¼ä¸šåŠ¨æ€â€ç­‰ï¼‰ï¼Œè¾“å‡ºæ ¸å¿ƒäº‹ä»¶ï¼ˆcore_eventï¼‰ï¼›
4. æ­¥éª¤3ï¼ˆé“¾3ï¼‰ï¼šç»“åˆåˆ†ç±»ç»“æœå’Œæ ¸å¿ƒäº‹ä»¶ï¼Œç”Ÿæˆ100å­—ä»¥å†…çš„æ–°é—»æ‘˜è¦ï¼ˆsummaryï¼‰ï¼›
5. è¾“å‡ºï¼šåˆ†ç±»ç»“æœã€æ ¸å¿ƒäº‹ä»¶ã€æ–°é—»æ‘˜è¦ã€‚

### 2. è¿›é˜¶ç»ƒä¹ ï¼šæ„å»ºæ”¯æŒ PDF æ–‡æ¡£çš„ RAG é—®ç­”æœºå™¨äººå¹¶å®Œæˆè°ƒä¼˜

**ç»ƒä¹ ä»»åŠ¡**

1. æ–‡æ¡£åŠ è½½ï¼šåŠ è½½1-2ä»½PDFæ–‡æ¡£ï¼ˆå¦‚ä¼ä¸šäº§å“æ‰‹å†Œã€è¡Œä¸šæŠ¥å‘Šï¼‰ï¼Œè½¬æ¢ä¸ºDocumentå¯¹è±¡ï¼›
2. æ–‡æœ¬åˆ†å‰²ï¼šä½¿ç”¨RecursiveCharacterTextSplitterå¯¹æ–‡æ¡£è¿›è¡Œåˆ†å‰²ï¼Œè°ƒè¯•chunk_sizeå’Œchunk_overlapå‚æ•°ï¼›
3. å‘é‡å­˜å‚¨ï¼šé€‰æ‹©åˆé€‚çš„åµŒå…¥æ¨¡å‹ï¼ˆå¦‚é€šä¹‰åƒé—®text-embedding-v2ï¼‰ï¼Œå°†åˆ†å‰²åçš„ç‰‡æ®µå­˜å…¥Chromaå‘é‡æ•°æ®åº“ï¼›
4. æ£€ç´¢-ç”Ÿæˆæ•´åˆï¼šæ„å»ºRetrievalQAé“¾ï¼Œè‡ªå®šä¹‰æç¤ºè¯ï¼ˆè¦æ±‚ç­”æ¡ˆåŸºäºæ£€ç´¢ç‰‡æ®µï¼Œåˆ†ç‚¹æ¸…æ™°ï¼‰ï¼›
5. è¯„ä¼°ä¸è°ƒä¼˜ï¼š  - æ„å»º10ä¸ªæµ‹è¯•é—®é¢˜ï¼ˆè¦†ç›–PDFæ–‡æ¡£çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼‰ï¼›  - ç”¨RAGASå·¥å…·è¯„ä¼°æ£€ç´¢ç²¾ç¡®ç‡ã€äº‹å®ä¸€è‡´æ€§ç­‰æŒ‡æ ‡ï¼›  - æ ¹æ®è¯„ä¼°ç»“æœè°ƒä¼˜ï¼ˆå¦‚è°ƒæ•´åˆ†å‰²å‚æ•°ã€æ£€ç´¢kå€¼ã€åµŒå…¥æ¨¡å‹ï¼‰ï¼Œä½¿æ ¸å¿ƒæŒ‡æ ‡è¾¾æ ‡ï¼ˆF1â‰¥0.8ï¼Œäº‹å®ä¸€è‡´æ€§â‰¥0.9ï¼‰ã€‚

### 3. æ‹“å±•ç»ƒä¹ ï¼šä¸º RAG ç³»ç»Ÿæ·»åŠ é”™è¯¯å¤„ç†ä¸åˆ†æ”¯é™çº§æœºåˆ¶

**ç»ƒä¹ ä»»åŠ¡**

æå‡RAGç³»ç»Ÿçš„å·¥ç¨‹åŒ–èƒ½åŠ›ï¼Œé€šè¿‡é”™è¯¯å¤„ç†å’Œåˆ†æ”¯é™çº§æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹ä»èƒ½æ­£å¸¸å“åº”ã€‚

### ç»ƒä¹ ä»»åŠ¡

1. æ·»åŠ é‡è¯•æœºåˆ¶ï¼šä¸ºRAGç³»ç»Ÿçš„æ£€ç´¢ç¯èŠ‚å’Œç”Ÿæˆç¯èŠ‚æ·»åŠ é‡è¯•é€»è¾‘ï¼Œå½“APIè°ƒç”¨è¶…æ—¶æˆ–ä¸´æ—¶å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨é‡è¯•2-3æ¬¡ï¼›
2. æ·»åŠ å¼‚å¸¸æ•è·ï¼šæ•è·APIå¯†é’¥é”™è¯¯ã€è¾“å…¥æ ¼å¼é”™è¯¯ã€æ£€ç´¢æ— ç»“æœç­‰å¸¸è§å¼‚å¸¸ï¼Œè¿”å›å‹å¥½çš„é”™è¯¯æç¤ºï¼›
3. æ·»åŠ åˆ†æ”¯é™çº§ï¼š  - æ ¸å¿ƒé“¾ï¼šä½¿ç”¨GPT-4ä½œä¸ºå¤§æ¨¡å‹ï¼Œé€šä¹‰åƒé—®text-embedding-v2ä½œä¸ºåµŒå…¥æ¨¡å‹ï¼›  - é™çº§é“¾ï¼šå½“æ ¸å¿ƒé“¾å¤±è´¥ï¼ˆå¦‚APIè°ƒç”¨å¤±è´¥ã€æŒ‡æ ‡ä¸è¾¾æ ‡ï¼‰æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºGPT-3.5-turbo-instructï¼ˆå¤§æ¨¡å‹ï¼‰å’Œm3e-baseï¼ˆå¼€æºåµŒå…¥æ¨¡å‹ï¼‰ï¼›
4. æµ‹è¯•éªŒè¯ï¼šæ¨¡æ‹Ÿå¤šç§å¼‚å¸¸åœºæ™¯ï¼ˆå¦‚é”™è¯¯APIå¯†é’¥ã€ç½‘ç»œä¸­æ–­ã€æ£€ç´¢æ— ç»“æœï¼‰ï¼ŒéªŒè¯ç³»ç»Ÿæ˜¯å¦èƒ½æ­£å¸¸é™çº§å¹¶è¿”å›æœ‰æ•ˆå“åº”ã€‚